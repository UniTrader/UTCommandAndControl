<?xml version="1.0" encoding="UTF-8" ?>
<mdscript name="UT_CAC_Defense" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/md.xsd">

  <cues>
    <cue name="Settings" instantiate="true">
      <conditions>
        <check_any>
          <event_conversation_next_section sectionprefix="comm_defense_settings_"/>
          <event_conversation_returned_to_section sectionprefix="comm_defense_settings_"/>
        </check_any>
      </conditions>
      <actions>
        <do_if value="event.param == 'comm_defense_settings_main'">
          <do_if value="$actor.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
            <do_if value="event.name == 'event_conversation_next_section'">
              <add_npc_line speaker="player.entity" line="[1400,1401,1402].random" hidechoices="false" comment="lets talk about this in detail" />
              <add_npc_line speaker="$actor" line="[4110,4111].random" hidechoices="false" comment="Here you go." />
            </do_if>
            <do_elseif value="event.name == 'event_conversation_returned_to_section'">
              <do_if value="event.param2 == 'no change'">
                <add_npc_line speaker="player.entity" line="[1220,1410,1612,1713,1714].random" hidechoices="false" comment="No, I changed my mind.|Never mind that, do what you want.|Never mind that, do what you want.|Never mind that.|Well, maybe some other time." />
              </do_if>
              <add_npc_line speaker="$actor" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
            </do_elseif>
          </do_if>
          <add_player_choice_sub text="{5554103,252}.[readtext.{5554103}.{2521+$actor.$ut_cac.$defensemode}]" position="2" section="comm_defense_settings_behavior" comment="Change how Aggresively Enemies will be dealt with"/>
          <add_player_choice_return text="{5554103,7}" position="6" />
          <add_player_choice_return text="{5554103,7}" position="close" />
        </do_if>
        <do_elseif value="event.param == 'comm_defense_settings_behavior'">
          <add_player_choice text="{5554103,2521}" position="1" section="comm_defense_settings_behavior_incative" immediate="$actor.$ut_cac.$defensemode == 1"/>
          <add_player_choice text="{5554103,2522}" position="2" section="comm_defense_settings_behavior_missile_defense" immediate="$actor.$ut_cac.$defensemode == 2"/>
          <add_player_choice text="{5554103,2523}" position="3" section="comm_defense_settings_behavior_defensive" immediate="$actor.$ut_cac.$defensemode == 3"/>
          <add_player_choice text="{5554103,2524}" position="4" section="comm_defense_settings_behavior_defense_aggressive" immediate="$actor.$ut_cac.$defensemode == 4"/>
          <add_player_choice text="{5554103,2525}" position="5" section="comm_defense_settings_behavior_aggressive" immediate="$actor.$ut_cac.$defensemode == 5"/>
          <add_player_choice_return text="{5554103,7}" position="6" />
          <add_player_choice_return text="{5554103,7}" position="close" />
        </do_elseif>
        <do_elseif value="event.param == 'comm_defense_settings_behavior_aggressive'">
          <set_value name="$actor.$ut_cac.$defensemode" exact="4"/>
          <do_if value="$actor.$config_attackenemies?" comment="Vanilla Integration - might be removed at some point">
            <set_value name="$actor.$config_attackenemies" exact="1"/>
          </do_if>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_defense_settings_behavior_defense_aggressive'">
          <set_value name="$actor.$ut_cac.$defensemode" exact="3"/>
          <do_if value="$actor.$config_attackenemies?" comment="Vanilla Integration - might be removed at some point">
            <set_value name="$actor.$config_attackenemies" exact="1"/>
          </do_if>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_defense_settings_behavior_defensive'">
          <set_value name="$actor.$ut_cac.$defensemode" exact="2"/>
          <do_if value="$actor.$config_attackenemies?" comment="Vanilla Integration - might be removed at some point">
            <set_value name="$actor.$config_attackenemies" exact="0"/>
          </do_if>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_defense_settings_behavior_missile_defense'">
          <set_value name="$actor.$ut_cac.$defensemode" exact="1"/>
          <do_if value="$actor.$config_attackenemies?" comment="Vanilla Integration - might be removed at some point">
            <set_value name="$actor.$config_attackenemies" exact="0"/>
          </do_if>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_defense_settings_behavior_incative'">
          <set_value name="$actor.$ut_cac.$defensemode" exact="0"/>
          <do_if value="$actor.$config_attackenemies?" comment="Vanilla Integration - might be removed at some point">
            <set_value name="$actor.$config_attackenemies" exact="0"/>
          </do_if>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
      </actions>
    </cue>
    
    <cue name="Main" instantiate="true" namespace="this" version="20">
      <conditions>
        <event_cue_signalled cue="this"/>
      </conditions>
      <actions>
        <set_value name="$actor" exact="event.param" />
        <include_actions ref="md.UT_CAC_Lib.Actor_Init" comment="setting neccesary Variables"/>
        <set_value name="$actor.$ut_cac.$defensemode" exact="4"/>
        <!-- cancel Vanilla Dialogue -->
        <signal_objects object="$actor" param="'cancel Vanilla dialogue tree'"/>
        <set_comm_handler actor="$actor" customhandler="true" />
        <!-- From now on, only this instance tree is responsible for handling the entity conversation - only available for the Player, it will manage Personal costs, Dialogue Tree and Settings Config (interface to AIscripts are blackboard Vars and Signals)-->
        <!-- start default Scripts -->
        <debug_text filter="general" chance="@$actor.$debug*100" text="'%1 now uses UT CAC Captain comm handlers'.[$actor.name]" />
      </actions>
      <cues>
        <cue name="Delayed_scriptstart">
          <delay exact="10ms"/>
          <actions>
            <start_script object="$actor" name="'ut.cac.com.defense.main'"/>
          </actions>
        </cue>
        <cue name="Set_Commanderentity">
          <conditions>
            <event_object_signalled object="$actor" param="'set commanderentity'"/>
          </conditions>
          <actions>
            <set_value name="$actor.$ut_cac.$commanderentity" exact="event.param2"/>
            <reset_cue cue="this"/>
          </actions>
        </cue>
        <!-- Payment will be re-worked at a later Date -->
        <!--cue name="Payment" ref="md.UT_CAC_Lib.Payment">
          <param name="actor" value="$actor"/>
        </cue-->
        
<!--
Dialogue Tree - Entity specific Parts:
1. Direct Orders -  Not Available for DO currently (maybe manage Blacklists and Attack Orders over this? (ofc first implement them)
- - - - - -
2. Settings Managment 
=> Aggression (Attack everyting, Defense only, Missile Defense only, no Reaction at all to anemies)
=> 
- - - - - -
Rest is shared between all Actor types
-->

        <cue name="Comm_MainMenu" instantiate="true">
          <conditions>
            <check_any>
              <event_conversation_started actor="$actor" conversation="default"/>
              <event_conversation_returned_to_section actor="$actor" section="default"/>
              <event_cue_signalled/>
            </check_any>
          </conditions>
          <actions>
            <debug_text filter="general" chance="@$actor.$debug * 100" text="'%1 %2 %3:\nevent.param= %4 event.param2= %5 event.param3= %6'.[player.age,$actor.name,event.name,event.param,event.param2,event.param3]"/>
            <do_if value="$actor.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
              <do_if value="event.name == 'event_conversation_started'">
                <show_help position="8" custom="'Hint: You can ALWAYS go back one level with [Esc]'" duration="3s" log="false"/>
                <do_if value="$actor.room == player.entity.room">
                  <add_npc_line speaker="player.entity" line="[1100,1101].random" hidechoices="false" comment="Hello there. | Hi." />
                  <add_npc_line speaker="$actor" line="[1,5,1002,1004].random" hidechoices="false" comment="Hey, there!  | How can I help? | How can I help, Sir? | Hello, Sir. What can I do for you?" />
                </do_if>
                <do_else>
                  <add_npc_line speaker="player.entity" line="[1,1100,1101].random" hidechoices="false" comment="This is Otani, channel open. | Hello there. | Hi." />
                  <add_npc_line speaker="$actor" line="[1,2,5,1001,1003].random" hidechoices="false" comment="Hey, there! | Comms channel open. | How can I help? | Comms opened, Sir. | Coming in loud and clear. What's the matter?" />
                </do_else>
              </do_if>
            </do_if>
            <add_player_choice_sub text="{5554103,1}" position="1" section="comm_orders_main" selectable="false" tooltip="'No Direct Orders for DO implemented yet'"/>
            <add_player_choice_sub text="{5554103,2}" position="2" section="comm_settings_main"/>
            <add_player_choice_sub text="{5554103,3}" position="3" section="comm_connect_main"/>
            <add_player_choice_sub text="{5554103,4}" position="4" section="comm_subordinates_main" selectable="false"/>
            <add_player_choice_sub text="{5554103,5}" position="5" section="comm_personal_main"/>
            <add_player_choice_sub text="'DEBUG'" position="6" section="comm_debug_main"/>
            <set_conversation_return_section section="comm_goodbye"/>
            <add_player_choice_return text="{5554103,6}" position="close" />
          </actions>
        </cue>
        
        <!-- Menu 1: Orders (Note: partially Entity-Specific, see cue Comm_Orders ) -->
        <disabled>
        <cue name="Comm_Common_Orders" instantiate="true" ref="md.UT_CAC_Lib.Comm_Common_Orders">
          <param name="actor" value="$actor"/>
        </cue>
        <cue name="Comm_Orders" instantiate="true">
          <conditions>
            <check_any>
              <event_conversation_next_section sectionprefix="comm_orders_" actor="$actor"/>
              <event_conversation_returned_to_section sectionprefix="comm_orders_" actor="$actor"/>
              <event_cue_signalled/>
            </check_any>
          </conditions>
          <actions>
            <!-- Append a Note what shall happen to the Selected Order if there is one (Necesary for Orderlist Managment) -->
            <do_if value="event.param == 'comm_orders_new'">
              <set_value name="$prev_order" exact="null"/>
            </do_if>
            <do_elseif value="event.param == 'comm_orders_insert'">
              <set_value name="$prev_order" exact="event.param2"/>
              <append_to_list name="$prev_order" exact="'insert'"/>
            </do_elseif>
            <do_elseif value="event.param == 'comm_orders_replace'">
              <set_value name="$prev_order" exact="event.param2"/>
              <append_to_list name="$prev_order" exact="'replace'"/>
            </do_elseif>
            
            <!-- Select new Order -->
            <do_if value="event.param == 'comm_orders_new' or event.param == 'comm_orders_insert' or event.param == 'comm_orders_replace'">
              <do_if value="$actor.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
                <add_npc_line speaker="$actor" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
              </do_if>
              <add_player_choice text="{5554103,131}" position="1" section="comm_orders_combat" comment="same Key as the Orders Menu and first Order for quick Access (Sequence 1 - 1 - 1 )" />
              <add_player_choice text="{5554103,132}" position="3" section="comm_orders_signals" />
              <add_player_choice text="{5554103,133}" position="4" section="comm_orders_select_zone" choiceparam="'comm_orders_flyto_selected'" comment="Object Selection is in ut_cac_lib and passes the selected object to the choiceparam section"/>
              <add_player_choice text="'Follow this CAC Ship \033RTesting Only!!!\033X'" position="5"  section="comm_orders_follow_selected" choiceparam="[0,0,player.ship]" selectable="player.ship.exists and player.ship.pilot.$ut_cac?" comment="Follow the current Player Ship (Menu to be added when this works)"/>
              <add_player_choice_return text="{5554103,7}" position="6" />
              <add_player_choice_return text="{5554103,7}" position="close" />
            </do_if>
            <do_elseif value="event.param == 'comm_orders_combat'">
              <do_if value="$actor.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
                <add_npc_line speaker="$actor" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
              </do_if>
              <add_player_choice text="'\033RH\033X Retreat'" position="1" section="comm_orders_retrat" comment="same Key as the Orders Menu, first Order and Combat for quick Access (Sequence 1 - 1 - 1 - 1 )" selectable="false" tooltip="'not implemented yet; would currently just wait 10s'"/>
              <add_player_choice_return text="{5554103,7}" position="6" />
              <add_player_choice_return text="{5554103,7}" position="close" />
            </do_elseif>
            <do_elseif value="event.param == 'comm_orders_retreat'">
              <!-- ToDo: Write the related Order - i am currently just reserving the Slot here so i will not use it for something else -->
              <set_value name="$new_order" exact="table[$script='ut.cac.microorder',$displayname='\033RHN\033X Retreat',$order='wait exact',$time=10s,$interruptable=true]"/>
            </do_elseif>
            <do_elseif value="event.param == 'comm_orders_flyto_selected'">
              <do_if value="$actor.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
                <add_npc_line speaker="$actor" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
              </do_if>
              <set_value name="$new_order" exact="table[$script='ut.cac.move.generic',$displayname='Fly to %1'.[event.param2.{3}.knownname],$destination=event.param2.{3},$interruptable=true]"/>
            </do_elseif>
            <do_elseif value="event.param == 'comm_orders_follow_selected'">
              <do_if value="$actor.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
                <add_npc_line speaker="$actor" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
              </do_if>
              <set_value name="$new_order" exact="table[$script='ut.cac.move.follow.verysimple',$displayname='Follow %1'.[if event.param2.{3}.controlentity.$shortname then event.param2.{3}.controlentity.$shortname else event.param2.{3}.knownname],$object=event.param2.{3},$interruptable=true]"/>
            </do_elseif>
            <do_elseif value="event.param == 'comm_orders_signals'">
              <do_if value="$actor.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
                <add_npc_line speaker="$actor" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
              </do_if>
              <add_player_choice text="{5554103,1321}" position="1" section="comm_orders_send_signal_selected" choiceparam="[0LF,0LF,$actor.ship]" />
              <add_player_choice text="{5554103,1322}" position="2" section="comm_orders_select_playerobject" choiceparam="'comm_orders_send_signal_selected'" comment="Object Selection is in ut_cac_lib and passes the selected object to the choiceparam section"/>
              <add_player_choice text="{5554103,1323}" position="3" section="comm_orders_send_signal_selected" choiceparam="[0LF,0LF,$actor.ship.commander]" />
              <add_player_choice text="{5554103,1324}" position="4" section="comm_orders_wait_signal_selected" choiceparam="[0LF,0LF,$actor.ship]" />
              <add_player_choice text="{5554103,1325}" position="5" section="comm_orders_select_playerobject" choiceparam="'comm_orders_wait_signal_selected'" comment="Object Selection is in ut_cac_lib and passes the selected object to the choiceparam section"/>
              <add_player_choice text="{5554103,1326}" position="6" section="comm_orders_wait_signal_selected" choiceparam="[0LF,0LF,$actor.ship.commander]" />
            </do_elseif>
            <do_elseif value="event.param == 'comm_orders_send_signal_selected'">
              <set_value name="$new_order" exact="table[$script='ut.cac.microorder',$order='signalobject',$interruptable=true,$displayname='Send Signal to %1'.[event.param2.{3}.knownname],$signalobject=event.param2.{3},$signalparam='0x62656570']"/>
            </do_elseif>
            <do_elseif value="event.param == 'comm_orders_wait_signal_selected'">
              <set_value name="$new_order" exact="table[$script='ut.cac.microorder',$order='wait signal',$interruptable=true,$displayname='Wait for Signal on %1'.[event.param2.{3}.knownname],$signalobject=event.param2.{3},$signalparam='0x62656570']"/>
            </do_elseif>
            
            <!-- If both $prev_order and $new_order have a Value we can safely assume the Player has selected where he wants to add a New Order and what this Order is - so just insert it at the specified Spot -->
            <do_if value="$prev_order? and $new_order?">
              <!-- Player selected no Previous Order so he wants to attach it at the End of the List -->
              <do_if value="$prev_order == null">
                <append_to_list name="$actor.$orderlist" exact="$new_order"/>
              </do_if>
              <do_else>
              <!-- Player selected a Specific Order to replace or insert - if it hasnt Moved just get its index, otherwise use the first fit in the List -->
                <do_if value="$actor.$orderlist.{$prev_order.{3}} == $prev_order.{2}">
                  <set_value name="$index" exact="$prev_order.{3}"/>
                </do_if>
                <!-- Order to replace moved down - a common occurence probably -->
                <do_elseif value="$actor.$orderlist.indexof.{$prev_order.{2}} lt $prev_order.{3}">
                  <set_value name="$index" exact="$actor.$orderlist.indexof.{$prev_order.{2}}"/>
                </do_elseif>
                <!-- Order moved Up - Unusual, leave a Note in the Log -->
                <do_elseif value="$actor.$orderlist.indexof.{$prev_order.{2}}">
                  <set_value name="$index" exact="$actor.$orderlist.indexof.{$prev_order.{2}}"/>
                </do_elseif>
                <!-- Order not in Orderlist anymore - Dont change anything -->
                <do_else>
                  <set_value name="$index" exact="null"/>
                </do_else>
                <do_if value="$index">
                  <do_if value="$prev_order.{4} == 'insert'">
                    <set_value name="$actor.$orderlist.{$index}" exact="$new_order" operation="insert"/>
                  </do_if>
                  <do_elseif value="$prev_order.{4} == 'replace'">
                    <set_value name="$actor.$orderlist.{$index}" exact="$new_order"/>
                  </do_elseif>
                </do_if>
              </do_else>
              <signal_objects object="$actor" param="'new order received'" comment="to signal wait Scripts which wait for new Orders or should abort in this case"/>
              <remove_value name="$prev_order"/>
              <remove_value name="$new_order"/>
              <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
            </do_if>
            
          </actions>
        </cue>
        </disabled>
        
        <!-- Menu 2: Object Settings specific to DO -->
        <cue name="Comm_Settings" instantiate="true">
          <conditions>
            <check_any>
              <event_conversation_next_section sectionprefix="comm_settings_" actor="$actor"/>
              <event_conversation_returned_to_section sectionprefix="comm_settings_" actor="$actor"/>
            </check_any>
          </conditions>
          <actions>
            <do_if value="event.param == 'comm_settings_main'">
              <do_if value="$actor.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
                <do_if value="event.name == 'event_conversation_next_section'">
                  <add_npc_line speaker="player.entity" line="[1400,1401,1402].random" hidechoices="false" comment="lets talk about this in detail" />
                  <add_npc_line speaker="$actor" line="[4110,4111].random" hidechoices="false" comment="Here you go." />
                </do_if>
                <do_elseif value="event.name == 'event_conversation_returned_to_section'">
                  <do_if value="event.param2 == 'no change'">
                    <add_npc_line speaker="player.entity" line="[1220,1410,1612,1713,1714].random" hidechoices="false" comment="No, I changed my mind.|Never mind that, do what you want.|Never mind that, do what you want.|Never mind that.|Well, maybe some other time." />
                  </do_if>
                  <add_npc_line speaker="$actor" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
                </do_elseif>
              </do_if>
              <add_player_choice_sub text="{5554103,252}.[readtext.{5554103}.{2521+$actor.$ut_cac.$defensemode}]" position="2" section="comm_settings_behavior" comment="Change how Aggresively Enemies will be dealt with"/>
              <add_player_choice_return text="{5554103,7}" position="6" />
              <add_player_choice_return text="{5554103,7}" position="close" />
            </do_if>
            <do_elseif value="event.param == 'comm_settings_behavior'">
              <add_player_choice text="{5554103,2521}" position="1" section="comm_settings_behavior_incative" immediate="$actor.$ut_cac.$defensemode == 1"/>
              <add_player_choice text="{5554103,2522}" position="2" section="comm_settings_behavior_missile_defense" immediate="$actor.$ut_cac.$defensemode == 2"/>
              <add_player_choice text="{5554103,2523}" position="3" section="comm_settings_behavior_defensive" immediate="$actor.$ut_cac.$defensemode == 3"/>
              <add_player_choice text="{5554103,2524}" position="4" section="comm_settings_behavior_defense_aggressive" immediate="$actor.$ut_cac.$defensemode == 4"/>
              <add_player_choice text="{5554103,2525}" position="5" section="comm_settings_behavior_aggressive" immediate="$actor.$ut_cac.$defensemode == 5"/>
              <add_player_choice_return text="{5554103,7}" position="6" />
              <add_player_choice_return text="{5554103,7}" position="close" />
            </do_elseif>
            <do_elseif value="event.param == 'comm_settings_behavior_aggressive'">
              <set_value name="$actor.$ut_cac.$defensemode" exact="4"/>
              <do_if value="$actor.$config_attackenemies?" comment="Vanilla Integration - might be removed at some point">
                <set_value name="$actor.$config_attackenemies" exact="1"/>
              </do_if>
              <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
            </do_elseif>
            <do_elseif value="event.param == 'comm_settings_behavior_defense_aggressive'">
              <set_value name="$actor.$ut_cac.$defensemode" exact="3"/>
              <do_if value="$actor.$config_attackenemies?" comment="Vanilla Integration - might be removed at some point">
                <set_value name="$actor.$config_attackenemies" exact="1"/>
              </do_if>
              <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
            </do_elseif>
            <do_elseif value="event.param == 'comm_settings_behavior_defensive'">
              <set_value name="$actor.$ut_cac.$defensemode" exact="2"/>
              <do_if value="$actor.$config_attackenemies?" comment="Vanilla Integration - might be removed at some point">
                <set_value name="$actor.$config_attackenemies" exact="0"/>
              </do_if>
              <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
            </do_elseif>
            <do_elseif value="event.param == 'comm_settings_behavior_missile_defense'">
              <set_value name="$actor.$ut_cac.$defensemode" exact="1"/>
              <do_if value="$actor.$config_attackenemies?" comment="Vanilla Integration - might be removed at some point">
                <set_value name="$actor.$config_attackenemies" exact="0"/>
              </do_if>
              <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
            </do_elseif>
            <do_elseif value="event.param == 'comm_settings_behavior_incative'">
              <set_value name="$actor.$ut_cac.$defensemode" exact="0"/>
              <do_if value="$actor.$config_attackenemies?" comment="Vanilla Integration - might be removed at some point">
                <set_value name="$actor.$config_attackenemies" exact="0"/>
              </do_if>
              <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
            </do_elseif>
          </actions>
        </cue>
        
        <!-- Menu 3: Connect with other Actor-->
        <cue name="Comm_Common_Connect" instantiate="true" ref="md.UT_CAC_Lib.Comm_Common_Connect">
          <param name="actor" value="$actor"/>
        </cue>
        <!-- Menu 4: Subordinates Handling -->
        <cue name="Comm_Common_Subordinates" instantiate="true" ref="md.UT_CAC_Lib.Comm_Common_Subordinates">
          <param name="actor" value="$actor"/>
        </cue>
        <!-- Menu 5: Personal Settings (as lib since its shared with other NPC Types) -->
        <cue name="Comm_Common_Personal" instantiate="true" ref="md.UT_CAC_Lib.Comm_Common_Personal">
          <param name="actor" value="$actor"/>
        </cue>
        <!-- Misc Menu Items (Debug menu (6)) and Goodbye Section) -->
        <cue name="Comm_Common_Misc" instantiate="true" ref="md.UT_CAC_Lib.Comm_Common_Misc">
          <param name="actor" value="$actor"/>
        </cue>
        
        <cue name="Subordinate_Added" instantiate="true">
          <conditions>
            <check_all>
              <event_object_subordinate_added object="$actor.container" commandertype="entitytype.commander"/>
              <check_value value="$actor.ship.buildmodule? and $actor.ship.architect?"/>
            </check_all>
          </conditions>
          <actions>
            <!-- pass all assigned Subordinates to the Manager when on a CV -->
            <set_object_commander object="event.param" commander="$actor.container" type="entitytype.manager"/>
          </actions>
        </cue>
        <cue name="NPC_Destroyed">
          <conditions>
            <check_any>
              <event_object_destroyed object="$actor"/>
              <event_object_signalled object="$actor" param="'Cancel UT CAC Dialogue'"/>
            </check_any>
          </conditions>
          <!--delay exact="1s" comment="delay as the PlatformActor library may also take care of this"/ currently not included, so commented out -->
          <actions>
            <debug_text filter="general" chance="@$actor.$debug*100" text="'%1 UT CAC Dialogue canceled, reason: %2'.[$actor.name,event.name]" />
            <cancel_cue cue="Main"/>
          </actions>
        </cue>
        
      </cues>
    </cue>

  </cues>

</mdscript>
