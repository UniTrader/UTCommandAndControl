<?xml version="1.0" encoding="UTF-8" ?>
<mdscript name="UT_CAC_Defense" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/md.xsd">

  <cues>
    <cue name="Settings" instantiate="true">
      <conditions>
        <check_any>
          <event_conversation_next_section sectionprefix="comm_defense_settings_"/>
          <event_conversation_returned_to_section sectionprefix="comm_defense_settings_"/>
        </check_any>
      </conditions>
      <actions>
        <debug_text filter="general" chance="@event.object.$debug * 100" text="'%1 %2 event.name= %3 \nevent.param= %4 event.param2= %5 event.param3= %6'.[event.object.name,event.object.container.name,event.name,event.param,event.param2,event.param3]"/>
        <do_if value="event.param == 'comm_defense_settings_main'">
          <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
            <do_if value="event.name == 'event_conversation_next_section'">
              <add_npc_line speaker="player.entity" line="[1400,1401,1402].random" hidechoices="false" comment="lets talk about this in detail" />
              <add_npc_line speaker="event.object" line="[4110,4111].random" hidechoices="false" comment="Here you go." />
            </do_if>
            <do_elseif value="event.name == 'event_conversation_returned_to_section'">
              <do_if value="event.param2 == 'no change'">
                <add_npc_line speaker="player.entity" line="[1220,1410,1612,1713,1714].random" hidechoices="false" comment="No, I changed my mind.|Never mind that, do what you want.|Never mind that, do what you want.|Never mind that.|Well, maybe some other time." />
              </do_if>
              <add_npc_line speaker="event.object" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
            </do_elseif>
          </do_if>
          <add_player_choice_sub text="{5554104,252}.[readtext.{5554104}.{2521+event.object.$ut_cac.$defensemode}]" position="2" section="comm_defense_settings_behavior" comment="Change how Aggresively Enemies will be dealt with"/>
          <add_player_choice_return text="{5554104,7}" position="6" />
          <add_player_choice_return text="{5554104,7}" position="close" />
        </do_if>
        <do_elseif value="event.param == 'comm_defense_settings_behavior'">
          <add_player_choice text="{5554103,12001}" position="1" section="comm_defense_settings_behavior_incative" immediate="event.object.$ut_cac.$defensemode == 1"/>
          <add_player_choice text="{5554103,12002}" position="2" section="comm_defense_settings_behavior_missile_defense" immediate="event.object.$ut_cac.$defensemode == 2"/>
          <add_player_choice text="{5554103,12003}" position="3" section="comm_defense_settings_behavior_defensive" immediate="event.object.$ut_cac.$defensemode == 3"/>
          <add_player_choice text="{5554103,12004}" position="4" section="comm_defense_settings_behavior_defense_aggressive" immediate="event.object.$ut_cac.$defensemode == 4"/>
          <add_player_choice text="{5554103,12005}" position="5" section="comm_defense_settings_behavior_aggressive" immediate="event.object.$ut_cac.$defensemode == 5"/>
          <add_player_choice_return text="{5554104,7}" position="6" />
          <add_player_choice_return text="{5554104,7}" position="close" />
        </do_elseif>
        <do_elseif value="event.param == 'comm_defense_settings_behavior_aggressive'">
          <set_value name="event.object.$ut_cac.$defensemode" exact="4"/>
          <do_if value="event.object.$config_attackenemies?" comment="Vanilla Integration - might be removed at some point">
            <set_value name="event.object.$config_attackenemies" exact="1"/>
          </do_if>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_defense_settings_behavior_defense_aggressive'">
          <set_value name="event.object.$ut_cac.$defensemode" exact="3"/>
          <do_if value="event.object.$config_attackenemies?" comment="Vanilla Integration - might be removed at some point">
            <set_value name="event.object.$config_attackenemies" exact="1"/>
          </do_if>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_defense_settings_behavior_defensive'">
          <set_value name="event.object.$ut_cac.$defensemode" exact="2"/>
          <do_if value="event.object.$config_attackenemies?" comment="Vanilla Integration - might be removed at some point">
            <set_value name="event.object.$config_attackenemies" exact="0"/>
          </do_if>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_defense_settings_behavior_missile_defense'">
          <set_value name="event.object.$ut_cac.$defensemode" exact="1"/>
          <do_if value="event.object.$config_attackenemies?" comment="Vanilla Integration - might be removed at some point">
            <set_value name="event.object.$config_attackenemies" exact="0"/>
          </do_if>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_defense_settings_behavior_incative'">
          <set_value name="event.object.$ut_cac.$defensemode" exact="0"/>
          <do_if value="event.object.$config_attackenemies?" comment="Vanilla Integration - might be removed at some point">
            <set_value name="event.object.$config_attackenemies" exact="0"/>
          </do_if>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
      </actions>
    </cue>
    
    <cue name="Main" instantiate="true" namespace="this" version="20">
      <conditions>
        <event_cue_signalled cue="this"/>
      </conditions>
      <cues>
        <cue name="Handover_040">
          <!-- The Instance Cue will not be used from 0.40 on anymore - handing over all Instances to the common dialogue Script -->
          <actions>
            <do_if value="$actor.ship.defencenpc == $actor">
              <set_value name="$actor.$ut_cac.$settings_section" exact="'comm_defense_settings_main'"/>
            </do_if>
            <do_else>
              <remove_value name="$actor.$ut_cac.$orders_section"/>
            </do_else>
            <debug_text filter="general" text="'%1 UT CAC Dialogue Handover to 040'.[$actor.name]" />
            <cancel_cue cue="Main"/>
          </actions>
        </cue>
      </cues>
    </cue>
  </cues>
</mdscript>
