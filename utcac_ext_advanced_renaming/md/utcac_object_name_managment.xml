<?xml version="1.0" encoding="UTF-8"?>
<mdscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="UT_CAC_Object_Name_Managment" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/md.xsd">
  <cues>
    <cue name="Init" version="2">
      <actions>
        <!-- Set Up all Groups needed for Automatic Name Upates -->
        <create_group groupname="$NamedObjects"/>
        <!-- set current User Expression Version so Update on load only happens when it changed -->
        <set_value name="$customversion" exact="{5554302,1}"/>
      </actions>
      <patch sinceversion="2">
        <remove_value name="$Skill"/>
        <create_group groupname="$NamedObjects"/>
      </patch>
      <cues>
        <cue name="NameUpdateSingleobject" instantiate="true">
          <conditions>
            <check_any>
              <event_object_signalled object="player.galaxy" param="'Object Name Updated'" comment="for (initial) signalling from lua"/>
              <event_object_signalled object="player.galaxy" param="'Subordinates Name Updated'" comment="for (initial) signalling from lua"/>
              <event_object_signalled group="$NamedObjects" param="'Object Name Updated'" comment="for Update Signalling from other Scripts"/>
            </check_any>
          </conditions>
          <actions>
            <do_if value="event.object == player.galaxy">
              <do_if value="event.param == 'Subordinates Name Updated'">
                <!-- Redirect to Cue for Renaming Subordinates, dont update Name of this Object - the include_actions later checks for valadity of $object so not setting it here. -->
                <do_all exact="event.param2.subordinates.count" counter="$i">
                  <set_value name="event.param2.subordinates.{$i}.controlentity.$unformatted_object_name" exact="event.param3"/>
                  <add_to_group groupname="$NamedObjects" object="event.param2.subordinates.{$i}"/>
                  <signal_objects object="event.param2.subordinates.{$i}" param="'Object Name Updated'"/>
                </do_all>
              </do_if>
              <do_else>
                <set_value name="$object" exact="event.param2"/>
                <add_to_group groupname="$NamedObjects" object="$object"/>
              </do_else>
            </do_if>
            <do_else>
              <set_value name="$object" exact="event.object"/>
              <!-- note: In this case event.param2 should contain why the Object Name has to be updated ( currently implemented reasons: Skill ) - skip Update if there is no effecive change when you know how to check for this -->
            </do_else>
            <include_actions ref="RenameActions"/>
            <remove_value name="$object"/>
          </actions>
        </cue>
        <cue name="NameUpdateAllPlayerObjects" instantiate="true">
          <conditions>
            <check_any>
              <check_all>
                <event_game_loaded/>
                <check_value value="{5554302,1} != @$customversion" comment="only update when Custom (User) Version has changed"/>
              </check_all>
            </check_any>
          </conditions>
          <delay exact="5s"/>
          <actions>
            <set_value name="$customversion" exact="{5554302,1}"/>
            <find_object name="$playerobjects" space="player.galaxy" multiple="true"/>
            <do_all exact="$playerobjects.count" counter="$i">
              <set_value name="$object" exact="$playerobjects.{$i}"/>
              <include_actions ref="RenameActions"/>
              <remove_value name="$object"/>
            </do_all>
          </actions>
        </cue>
      </cues>
    </cue>
    <library name="RenameActions">
      <actions>
        <!-- confirm valadity of Object -->
        <do_if value="$object.exists and $object.controlentity.$unformatted_object_name?">
          <do_if value="$keys? or $nameA?">
            <debug_text filter="error" text="'Internally used Vars in Included Actions also used by previous Code: $keys: %1 $nameA: %2 $nameB: %3 - will be overridden!!'.[@$keys,@$nameA,@$nameB]"/>
          </do_if>
          <set_value name="$nameA" exact="$object.controlentity.$unformatted_object_name"/>
          <!-- Perform Static Replacements (Preffered Marking Key / ) -->
          <get_text_ids_in_range result="$keys" page="5554301" start="0" end="1999" factor="2"/>
          <do_all exact="$keys.count" counter="$i" reverse="false">
            <substitute_text text="$nameA">
              <replace string="readtext.{5554301}.{$keys.{$i}}" with="readtext.{5554301}.{$keys.{$i}+1}"/>
            </substitute_text>
          </do_all>
          <!-- If Language-transfer is desired Save name Var back to local Var now, continue with remaining phrases after that -->
          <do_if value="{5554302,1} == 'yes'">
            <set_value name="$object.controlentity.$unformatted_object_name" exact="$nameA"/>
          </do_if>
          <get_text_ids_in_range result="$keys" page="5554301" start="2000" end="3000" factor="2"/>
          <do_all exact="$keys.count" counter="$i" reverse="false">
            <substitute_text text="$nameA">
              <replace string="readtext.{5554301}.{$keys.{$i}}" with="readtext.{5554301}.{$keys.{$i}+1}"/>
            </substitute_text>
          </do_all>
          
          <!-- Perform Script-Dynamic Replacements ( Marking Key $ ) - no Registration for Automated Update Event, send Signal or Include Actions yourself.-->
          <!-- (feel free to create and add your own Values to the local table $namereplacement though ;) -->
          <do_if value="$object.controlentity.$namereplacement?">
            <set_value name="$keys" exact="$object.controlentity.$namereplacement.keys.list"/>
            <do_all exact="$keys.count" counter="$i" reverse="false">
              <substitute_text text="$nameA">
                <replace string="$keys.{$i}" with="$object.controlentity.$namereplacement.{$keys.{$i}}"/>
              </substitute_text>
            </do_all>
          </do_if>
          
          <!-- Perform Engine-based Dynamic Replacements ( Marking Key % ) and also add them to Update Group if used-->
          <!-- Skill-based Expressions - switching to from $nameA to $nameB for actual name to compare it to before substitution -->
          <substitute_text source="$nameA" text="$nameB">
            <replace string="{5554302,10}" with="$object.boardingnpc.combinedskill"/>
            <replace string="{5554302,11}" with="$object.boardingnpc.skill.boarding"/>
            <replace string="{5554302,12}" with="$object.boardingnpc.skill.combat"/>
            <replace string="{5554302,13}" with="$object.boardingnpc.skill.engineering"/>
            <replace string="{5554302,14}" with="$object.boardingnpc.skill.leadership"/>
            <replace string="{5554302,15}" with="$object.boardingnpc.skill.management"/>
            <replace string="{5554302,16}" with="$object.boardingnpc.skill.navigation"/>
            <replace string="{5554302,17}" with="$object.boardingnpc.skill.morale"/>
            <replace string="{5554302,18}" with="$object.boardingnpc.skill.science"/>
            <replace string="{5554302,20}" with="$object.pilot.combinedskill"/>
            <replace string="{5554302,21}" with="$object.pilot.skill.boarding"/>
            <replace string="{5554302,22}" with="$object.pilot.skill.combat"/>
            <replace string="{5554302,23}" with="$object.pilot.skill.engineering"/>
            <replace string="{5554302,24}" with="$object.pilot.skill.leadership"/>
            <replace string="{5554302,25}" with="$object.pilot.skill.management"/>
            <replace string="{5554302,26}" with="$object.pilot.skill.navigation"/>
            <replace string="{5554302,27}" with="$object.pilot.skill.morale"/>
            <replace string="{5554302,28}" with="$object.pilot.skill.science"/>
            <replace string="{5554302,30}" with="$object.defencenpc.combinedskill"/>
            <replace string="{5554302,31}" with="$object.defencenpc.skill.boarding"/>
            <replace string="{5554302,32}" with="$object.defencenpc.skill.combat"/>
            <replace string="{5554302,33}" with="$object.defencenpc.skill.engineering"/>
            <replace string="{5554302,34}" with="$object.defencenpc.skill.leadership"/>
            <replace string="{5554302,35}" with="$object.defencenpc.skill.management"/>
            <replace string="{5554302,36}" with="$object.defencenpc.skill.navigation"/>
            <replace string="{5554302,37}" with="$object.defencenpc.skill.morale"/>
            <replace string="{5554302,38}" with="$object.defencenpc.skill.science"/>
            <replace string="{5554302,40}" with="$object.engineer.combinedskill"/>
            <replace string="{5554302,41}" with="$object.engineer.skill.boarding"/>
            <replace string="{5554302,42}" with="$object.engineer.skill.combat"/>
            <replace string="{5554302,43}" with="$object.engineer.skill.engineering"/>
            <replace string="{5554302,44}" with="$object.engineer.skill.leadership"/>
            <replace string="{5554302,45}" with="$object.engineer.skill.management"/>
            <replace string="{5554302,46}" with="$object.engineer.skill.navigation"/>
            <replace string="{5554302,47}" with="$object.engineer.skill.morale"/>
            <replace string="{5554302,48}" with="$object.engineer.skill.science"/>
            <replace string="{5554302,50}" with="$object.tradenpc.combinedskill"/>
            <replace string="{5554302,51}" with="$object.tradenpc.skill.boarding"/>
            <replace string="{5554302,52}" with="$object.tradenpc.skill.combat"/>
            <replace string="{5554302,53}" with="$object.tradenpc.skill.engineering"/>
            <replace string="{5554302,54}" with="$object.tradenpc.skill.leadership"/>
            <replace string="{5554302,55}" with="$object.tradenpc.skill.management"/>
            <replace string="{5554302,56}" with="$object.tradenpc.skill.navigation"/>
            <replace string="{5554302,57}" with="$object.tradenpc.skill.morale"/>
            <replace string="{5554302,58}" with="$object.tradenpc.skill.science"/>
            <!--
            <replace string="{5554302,60}" with="$object.pilot.combinedskill"/>
            <replace string="{5554302,61}" with="$object.pilot.skill.boarding"/>
            <replace string="{5554302,62}" with="$object.pilot.skill.combat"/>
            <replace string="{5554302,63}" with="$object.pilot.skill.engineering"/>
            <replace string="{5554302,64}" with="$object.pilot.skill.leadership"/>
            <replace string="{5554302,65}" with="$object.pilot.skill.management"/>
            <replace string="{5554302,66}" with="$object.pilot.skill.morale"/>
            <replace string="{5554302,67}" with="$object.pilot.skill.navigation"/>
            <replace string="{5554302,68}" with="$object.pilot.skill.science"/>
            
            <replace string="{5554302,70}" with="$object.pilot.combinedskill"/>
            <replace string="{5554302,71}" with="$object.pilot.skill.boarding"/>
            <replace string="{5554302,72}" with="$object.pilot.skill.combat"/>
            <replace string="{5554302,73}" with="$object.pilot.skill.engineering"/>
            <replace string="{5554302,74}" with="$object.pilot.skill.leadership"/>
            <replace string="{5554302,75}" with="$object.pilot.skill.management"/>
            <replace string="{5554302,76}" with="$object.pilot.skill.morale"/>
            <replace string="{5554302,77}" with="$object.pilot.skill.navigation"/>
            <replace string="{5554302,78}" with="$object.pilot.skill.science"/>
            
            <replace string="{5554302,80}" with="$object.pilot.combinedskill"/>
            <replace string="{5554302,81}" with="$object.pilot.skill.boarding"/>
            <replace string="{5554302,82}" with="$object.pilot.skill.combat"/>
            <replace string="{5554302,83}" with="$object.pilot.skill.engineering"/>
            <replace string="{5554302,84}" with="$object.pilot.skill.leadership"/>
            <replace string="{5554302,85}" with="$object.pilot.skill.management"/>
            <replace string="{5554302,86}" with="$object.pilot.skill.morale"/>
            <replace string="{5554302,87}" with="$object.pilot.skill.navigation"/>
            <replace string="{5554302,88}" with="$object.pilot.skill.science"/>
            -->
          </substitute_text>
          <do_if value="$nameA != $nameB">
            <add_to_group groupname="$Skill" object="$object"/>
          </do_if>
          <do_else>
            <remove_from_group group="$Skill" object="$object"/>
          </do_else>
          <substitute_text text="$nameB">
            <replace string="{5554302,100}" with="$object.commander.name"/>
            <replace string="{5554302,101}" with="$object.commander.zone.name"/>
            <replace string="{5554302,102}" with="$object.commander.sector.name"/>
            <replace string="{5554302,103}" with="$object.commander.cluster.name"/>
            <replace string="{5554302,104}" with="$object.zone.name"/>
            <replace string="{5554302,105}" with="$object.sector.name"/>
            <replace string="{5554302,106}" with="$object.cluster.name"/>
            <replace string="{5554302,107}" with="$object.macro.name"/>
            <replace string="{5554302,108}" with="{5554301,11001} + $object.primarypurpose"/> <!-- will be post-dynamic replaced with proper Purpose Name -->
            <replace string="{5554302,109}" with="{5554301,11015} + $object.class"/> <!-- will be post-dynamic replaced with proper Class Name -->
          </substitute_text>
          
          <!-- Post-dynamic substitutions -->
          <get_text_ids_in_range result="$keys" page="5554301" start="10000" end="12000" factor="2"/>
          <do_all exact="$keys.count" counter="$i" reverse="false">
            <substitute_text text="$nameB">
              <replace string="readtext.{5554301}.{$keys.{$i}}" with="readtext.{5554301}.{$keys.{$i}+1}"/>
            </substitute_text>
          </do_all>
          
          <!-- Finally Set Name -->
          <set_object_name object="$object" name="$nameB"/>
        </do_if>
        <do_else>
          <debug_text filter="error" text="'Object not set or Invalid for Included Code $object: %1 - doing nothing!!'.{@$object}"/>
        </do_else>
      </actions>
    </library>
  </cues>
</mdscript>
