<?xml version="1.0" encoding="UTF-8" ?>
<aiscript name="ut.cac.move.gate2" version="30" priority="10" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd">
  <!--

 rewritten from scratch by UniTrader
  
 Routine for passing through Gates (was in move.jump and move.generic before)
 
 based on the original ut.cac.move.gate but wanted to do some drastic changes, therefore using a new Script. Core Ideas will remain.
 
 Script now Assumes we are nearby the Gate on Script Start - if not it may delay  the Passage of others

  -->
  <params>
    <param name="params" default="false" comment="pass a single Table filled with the wanted param Values here to make calls via list possible (always has priority)"/>
    <param name="gate" default="false" comment="Gate to go through (Must be in the same Zone)"/>
    <param name="cleargate" default="true" comment="Clear the Gate after Passage?"/>
    
    <param name="queue_position" default="false" comment="position in the Gate queue where Fight Ships add themselves to to pass the Gate before unarmed Ships (false will assume this is the leader and add to the End)"/>
    <param name="leader" default="false" comment="set to true if this Ship should wait for the $passage_group before continuing and to false if not - (if set to 2 will default to be true if a queue_position is passed and false if not )"/>
    <param name="passage_group" default="false" comment="Group of all Ships which pass the Gate as a Group"/>
    
  </params>
  <interrupts>
  </interrupts>
  <patch sinceversion="30">
    <create_group groupname="$passage_group"/>
  </patch>
  <attention min="unknown">
    <actions>
      <!-- first decode the $params to the Variables -->
      <do_if value="$params">
        <do_if value="$params.$gate?">
          <set_value name="$gate" exact="$params.$gate"/>
        </do_if>
        <do_if value="$params.$cleargate?">
          <set_value name="$cleargate" exact="$params.$cleargate"/>
        </do_if>
        <do_if value="$params.$formationlist?">
          <set_value name="$formationlist" exact="$params.$formationlist"/>
        </do_if>
      </do_if>
      
      <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Script started with Params:\n$gate: %4 ; $cleargate: %5 $formationlist: %6'.[player.age,this.name,this.container.name,$gate,$cleargate,@$formationlist]"/>
      
      <label name="start"/>
      
      <!-- then check if the Input and Situation is Valid  -->
      <do_if value="not $gate.exists or not $gate.isclass.gate">
        <debug_text filter="error" text="'%1 %2 %3 Gate not existent or not a gate - aborting!'.[player.age,this.name,this.container.name]"/>
        <return/>
      </do_if>
      <do_if value="not $gate.isactive">
        <debug_text filter="error" text="'%1 %2 %3 Trying to pass inactive Gate - aborting!'.[player.age,this.name,this.container.name]"/>
        <return/>
      </do_if>
      <do_if value="this.zone != $gate.zone">
        <debug_text filter="error" text="'%1 %2 %3 Not in Gate Zone - aborting!'.[player.age,this.name,this.container.name]"/>
        <return/>
      </do_if>
      
      <!-- HACK for FoO - Albion Gate: Ignore the Big Asteroid when aquiring Safe Pos -->
      <do_if value="$gate.zone.macro.ismacro.{'Cluster_T_Sector01_Zone001_macro'}">
        <find_object name="$ignoredobject" space="$gate.zone" macro="macro.landmarks_unique_the_mace_macro"/>
      </do_if>
      <do_else>
        <set_value name="$ignoredobject" exact="this.ship"/>
      </do_else>
      
      <!-- Dont abort Path on first move_to, but for each one after that for fluid movement (except it is currently just flying to a safepos, indicated by this$mayabortpath)-->
      <set_value name="$continuepath" exact="not this.$mayabortpath?"/>
      <remove_value name="this.$mayabortpath"/>
      
      <set_command_action commandaction="commandaction.flyingto" param="$gate.destination"/>
      <do_if value="this.$ut_cac?">
        <set_value name="this.$ut_cac.$isactive"/>
      </do_if>
      
      <!-- check if global Var for Gate Passage exists and create if necesary -->
      <!-- Note: the Table must always have a first entry which is reserved for the Ship currently flying into the Gate - set to null if currently no Ship is passing. -->
      <do_if value="not global.$gate_queue?">
        <set_value name="global.$gate_queue" exact="table[{$gate}=[]]"/>
        <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Creating Global Gate Passage Table: %4 current Gate: %5'.[player.age,this.knownname,this.container.knownname,global.$gate_queue,$gate]"/>
      </do_if>
      <do_elseif value="not global.$gate_queue.{$gate}?">
        <set_value name="global.$gate_queue.{$gate}" exact="[]"/>
        <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Adding Gate to Global Gate Passage Table: %4 current Gate: %5'.[player.age,this.knownname,this.container.knownname,global.$gate_queue,$gate]"/>
      </do_elseif>
      
      <!-- Register in Gate Queue, Create Passage Group to keep a Group of Ships together after Passage and tell Followers our Position so they can add themselves before us if required -->
      <do_if value="not $queue_position">
        <do_if value="global.$gate_queue.{$gate}.indexof.{this.ship}">
          <debug_text filter="error" text="'%1 %2 %3 Already Registered in Gate Queue on Script Start - removing %4'.[player.age,this.name,this.container.name,global.$gate_queue.{$gate}.indexof.{this.ship}]"/>
          <remove_value name="global.$gate_queue.{$gate}.{global.$gate_queue.{$gate}.indexof.{this.ship}}"/>
        </do_if>
        <append_to_list name="global.$gate_queue.{$gate}" exact="this.ship"/>
        <set_value name="$queue_position" exact="global.$gate_queue.{$gate}.count"/>
      </do_if>
      <do_else>
        <set_value name="global.$gate_queue.{$gate}.{$queue_position}" exact="this.ship" operation="insert"/>
        <!-- ToDo: Signal Everyone who was just moved up (or do a general Update) - not necesary currently since its only used for Group Coordination. Might be necesary when Special Ability to Sneak in Queue becomes available -->
      </do_else>
      <do_if value="not $passage_group">
        <create_group groupname="$passage_group"/>
      </do_if>
      <add_to_group groupname="$passage_group" object="this.ship"/>
      <signal_objects object="this.ship" param="'travel gate prep'" param2="[$gate,$queue_position]" param3="$passage_group"/>
      <wait exact="100ms"/>
      
      <!-- Calculate Position so we can sort into the Queue behind the Gate, and Move there (restarts with every Passage or Abort of others for fluid movement) -->
      <label name="fly to prep pos"/>
      <set_value name="$queue_position" exact="global.$gate_queue.{$gate}.indexof.{this.ship}"/>
      
      <do_if value="not $queue_position">
        <debug_text filter="error" text="'%1 %2 %3 Not in Gate Queue - Restarting!'.[player.age,this.name,this.container.name]"/>
        <resume label="start"/>
      </do_if>
      <!-- calculate Target Distance BEHIND the Gate (therefore subtract) -->
      <set_value name="$queue_distance" exact="0m"/>
      <do_all exact="$queue_position" counter="$i" reverse="true">
        <do_if value="global.$gate_queue.{$gate}.{$i}.exists and global.$gate_queue.{$gate}.{$i}.zone == $gate.zone">
          <set_value name="$queue_distance" operation="subtract" exact="global.$gate_queue.{$gate}.{$i}.size * 2"/>
        </do_if>
        <do_else>
          <!-- remove invalid entries from queue when encountering them.. -->
          <remove_value name="global.$gate_queue.{$gate}.{$i}"/>
          <!-- also re-adjust queue Position -->
          <set_value name="$queue_position" operation="subtract"/>
        </do_else>
      </do_all>
      <do_if value="global.$gate_queue.{$gate}.{1}.pilot.commandaction.param == $gate" comment="if the leading Ship is currently flying into the Gate it doesnt need is full length reserved because one half will be behind the Gate at the target pos">
        <set_value name="$queue_distance" operation="add" exact="global.$gate_queue.{$gate}.{1}.size"/>
      </do_if>
      <set_value name="$queue_distance" operation="add" exact="this.ship.size" comment="current Ship only needs to be acounted for in half"/>
      <transform_position name="$position" refposition="$gate.position" refrotation="$gate.rotation" >
        <position x="0m" y="0m" z="$queue_distance"/>
      </transform_position>
      <!--get_safe_pos result="$safeposition" allowyaxis="true" zone="$gate.zone" value="$position" radius="this.ship.size" ignored="$ignoredobject"/-->
      <!-- move to position in queue/prep pos -->
      
      <!-- HACK for FoO - Albion Gate: Deactivate Collission Avoidance every time to not stick to the unnecesarily magnetic path points -->
      <do_if value="$gate.zone.macro.ismacro.{'Cluster_T_Sector01_Zone001_macro'}">
        <set_avoid_collisions object="this.ship" enabled="false"/>
      </do_if>
      
      <move_to object="this.ship" destination="$gate.zone" forceposition="false" forcerotation="false" finishonapproach="true" abortpath="not $continuepath">
        <position value="$position" />
        <rotation value="$gate.rotation" comment="no need to calculate this because we are behind the Gate"/>
        <interrupt>
          <conditions>
            <check_any>
              <event_object_signalled object="$gate" param="'travel gate update'"/>
              <event_object_signalled object="this.ship" param="'travel gate update'"/>
            </check_any>
          </conditions>
          <actions>
            <do_if value="event.object == this.ship">
              <set_avoid_collisions object="this.ship" enabled="true" comment="re-enable Collision avoidance since we are no longer in queue"/>
              <set_value name="$continuepath" exact="false" comment="disable soft-advancing queue because we just got kicked back"/>
            </do_if>
            <do_elseif value="$continuepath != 2">
              <set_value name="$continuepath" exact="false" comment="disable soft-advancing queue because we didnt sort in in queue yet"/>
            </do_elseif>
            <resume label="fly to prep pos"/>
          </actions>
        </interrupt>
      </move_to>
      <set_value name="$continuepath" exact="2" comment="re-enable soft-advancing queue and also set it persistent"/>
      <set_avoid_collisions object="this.ship" enabled="false" comment="disable collision avoidance while in queue to avoid other ships pushing us out and delaying everything"/>
      <do_if value="$queue_position == 1">
        <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Reached Wait Pos in front of queue - Flying into Gate now.'.[player.age,this.knownname,this.container.knownname,global.$gate_queue,$gate]"/>
        <resume label="pass gate"/>
      </do_if>
      <do_elseif value="this.ship.distanceto.{$gate} lt global.$gate_queue.{$gate}.{$queue_position - 1}.distanceto.{$gate}" comment="we are closer to the Gate than the Ship before us - swap positions to avoid delays">
        <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Reached Wait Pos and Ship in front is farther away than we - swapping pos\nOther Ship: %4; Distance: %5 Our Distance: %6'.[player.age,this.knownname,this.container.knownname,global.$gate_queue.{$gate}.{$queue_position - 1}.name,global.$gate_queue.{$gate}.{$queue_position - 1}.distanceto.{$gate},this.ship.distanceto.{$gate}]"/>
        <set_value name="global.$gate_queue.{$gate}.{$queue_position}" exact="global.$gate_queue.{$gate}.{$queue_position - 1}"/>
        <set_value name="global.$gate_queue.{$gate}.{$queue_position - 1}" exact="this.ship"/>
        <signal_objects object="global.$gate_queue.{$gate}.{$queue_position}" param="'travel gate update'" comment="queue changed - signal the Ship we just changed positions with specifically"/>
        <resume label="fly to prep pos"/>
      </do_elseif>
      <do_else>
        <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Reached Wait Pos and Ship in front is closer than we - waiting\nOther Ship: %4; Distance: %5 Our Distance: %6'.[player.age,this.knownname,this.container.knownname,global.$gate_queue.{$gate}.{$queue_position - 1}.name,global.$gate_queue.{$gate}.{$queue_position - 1}.distanceto.{$gate},this.ship.distanceto.{$gate}]"/>
        <wait max="5min" comment="just in case the Signal doesnt trigger properly">
        <interrupt>
          <conditions>
            <!--check_any-->
              <event_object_signalled object="$gate" param="'travel gate update'"/>
              <!--event_object_arrived_at_waypoint object="this.ship" lastwaypoint="true"/>
            </check_any-->
          </conditions>
          <actions>
            <!-- this has some odd side-effects - use at own risk
            <do_if value="event.name == 'event_object_arrived_at_waypoint'">
              <set_flight_control_model object="this.ship" flightcontrolmodel="flightcontrolmodel.linear"/>
            </do_if>
            -->
            <resume label="fly to prep pos"/>
          </actions>
        </interrupt>
        </wait>
        <resume label="fly to prep pos" comment="Queue got shorter - advance"/>
      </do_else>
      
      <label name="pass gate"/>
      <!-- check the Vanilla Gate Blocking Mechanism and (aggresively!) wait till its free -->
      <request_gate ship="this.ship" gate="$gate" result="$success" />
      <set_value name="$RequestingTimeout" min="player.age + 2min" max="player.age + 5min"/>
      <do_while value="global.$gate_queue.{$gate}.indexof.{this.ship} gt 1 and not $success">
        <wait min="3s" max="8s" comment="aggresive gate polling, but only one Ship at the same time.">
          <interrupt>
            <conditions>
              <event_object_signalled object="$gate" param="'travel gate update'"/>
            </conditions>
          </interrupt>
        </wait>
        <!-- try again locking the Gate if timeout not reached yet -->
        <do_if value="player.age lt $RequestingTimeout">
          <request_gate ship="this.ship" gate="$gate" result="$success" />
        </do_if>
        <do_else>
          <set_value name="$success" exact="true"/>
        </do_else>
      </do_while>
      
      <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Passing Gate'.[player.age,this.name,this.container.name]"/>
      
      <do_if value="this.ship == player.ship">
        <!-- cache Assets of destination if player is on board to make transition smooth -->
        <precache_hint zone="$gate.destination"/>
      </do_if>
      
      <set_value name="$moveintogate" exact="true" />
      <signal_objects object="$gate" param="'travel gate update'" delay="100ms" comment="speed up process by telling everyone to advance to the next wait pos"/>
      <signal_objects object="this.ship" param="'travel gate start'" comment="Signalling we are now passing the Gate (used by DO for Drone Recall)"/>
      <move_gate object="this.ship" gate="$gate" abortpath="false">
        <interrupt>
          <conditions>
            <event_object_changed_cluster object="this.ship" />
          </conditions>
          <actions>
            <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 just changed from cluster %4 to cluster %5 (moved through gate)'.[player.age,this.name,this.container.name,$gate.zone.knownname,event.param2.knownname, event.param.knownname]"/>
            <set_value name="$moveintogate" exact="false" />
          </actions>
        </interrupt>
        <on_attentionchange>
          <do_if value="this.ship.attention == attention.visible">
            <warp object="this.ship" zone="this.zone">
              <rotation value="$gate.rotation"/>
              <position object="this.ship"/>
            </warp>
          </do_if>
        </on_attentionchange>
      </move_gate>
      <do_if value="$moveintogate">
        <wait>
          <interrupt>
            <conditions>
              <event_object_changed_cluster object="this.ship" />
            </conditions>
            <actions>
              <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 just changed from cluster %4 to cluster %5 (wait)'.[player.age,this.name,this.container.name,$gate.zone.knownname,event.param2.knownname, event.param.knownname]"/>
            </actions>
          </interrupt>
          <on_attentionchange>
            <do_if value="this.ship.attention == attention.visible">
              <warp object="this.ship" zone="this.zone">
                <rotation value="$gate.rotation"/>
                <position object="this.ship"/>
             </warp>
            </do_if>
          </on_attentionchange>
        </wait>
      </do_if>
      <set_avoid_collisions object="this.ship" enabled="true" comment="restore collision avoidance behavior after Gate Passage"/>
      
      <!-- unlock Gate (Vanilla) and remove ourselves from the Waiting List, signal the next to go/prepare (UT CAC) -->
      <request_gate ship="this.ship" gate="$gate" unlock="true" result="$result"/>
      <do_if value="global.$gate_queue.{$gate}.{1}? and global.$gate_queue.{$gate}.{1} == this.ship">
        <remove_value name="global.$gate_queue.{$gate}.{1}"/>
      </do_if>
      <do_else>
        <debug_text filter="error" text="'%1 %2 %3 Just passed the Gate and wanted to clear queue, but our Position was not 1 but %4'.[player.age,this.name,this.container.name,global.$gate_queue.{$gate}.indexof.{this.ship}]"/>
        <remove_value name="global.$gate_queue.{$gate}.{global.$gate_queue.{$gate}.indexof.{this.ship}}"/>
        <do_if value="global.$gate_queue.{$gate}.indexof.{this.ship}">
          <debug_text filter="error" text="'And also %1'.[global.$gate_queue.{$gate}.indexof.{this.ship}]"/>
          <remove_value name="global.$gate_queue.{$gate}.{global.$gate_queue.{$gate}.indexof.{this.ship}}"/>
          <do_if value="global.$gate_queue.{$gate}.indexof.{this.ship}">
            <debug_text filter="error" text="'And also %1 (2nd additional check)'.[global.$gate_queue.{$gate}.indexof.{this.ship}]"/>
            <remove_value name="global.$gate_queue.{$gate}.{global.$gate_queue.{$gate}.indexof.{this.ship}}"/>
            <do_if value="global.$gate_queue.{$gate}.indexof.{this.ship}">
              <debug_text filter="error" text="'And also %1 (last check)'.[global.$gate_queue.{$gate}.indexof.{this.ship}]"/>
              <remove_value name="global.$gate_queue.{$gate}.{global.$gate_queue.{$gate}.indexof.{this.ship}}"/>
            </do_if>
          </do_if>
        </do_if>
      </do_else>
      <signal_objects object="$gate" param="'travel gate update'"/>
      <signal_objects object="this.ship" param="'travel completed'"/>
      
      <!--  move forward a bit to clear gate exit for the next ship (rate can be one ship every 30s with this Script)  -->
      <do_if value="$cleargate" comment=" and this.ship.pilot.skill.navigation ge 2">
        <!--wait exact="100ms" comment="otherwise the player.ship skips movement for some reason"/-->
        <transform_position name="$position" refposition="this.ship.position" refrotation="this.ship.rotation" >
          <position x="0m" y="0m" z="(this.ship.size *6)"/>
        </transform_position>
        <!-- figure out an arrival position in the target zone -->
        <!-- HACK for FoO - AL Gate - ignore the big rock instead of the current ship for safepos -->
        <do_if value="this.zone.macro.ismacro.{'Cluster_T_Sector01_Zone001_macro'}">
          <find_object name="$ignoredobject" space="this.zone" macro="macro.landmarks_unique_the_mace_macro"/>
        </do_if>
        <do_else>
          <set_value name="$ignoredobject" exact="this.ship"/>
        </do_else>
        <get_safe_pos result="$safeposition" allowyaxis="true" zone="this.zone" value="$position" radius="this.ship.size" ignored="$ignoredobject" min="this.ship.size*2"/>
        <move_to object="this.ship" destination="this.zone"><!-- forcesteering="true" finishonapproach="true" boost="this.ship.pilot.skill.navigation ge 3"-->
          <position value="$safeposition"/>
          <interrupt_after_time time="0s"/>
        </move_to>
        <do_if value="this.ship.attention ge attention.visible">
          <set_flight_control_model object="this.ship" flightcontrolmodel="flightcontrolmodel.linear"/>
        </do_if>
        <wait exact="20s"/>
      </do_if>
      <set_to_default_flight_control_model object="this.ship"/>
      <set_value name="this.$mayabortpath" comment="tell following movement Script that the remainder of the Path is irrelevant"/>
      
      <!-- un-register from Passage Group to allow the Leader to continue -->
      <remove_from_group group="$passage_group" object="this.ship"/>
      
      <!-- wait till everyone in Group has passed the Gate (unregistered from Group) -->
      <do_if value="not $leader">
        <do_while value="$passage_group.count">
          <wait max="1min" comment="fallback: re-check regulary">
            <interrupt>
              <conditions>
                <event_object_signalled object="this.ship" param="'preparegroup shrunk'"/>
              </conditions>
            </interrupt>
          </wait>
        </do_while>
      </do_if>
      <do_else>
        <signal_objects object="$leader" param="'preparegroup shrunk'"/>
        <do_while value="$passage_group.count">
          <wait max="1min" comment="fallback: re-check regulary">
            <interrupt>
              <conditions>
                <event_object_signalled object="$leader" param="'preparegroup shrunk'"/>
              </conditions>
            </interrupt>
          </wait>
        </do_while>
      </do_else>
    </actions>
  </attention>
  <on_abort>
    <!-- remove ourselves from the waiting List if we are in it and signal everyone the Queue has been changed-->
    <do_if value="global.$gate_queue.{$gate}.indexof.{this.ship}">
      <remove_value name="global.$gate_queue.{$gate}.{global.$gate_queue.{$gate}.indexof.{this.ship}}"/>
      <do_if value="global.$gate_queue.{$gate}.indexof.{this.ship}">
        <debug_text filter="error" text="'%1 %2 %3 Abort Case Occuied mote than one queue Slot, additional one: %4'.[player.age,this.name,this.container.name,global.$gate_queue.{$gate}.indexof.{this.ship}]"/>
        <remove_value name="global.$gate_queue.{$gate}.{global.$gate_queue.{$gate}.indexof.{this.ship}}"/>
        <do_if value="global.$gate_queue.{$gate}.indexof.{this.ship}">
          <debug_text filter="error" text="'And also %1 (2nd check)'.[global.$gate_queue.{$gate}.indexof.{this.ship}]"/>
          <remove_value name="global.$gate_queue.{$gate}.{global.$gate_queue.{$gate}.indexof.{this.ship}}"/>
          <do_if value="global.$gate_queue.{$gate}.indexof.{this.ship}">
            <debug_text filter="error" text="'And also %1 (last check)'.[global.$gate_queue.{$gate}.indexof.{this.ship}]"/>
            <remove_value name="global.$gate_queue.{$gate}.{global.$gate_queue.{$gate}.indexof.{this.ship}}"/>
          </do_if>
        </do_if>
      </do_if>
      <signal_objects object="$gate" param="'travel gate update'"/>
    </do_if>
    <!-- also unblock the Vanilla mechanic -->
    <request_gate ship="this.ship" gate="$gate" unlock="true" result="$result"/>
    <!-- reset FCM to default -->
    <set_to_default_flight_control_model object="this.ship"/>
    <!-- signal our followers to stop -->
    <signal_objects object="this.ship" param="'travel aborted'"/>
    <!-- remove from Passage Group -->
    <remove_from_group group="$passage_group" object="this.ship"/>
    <!-- restore collision avoidance behavior -->
    <set_avoid_collisions object="this.ship" enabled="true"/>
  </on_abort>
</aiscript>