<?xml version="1.0" encoding="UTF-8"?>
<aiscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="ut.cac.orders.tradeagent.default" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd">
  <!-- this is both an Order and an Order Source Script to keep things simple -->
  <params>
    <param name="params" comment="Persistent Params Table to keep track of what should be done and when"/>
  </params>
  <init>
  </init>
  <interrupts>
    <handler comment="handler for passing over tradeagent functionality to someone else">
      <conditions>
        <event_object_signalled object="this.container" param="'trade agent handover'"/>
      </conditions>
      <actions>
        <set_value name="this.$ut_cac.$defaultorders" exact="table[$script='ut.cac.orders.endlesswait']"/>
        <signal_objects object="event.param2" param="'trade agent handover'" param2="'ready for takeover'"/>
        <return/>
      </actions>
    </handler>
  </interrupts>
  <attention min="unknown">
    <actions>
      <do_if value="$params.$isorder?">
        <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 Starting Job as Trade Agent'.[this.name,this.container.name]"/>
        <add_trade_subscription object="this.container"/>
        <wait exact="24h">
          <interrupt>
            <conditions>
              <event_object_signalled object="this" param="'new order received'"/>
            </conditions>
            <actions>
              <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 Received new Order - Exiting (Trade Agent specific Case)'.[this.name,this.container.name]"/>
              <remove_trade_subscription object="this.container"/>
              <return/>
            </actions>
          </interrupt>
        </wait>
        <debug_text filter="general" text="'%1 %2 Wait ended - remove trade subscription temporarily'.[this.name,this.container.name]"/>
        <remove_trade_subscription object="this.container"/>
      </do_if>
      <do_elseif value="not this.container.hastradesubscription">
        <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 Called for defaultorders and giving Order'.[this.name,this.container.name]"/>
        <set_value name="$order" exact="$params.clone"/>
        <set_value name="$order.$isorder"/>
        <set_value name="$order.$displayname" exact="'Monitoring Trades'"/>
        <signal_objects object="this" param="'new order'" param2="$order"/>
      </do_elseif>
      <do_else>
        <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 Called for defaultorders and wait for assignment (trade subscription already present)'.[this.name,this.container.name]"/>
        <signal_objects object="this" param="'new order'" param2="table[$script='ut.cac.microorder',$displayname={5554103,20006},$order='wait order',$time=10h,$interruptable=true]"/>
      </do_else>
    </actions>
  </attention>
  <on_abort>
    <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 Stopping Job as Trade Agent (abort case)'.[this.name,this.container.name]"/>
    <remove_trade_subscription object="this.container"/>
  </on_abort>
</aiscript>
