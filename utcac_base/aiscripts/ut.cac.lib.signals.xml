<?xml version="1.0" encoding="UTF-8"?>
<aiscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="ut.cac.lib.signals" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd">
<!--

rewritten from scratch by UniTrader

Contains all Signal Handlers used in multiple Places:

=> Library for Signal Handlers to follow a certain Object. Must be saved as $object in main Script (NOTE: Name may change during further Development!!! )
Vars used internally:
> $object => the Object to follow
> $fly_to_leader => Set this Var during initial Movement to de-activate the Signal Handlers (until the Ship has same Zone Context as the Leader)
> $follow_position => used temporarily to determine a Safe Position during certain Signals - do not use!
Labels used:
> start => Object moved to last Target Pos and Leader is in same Zone - usually wait for next Movement Signal after this (Label Name may change in further Development!!!!)

-->
  <interrupts>
    <library>
      <handler name="ut_cac_follow_signalling" comment="Handler for Navigation Signals">
        <conditions>
          <check_all>
            <check_any>
              <check_all>
                <event_object_signalled object="$object" param="'travel dockat'"/>
                <check_value value="this.ship.zone ==  $object.zone"/><!-- make sure we are in the same Zone before attempting slow-boating to leader destination... -->
              </check_all>
              <check_all>
                <event_object_signalled object="$object" param="'travel normal start'"/>
                <check_value value="this.ship.zone ==  $object.zone"/><!-- make sure we are in the same Zone before attempting slow-boating to leader destination... -->
              </check_all>
              <check_all>
                <event_object_signalled object="$object" param="'travel boost prep'"/>
                <check_value value="this.ship.sector ==  $object.sector"/><!-- make sure both Ships are in the same sectors... -->
              </check_all>
              <check_all>
                <event_object_signalled object="$object" param="'travel jump prep'"/>
                <check_value value="this.ship.jumpcostto.{event.param2} le $object.jumpcostto.{event.param2}"/><!-- make sure we dont skip needed Jumps on the way... -->
              </check_all>
              <check_all>
                <event_object_signalled object="$object" param="'travel gate prep'"/>
                <check_value value="this.ship.zone ==  event.param2.{1}.zone"/><!-- make sure we are in the Gate Zone before attempting Passage... -->
              </check_all>
              <check_all>
                <event_object_signalled object="$object" param="'travel aborted'"/>
              </check_all>
            </check_any>
            <check_value value="not $fly_to_leader?"/>
          </check_all>
        </conditions>
        <actions>
          <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Signal on Leader received:\nparam: %4 , param2: %5 , param3: %6'.[player.age,this.name,this.container.name,event.param,event.param2,event.param3]"/>
          <do_if value="event.param == 'travel dockat'">
            <do_if value="$follow_position?">
              <debug_text filter="error" text="'%1 %2 %3 $follow_position already set! ( %4 ) Do not use this Var when using ut_cac_follow_signalling!!! Overriding Var!'.[ player.age,this.name,this.container.name,$follow_position]"/>
            </do_if>
            <!-- Leader attempts to Dock somewhere - Fly to near position outside Bounding Box -->
            <create_position_outside_boundingbox name="$follow_position" component="event.param2.{1}" distance="this.ship.size">
              <position value="event.param2.{3}"/>
            </create_position_outside_boundingbox>
            <get_safe_pos result="$follow_position" radius="this.ship.size" allowyaxis="true" value="$follow_position" ignored="this.ship" zone="event.param2.{1}.zone" min="$object.size * 2"/>
            <run_interrupt_script name="'ut.cac.move.to.pos'" resume="start" abortscripts="true">
              <param name="destination" value="event.param2.{1}.zone"/>
              <param name="position" value="$follow_position"/>
            </run_interrupt_script>
            <remove_value name="$follow_position"/>
          </do_if>
          <do_elseif value="event.param == 'travel normal start'">
            <!-- interrupt with regular Travel script -->
            <run_interrupt_script name="'ut.cac.move.to.pos'" resume="start" abortscripts="true">
              <param name="destination" value="event.param2.{1}"/>
              <param name="position" value="event.param2.{2}"/>
              <param name="rotation" value="event.param2.{3}"/>
              <param name="leader" value="$object"/>
              <param name="leader_preparegroup" value="event.param3"/>
            </run_interrupt_script>
          </do_elseif>
          <do_elseif value="event.param == 'travel boost prep'">
            <!-- interrupt with boost script -->
            <run_interrupt_script name="'ut.cac.move.boost'" resume="start" abortscripts="true">
              <param name="destination" value="event.param2.{1}"/>
              <param name="position" value="event.param2.{2}"/>
              <param name="leader_startposition" value="event.param2.{3}"/>
              <param name="leader_startrotation" value="event.param2.{4}"/>
              <param name="leader" value="$object"/>
              <param name="leader_preparegroup" value="event.param3"/>
            </run_interrupt_script>
          </do_elseif>
          <do_elseif value="event.param == 'travel jump prep'">
            <!-- interrupt with jump script -->
            <run_interrupt_script name="'ut.cac.move.jump'" resume="start" abortscripts="true">
              <param name="destination" value="event.param2"/>
              <param name="type" value="'object'"/>
              <param name="leader" value="$object"/>
              <param name="leader_preparegroup" value="event.param3"/>
            </run_interrupt_script>
          </do_elseif>
          <do_elseif value="event.param == 'travel gate prep'">
            <!-- interrupt with Gate Passage script -->
            <run_interrupt_script name="'ut.cac.move.gate2'" resume="start" abortscripts="true">
              <param name="gate" value="event.param2.{1}"/>
              <param name="queue_position" value="event.param2.{2}"/>
              <param name="passage_group" value="event.param3"/>
              <param name="leader" value="$object"/>
            </run_interrupt_script>
          </do_elseif>
          <do_elseif value="event.param == 'travel aborted'">
            <abort_called_scripts resume="start"/>
          </do_elseif>
        </actions>
      </handler>
      <handler name="ut_cac_exitonneworder" comment="Handler for exiting current Script when a new Order is received">
        <conditions>
          <event_object_signalled object="this" param="'new order received'"/>
          <check_value value="$exitonneworder and this.$orderlist.{$exitonneworder}?"/>
        </conditions>
        <actions>
          <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Received new Order - Exiting (interrupt case)'.[player.age,this.name,this.container.name]"/>
          <abort_called_scripts resume="finish"/>
        </actions>
      </handler>
    </library>
  </interrupts>
</aiscript>
