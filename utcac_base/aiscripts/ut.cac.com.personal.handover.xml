<?xml version="1.0" encoding="UTF-8"?>
<aiscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="ut.cac.com.personal.handover" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd" version="1">
  <!--
  This Script is intended to Pass the control function to another NPC who is ready to take over. 
  Intended to be executed asap, will send existing Settings and Sheduled Orders for fluent Takeover.
  If there is another Job after this also shedule ut.cac.com.personal.transfer after this. (will be kept for current Entity, all others will be passed to successor)
  -->
  <params>
    <param name="params" default="false" comment="pass a single Table filled with the wanted param Values here to make calls via list possible (always has priority)"/>
    <param name="successor" default="false" comment="Replacement NPC to be signalled when ready"/>
  </params>
  <init>
      <!-- first decode the $params to the Variables -->
      <do_if value="$params">
        <do_if value="$params.$successor?">
          <set_value name="$successor" exact="$params.$successor"/>
        </do_if>
      </do_if>
  </init>
  <interrupts>
  </interrupts>
  <attention min="unknown">
    <actions>
      <!-- Validate Input -->
      <do_if value="not $successor.exists">
        <debug_text filter="error" text="'%1 %2 Successor does not exist - aborting!'.[this.name,this.container.name]"/>
        <return/>
      </do_if>
      
      <!-- Prepare Orderlist for Successor - successor shall perform all remaining Orders except Transfer ones -->
      <set_value name="$old_orderlist" exact="this.$orderlist"/>
      <remove_value name="$old_orderlist.{1}"/>
      <set_value name="this.$orderlist" exact="[$params]"/>
      <do_all exact="$old_orderlist.count" counter="$i" reverse="true">
        <do_if value="$old_orderlist.{$i}.$script == 'ut.cac.com.personal.transfer'">
          <set_value name="$new_orderlist.{1}" operation="insert" exact="$old_orderlist.{$i}"/>
          <remove_value name="$old_orderlist.{$i}"/>
        </do_if>
      </do_all>
      
      <!-- prepare new Settings for Employee - start from Scratch -->
      <set_value name="$old_settings" exact="this.$ut_cac"/>
      <set_value name="this.$ut_cac" exact="table[]"/>
      
      <!-- Ending current Job -->
      <do_if value="this.ship.pilot == this">
        <dismiss_pilot object="this.ship"/>
        <stop_moving object="this.ship" immediate="true"/>
        <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 Stop working as Pilot'.[this.name,this.container.name]"/>
      </do_if>
      <!--do_if value="this.container.defencenpc == this">
        <cease_fire object="this.container"/>
        <dismiss_control_entity object="this.container" actor="this"/>
        <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 Stop working as DO - removing oneself for now!!!'.[this.name,this.container.name]"/>
        <!- - ToDo: Find out how to properly dismiss DO and remove the following Lines - ->
        <signal_objects object="$successor" param="'ready for takeover'" param2="$old_orderlist" param3="$old_settings"/>
        <signal_objects object="player.galaxy" param="'clone actor'" param2="this" param3="this.room.parent"/>
        <start_actor_transport actor="this"/>
      </do_if-->
      <do_elseif value="this.container.defencenpc == this or this.container.engineer == this">
        <dismiss_control_entity object="this.container" actor="this"/>
        <!--start_actor_transport actor="this" target="this.room.parent"/-->
        <debug_text filter="general" chance="@this.$debug * 100 *0 +100" text="'%1 %2 Stop working as other Controlentity - clone+destroy'.[this.name,this.container.name]"/>
        <!--signal_objects object="player.galaxy" param="'clone actor'" param2="this" param3="this.room.parent"/>
        <wait exact="100ms"/>
        <destroy_object object="this"/-->
      </do_elseif>
      
      <!-- Wait for new Assignment -->
      <remove_value name="this.$ut_cac.$orders_section" comment="no Orders until new Assignment!"/>
      <remove_value name="this.$ut_cac.$settings_section" comment="no Settings until new Assignment!"/>
      <set_value name="this.$ut_cac.$defaultorders" exact="table[$script='ut.cac.orders.endlesswait']" comment="failsafe in case something goes wrong"/>
      <set_entity_type entity="this" type="entitytype.recruitment"/>
      
      <!-- Transfer Leftover Money to successor -->
      <transfer_money from="this" to="$successor" amount="this.money"/>
      <remove_actor_account actor="this"/>
      
      <!-- Signal new Employee for Takeover -->
      <signal_objects object="$successor" param="'ready for takeover'" param2="$old_orderlist" param3="$old_settings"/>
      
      <!-- Use new Settings -->
      
    </actions>
  </attention>
</aiscript>
