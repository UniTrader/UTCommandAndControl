<?xml version="1.0" encoding="UTF-8"?>
<aiscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="ut.cac.com.personal.handover" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd" version="1">
  <!--
  This Script is intended to Pass the control function to another NPC who is ready to take over. 
  Intended to be executed asap, will send existing Settings and Sheduled Orders for fluent Takeover.
  -->
  <params>
    <param name="params" default="false" comment="pass a single Table filled with the wanted param Values here to make calls via list possible (always has priority)"/>
    <param name="successor" default="false" comment="Replacement NPC to be signalled when ready"/>
    <param name="new_orderlist" default="false" comment="Orderlist to Execute after this. Current Order List will be replaced."/>
    <param name="new_settings" default="false" comment="Settings to use afte handover. Set to true if a clean Table shall be used and to false to clone the current one (shallow copy except for specific cases like range)"/>
  </params>
  <init>
      <!-- first decode the $params to the Variables -->
      <do_if value="$params">
        <do_if value="$params.$successor?">
          <set_value name="$successor" exact="$params.$successor"/>
        </do_if>
        <do_if value="$params.$new_orderlist?">
          <set_value name="$new_orderlist" exact="$params.$new_orderlist"/>
        </do_if>
        <do_if value="$params.$new_settings?">
          <set_value name="$new_settings" exact="$params.$new_settings"/>
        </do_if>
      </do_if>
  </init>
  <interrupts>
  </interrupts>
  <attention min="unknown">
    <actions>
      <!-- Validate Input -->
      <do_if value="not $successor.exists">
        <debug_text filter="error" text="'%1 %2 Successor does not exist - aborting!'.[this.name,this.container.name]"/>
        <return/>
      </do_if>
      
      <!-- Prepare Orderlist for Successor - successor shall perform all remaining Orders except Transfer ones -->
      <set_value name="$old_orderlist" exact="this.$orderlist"/>
      <do_if value="not $new_orderlist">
        <set_value name="$new_orderlist" exact="[]"/>
      </do_if>
      <do_all exact="$old_orderlist.count" counter="$i" reverse="true">
        <do_if value="$old_orderlist.{$i}.$script == 'ut.cac.com.personal.transfer'">
          <set_value name="$new_orderlist.{1}" operation="insert" exact="$old_orderlist.{$i}"/>
          <remove_value name="$old_orderlist.{$i}"/>
        </do_if>
      </do_all>
      
      <!-- prepare new Settings for Employee - either start from Scratch, or clone all Entries -->
      <set_value name="$old_settings" exact="this.$ut_cac"/>
      <do_if value="$new_settings == true">
        <set_value name="this.$ut_cac" exact="table[]"/>
      </do_if>
      <do_elseif value="$new_settings == false">
        <set_value name="this.$ut_cac" exact="$old_settings.clone"/>
        <do_if value="$old_settings.$range?">
          <set_value name="this.$ut_cac.$range" exact="$old_settings.$range.clone"/>
        </do_if>
        <do_if value="$old_settings.$range_h?">
          <set_value name="this.$ut_cac.$range_h" exact="$old_settings.$range_h.clone"/>
        </do_if>
        <do_if value="$old_settings.$range_j?">
          <set_value name="this.$ut_cac.$range_j" exact="$old_settings.$range_j.clone"/>
        </do_if>
      </do_elseif>
      <do_else>
        <set_value name="this.$ut_cac" exact="$new_settings"/>
      </do_else>
      
      <!-- Signal new Employee for Takeover -->
      <signal_objects object="$successor" param="'ready for takeover'" param2="$old_orderlist" param3="$old_settings"/>
      
      <!-- Use new Settings -->
      
    </actions>
  </attention>
</aiscript>
