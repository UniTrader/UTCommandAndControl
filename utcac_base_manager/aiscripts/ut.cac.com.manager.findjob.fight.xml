<?xml version="1.0" encoding="UTF-8"?>
<aiscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="ut.cac.com.manager.findjob.fight" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd" version="1">
  <params>
    <param name="params" default="false" comment="pass a single Table filled with the wanted param Values here to make calls via list possible (always has priority)"/>
    <param name="entity" default="false" comment="Entity who needs Patrol-Orders (NOT as Ship)"/>
  </params>
  <init>

  </init>
  <interrupts>
  </interrupts>
  <attention min="unknown">
    <actions>
      <do_if value="$params">
        <do_if value="$params.$entity?">
          <set_value name="$entity" exact="$params.$entity"/>
        </do_if>
        <remove_value name="$params"/>
      </do_if>
      
      <!-- Input Validation -->
      <do_if value="not $entity.exists">
        <debug_text filter="error" text="'%1 %2 No Entity passed to give Fight Orders to - aborting'.[this.name,this.container.name]"/>
        <return value="false"/>
      </do_if>
      
      <debug_text filter="general" chance="@this.$debug *100" text="'%1 %2 Finding Patrol for %3'.[this.name,this.container.name,$entity.name]"/>
      
      
      <set_command_action commandaction="commandaction.calculating"/>
      <do_if value="this.$ut_cac?">
        <set_value name="this.$ut_cac.$isactive"/>
      </do_if>
      <wait min="3s" max="5s" />
      
      <!-- find Ship where it makes sense to possibly escort it (only Patrolling Ships to avoid unecesarily deep hierarchies) -->
      <do_if value="this.$ut_cac.$availablefightships.count">
        <do_all min="1" max="this.$ut_cac.$availablefightships.count + 2">
          <set_value name="$testship" exact="this.$ut_cac.$availablefightships.random"/>
          <do_if value="$entity.ship.distanceto.{$testship} le 15km and $testship.pilot.$orderlist.{1}.$script == 'ut.cac.com.captain.patrol'">
            <debug_text filter="general" chance="@this.$debug *100" text="'%1 %2 Will send escorting already Patroling Ship %3'.[this.name,this.container.name,$testship.name]"/>
            <signal_objects object="$entity" param="'new order'" param2="[ table[$script='ut.cac.com.captain.refuel',$displayname={5554103,21006},$undock=2,$interruptable=true] , table[$script='ut.cac.move.escort',$displayname={5554103,21005}.[if $testship.controlentity.$shortname then $testship.controlentity.$shortname else $testship.knownname],$escortee=$testship,$time=if $entity.ship.primarypurpose == objectpurpose.fight then 3h else 30min,$exitonneworder=true,$interruptable=true] ]"/>
            <return value="true"/>
          </do_if>
        </do_all>
      </do_if>
      
      <debug_text filter="general" chance="@this.$debug *100" text="'%1 %2 Will send to Patrol %3'.[this.name,this.container.name,this.zone.name]"/>
      <signal_objects object="$entity" param="'new order'" param2="[ table[$script='ut.cac.com.captain.refuel',$displayname={5554103,21006},$undock=2,$interruptable=true] , table[$script='ut.cac.com.captain.patrol',$displayname={5554103,21002}.[this.zone.knownname],$space=this.zone,$patroltime=if $entity.ship.primarypurpose == objectpurpose.fight then 3h else 30min,$exitonneworder=true,$interruptable=true] ]"/>
      
      <debug_text filter="general" chance="@this.$debug *100" text="'%1 %2 Sent Ship %3 to patrol (locally)'.[this.name,this.container.name,$entity.ship.name]"/>
      <return value="true"/>
    </actions>
  </attention>
</aiscript>
