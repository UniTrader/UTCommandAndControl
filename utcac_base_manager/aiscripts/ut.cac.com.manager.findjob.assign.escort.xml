<?xml version="1.0" encoding="UTF-8"?>
<aiscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="ut.cac.com.manager.findjob.assign.escort" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd" version="1">
  <params>
    <param name="params" default="false" comment="pass a single Table filled with the wanted param Values here to make calls via list possible (always has priority)"/>
    <param name="escortee" default="false" comment="Ship needing Escorts"/>
    <param name="destination" default="false" comment="Destination Space to where the Ship will be escorted to (will check on Zone Context changes)"/>
    <param name="destination_timeout" default="5min" comment="NYI // Planned: How long the ship will continue the Escort after arriving in Destination context (will check on Zone Context changes)"/>
    <param name="timeout" default="player.age + 2h" comment="NYI // Planned: Game Time until when the Ship will be Escorted (will check on Zone Context changes)"/>
    <param name="return_waypoint" default="false" comment="optional: Waypoint to move to first after Escort ended (to account for Range Waypoints)"/>
    <param name="value" default="false" comment="optional: For Trade/Mining Escort Jobs the eventual Value of the Goods Transported - to determine the amount of neccesary Escorts"/>
  </params>
  <init>

  </init>
  <interrupts>
  </interrupts>
  <attention min="unknown">
    <actions>
      <do_if value="$params">
        <do_if value="$params.$escortee?">
          <set_value name="$escortee" exact="$params.$escortee"/>
        </do_if>
        <do_if value="$params.$destination?">
          <set_value name="$destination" exact="$params.$destination"/>
        </do_if>
        <do_if value="$params.$destination_timeout?">
          <set_value name="$destination_timeout" exact="$params.$destination_timeout"/>
        </do_if>
        <do_if value="$params.$timeout?">
          <set_value name="$timeout" exact="$params.$timeout"/>
        </do_if>
        <do_if value="$params.$return_waypoint?">
          <set_value name="$return_waypoint" exact="$params.$return_waypoint"/>
        </do_if>
        <do_if value="$params.$value?">
          <set_value name="$value" exact="$params.$value"/>
        </do_if>
      </do_if>
      
      
      <debug_text filter="general" chance="100" text="'%1 %2 %3 Script started; escortee: %4 destination: %5 return Waypoint: %6 Value: %7'.[player.age,this.name,this.container.name,$escortee,$destination,$return_waypoint,$value]"/>
      
      <!-- get available Ships -->
      
      <set_value name="$availableships" exact="this.$ut_cac.$availablefightships.list.clone"/>
      
      <!-- get escortee Value and add fight Shipsto escort duty until their Value is at least half the Ware Value -->
      <set_value name="$isvalue" exact="$escortee.value"/>
      
      <debug_text filter="general" chance="100" text="'%1 %2 %3 Ship Value: %4, Availableships: %5'.[player.age,this.name,this.container.name,$isvalue,$availableships]"/>
      <do_if value="not $availableships.count" comment="no Ships available for Escorts - exiting to prevent debug errors">
        <return/>
      </do_if>
      
      
      <do_all exact="[($availableships.count / 3 + 1)i,5].min">
        <set_value name="$ship" exact="$availableships.random"/>
        <do_if value="$ship.pilot.$orderlist.count gt 1">
         <debug_text filter="general" chance="100" text="'%1 %2 %3 Ship %4 has a too long orderlist - removing'.[player.age,this.name,this.container.name, $ship.knownname,$ship.pilot.$orderlist]"/>
          <remove_value name="$availableships.{$availableships.indexof.{$ship}}"/>
          <continue/>
        </do_if>
        <set_value name="$isvalue" exact="$ship.value" operation="add"/>
        <debug_text filter="general" chance="100" text="'%1 %2 %3 Assigned %4 Ship Value: %5 isvalue: %6'.[player.age,this.name,this.container.name, $ship.knownname,$ship.value,$isvalue]"/>
        <signal_objects object="$ship.pilot" param="'new order'" param2="table[$script='ut.cac.move.escort',$object=$escortee,$destination=$destination]"/>
        <do_if value="$return_waypoint">
          <signal_objects object="$ship.pilot" param="'new order'" param2="table[$script='ut.cac.move.generic',$destination=$return_waypoint,$endintargetspace=true,$exitonneworder=true]"/>
        </do_if>
        
        <remove_value name="$availableships.{$availableships.indexof.{$ship}}"/>
      </do_all>
      
      </actions>
  </attention>
</aiscript>
