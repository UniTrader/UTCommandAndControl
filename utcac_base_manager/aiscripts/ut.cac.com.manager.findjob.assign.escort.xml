<?xml version="1.0" encoding="UTF-8"?>
<aiscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="ut.cac.com.manager.findjob.assign.escort" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd" version="1">
  <params>
    <param name="params" default="false" comment="pass a single Table filled with the wanted param Values here to make calls via list possible (always has priority)"/>
    <param name="escortee" default="false" comment="Ship needing Escorts"/>
    <param name="destination" default="false" comment="Destination Space to where the Ship will be escorted to (will check on Zone Context changes)"/>
    <param name="destination_timeout" default="5min" comment="NYI // Planned: How long the ship will continue the Escort after arriving in Destination context (will check on Zone Context changes)"/>
    <param name="timeout" default="player.age + 2h" comment="NYI // Planned: Game Time until when the Ship will be Escorted (will check on Zone Context changes)"/>
    <param name="return_waypoint" default="false" comment="optional: Waypoint to move to first after Escort ended (to account for Range Waypoints)"/>
    <param name="value" default="false" comment="optional: For Trade/Mining Escort Jobs the eventual Value of the Goods Transported - to determine the amount of neccesary Escorts"/>
  </params>
  <init>

  </init>
  <interrupts>
  </interrupts>
  <attention min="unknown">
    <actions>
      <do_if value="$params">
        <do_if value="$params.$escortee?">
          <set_value name="$escortee" exact="$params.$escortee"/>
        </do_if>
        <do_if value="$params.$destination?">
          <set_value name="$destination" exact="$params.$destination"/>
        </do_if>
        <do_if value="$params.$destination_timeout?">
          <set_value name="$destination_timeout" exact="$params.$destination_timeout"/>
        </do_if>
        <do_if value="$params.$timeout?">
          <set_value name="$timeout" exact="$params.$timeout"/>
        </do_if>
        <do_if value="$params.$return_waypoint?">
          <set_value name="$return_waypoint" exact="$params.$return_waypoint"/>
        </do_if>
        <do_if value="$params.$value?">
          <set_value name="$value" exact="$params.$value"/>
        </do_if>
      </do_if>
      
      
      <debug_text filter="general" chance="100" text="'%1 %2 Script started; escortee: %3 destination: %4 return Waypoint: %5 Value: %6'.[this.name,this.container.name,$escortee.name,$destination,$return_waypoint,$value]"/>
      
      <!-- Ignore Small Ships for now -->
      <do_if value="$escortee.isclass.ship_xs or $escortee.isclass.ship_s or $escortee.isclass.ship_m">
        <return/>
      </do_if>
      
      <!-- get available Ships -->
      <set_value name="$availableships" exact="this.$ut_cac.$availablefightships.list.clone"/>
      
      <debug_text filter="general" chance="100" text="'%1 %2 Availableships: \n%3\n%4'.[this.name,this.container.name,$availableships,this.$ut_cac.$availablefightships]"/>
      <do_if value="not $availableships.count" comment="no Ships available for Escorts - exiting to prevent debug errors">
        <return/>
      </do_if>
      
      <do_if value="global.$ship_boost_speed.{$escortee.macro}?">
        <set_value name="$escortee_speed" exact="global.$ship_boost_speed.{$escortee.macro}"/>
      </do_if>
      <do_else>
        <debug_text filter="general" chance="100" text="'%1 %2 No Boost Speed known for this Ship - skipping comparisions (should sort itself out quickly)'.[this.name,this.container.name]"/>
      </do_else>
      
      <set_value name="$wantedescorts" exact="1" comment="for now only one Escort per Ship, will tune later as needed"/>
      <set_value name="$escortcount" exact="0"/>
      
      <do_while value="$availableships.count and $escortcount lt $wantedescorts">
        <set_value name="$ship" exact="$availableships.random"/>
        <do_if value="$ship.pilot.$orderlist.count gt 1">
         <debug_text filter="general" chance="100" text="'%1 %2 Ship %3 has a too long orderlist - removing'.[this.name,this.container.name, $ship.knownname,$ship.pilot.$orderlist]"/>
          <remove_value name="$availableships.{$availableships.indexof.{$ship}}"/>
          <continue/>
        </do_if>
        <do_if value="$escortee_speed? and global.$ship_boost_speed.{$ship.macro}?">
          <!-- check if the Speed difference would be too great (max 100 m/s) and ignore if it is -->
          <do_if value="( $escortee_speed - global.$ship_boost_speed.{$ship.macro} ) lt -110m">
            <debug_text filter="general" chance="100" text="'%1 %2 Ship %3 is too fast ( %4ms vs %5ms , %6ms diff) - removing'.[this.name,this.container.name, $ship.knownname,$escortee_speed,global.$ship_boost_speed.{$ship.macro}, $escortee_speed - global.$ship_boost_speed.{$ship.macro}]"/>
            <remove_value name="$availableships.{$availableships.indexof.{$ship}}"/>
            <continue/>
          </do_if>
          <do_elseif value="( $escortee_speed - global.$ship_boost_speed.{$ship.macro} ) gt 110m">
            <debug_text filter="general" chance="100" text="'%1 %2 Ship %3 is too slow ( %4ms vs %5ms , %6ms diff ) - removing'.[this.name,this.container.name, $ship.knownname,$escortee_speed,global.$ship_boost_speed.{$ship.macro}, $escortee_speed - global.$ship_boost_speed.{$ship.macro}]"/>
            <remove_value name="$availableships.{$availableships.indexof.{$ship}}"/>
            <continue/>
          </do_elseif>
          <do_else>
            <debug_text filter="general" chance="100" text="'%1 %2 Ship %3 meets speed range criterion ( %4ms vs %5ms , %6ms diff )'.[this.name,this.container.name, $ship.knownname,$escortee_speed,global.$ship_boost_speed.{$ship.macro}, $escortee_speed - global.$ship_boost_speed.{$ship.macro}]"/>
          </do_else>
        </do_if>
        <do_else>
          <debug_text filter="general" chance="100" text="'%1 %2 No Boost Speed known for Other Ship %3 - assuming it is suitable for now (should sort itself out quickly)'.[this.name,this.container.name, $ship.knownname]"/>
        </do_else>
        <debug_text filter="general" chance="100" text="'%1 %2 Assigned %3'.[this.name,this.container.name, $ship.knownname]"/>
        <signal_objects object="$ship.pilot" param="'new order'" param2="table[$displayname='\033REscorting %1 (Manager)'.[if $escortee.controlentity.$shortname then $escortee.controlentity.$shortname else $escortee.name],$script='ut.cac.move.escort',$escortee=$escortee,$destination=$destination,$interruptable=true]"/>
        <do_if value="$return_waypoint">
          <signal_objects object="$ship.pilot" param="'new order'" param2="table[$script='ut.cac.move.generic',$destination=$return_waypoint,$endintargetspace=true,$exitonneworder=true]"/>
        </do_if>
        <set_value name="$escortcount" operation="add"/>
        <remove_value name="$availableships.{$availableships.indexof.{$ship}}"/>
      </do_while>
      
      </actions>
  </attention>
</aiscript>
