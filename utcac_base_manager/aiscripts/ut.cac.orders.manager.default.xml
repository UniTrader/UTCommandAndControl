<?xml version="1.0" encoding="UTF-8"?>
<aiscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="ut.cac.orders.manager.default" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd">
  <params>
    <param name="params" comment="Persistent Params Table to keep track of what should be done and when"/>
  </params>
  <attention min="unknown">
    <actions>
      
      <!-- Set up Persistent Vars needed by this Script -->
      <!--immediately allow Zone Trading and Mining -->
      <do_if value="not $params.$next_zonetrade?">
        <set_value name="$next_zonetrade" exact="player.age"/>
      </do_if>
      <do_if value="not $params.$next_miningstep?">
        <set_value name="$next_miningstep" exact="player.age"/>
      </do_if>
      <do_if value="not $params.$next_offerupdate?">
        <set_value name="$next_offerupdate" exact="player.age"/>
      </do_if>
      
      <!-- register Subordinates - see event Handlers for actual adding procedure -->
      <!-- ToDo: Externalize to MD - not really fitting in here!! - i think its done there now, therefor commented out -->
      <!--do_all exact="this.container.subordinates.{this.type}.count" counter="$i">
        <signal_objects object="this" param="this.container.subordinates.{this.type}.{$i}" param2="'register subordinate'" />
        <wait exact="1ms"/>
      </do_all-->
      
      <!-- Look up what Orders makes sense and append to Orderlist -->
      
      <!-- check if we have gasses as ressource and can mine them directly -->
      <do_if value="player.age gt $next_miningstep">
        <create_list name="$mineable_ressources"/>
        <do_all exact="this.container.resources.list.count" counter="$i">
          <set_value name="$ware" exact="this.container.resources.list.{$i}"/>
          <do_if value="$ware.tags.indexof.{tag.minable} and this.container.cargo.{$ware}.count lt this.container.cargo.{$ware}.target and this.zone.yield.indexof.{$ware}">
            <get_resource_gatherrate name="$gatherrate" refobject="this.container" ware="$ware" zone="this.zone" />
            <do_if value="$gatherrate">
              <append_to_list name="$mineable_ressources" exact="$ware"/>
            </do_if>
          </do_if>
        </do_all>
        <do_if value="$mineable_ressources.count">
          <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 Found Mineable Ressources: \n%3'.[this.name,this.container.name,$mineable_ressources]"/>
          <signal_objects object="this" param="'new order'" param2="table[$script='ut.cac.com.manager.gatherressources',$displayname={5554103,25000},$wareslist=$mineable_ressources,$interruptable=true]"/>
          <set_value name="$next_miningstep" exact="player.age + 1min"/>
        </do_if>
        <do_else>
          <set_value name="$next_miningstep" exact="player.age + 10min"/>
        </do_else>
      </do_if>
      
      <!-- wait two Frames to give the Signals time to be executed (if any) in preperation for the Check if there are any Orders to be executed-->
      <wait max="50ms"/>
      <wait max="50ms"/>
      
      <!-- if there is not much else to do and we are assigned to a Station - do Zonetrade (POSSIBLY TIME INTENSIVE) -->
      <do_if value="this.container.isclass.station and ( this.$orderlist.count lt 1 and player.age gt $next_zonetrade and not this.$ut_cac.$currenttrade? )">
        <set_value name="$next_zonetrade" exact="player.age + 7min"/>
        <signal_objects object="this" param="'new order'" param2="table[$script='ut.cac.com.manager.zonetrade',$displayname={5554103,25001},$repeat=false,$interruptable=true]"/>
      </do_if>
      <do_elseif value="this.$ut_cac.$currenttrade?">
        <debug_text filter="general" text="'Trade Values during Zonetrade:\n
exists %1\n
available %2\n
buyer %3\n
seller %4\n
amount %5\n
desiredamount %6\n
offeramount %7\n
offeramount.{$entity} %\n8
transferredamount %9'.[this.$ut_cac.$currenttrade.exists,this.$ut_cac.$currenttrade.available,this.$ut_cac.$currenttrade.buyer,this.$ut_cac.$currenttrade.seller,this.$ut_cac.$currenttrade.amount,this.$ut_cac.$currenttrade.desiredamount %6,this.$ut_cac.$currenttrade.offeramoun,this.$ut_cac.$currenttrade.offeramount{this},this.$ut_cac.$currenttrade.transferredamount]"/>
      </do_elseif>
      
      <!-- wait two Frames to give the Signals time to be executed (if any) in preperation for the Check if there are any Orders to be executed-->
      <wait max="50ms"/>
      <wait max="50ms"/>
      
      <do_if value="this.$orderlist.count == 0">
        <signal_objects object="this" param="'new order'" param2="table[$script='ut.cac.microorder',$displayname={5554103,20005},$order='wait order',$time=1h,$interruptable=true]"/>
      </do_if>
      
      <return/>
      
    </actions>
  </attention>
</aiscript>
