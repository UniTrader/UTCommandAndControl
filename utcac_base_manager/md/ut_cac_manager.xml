<?xml version="1.0" encoding="UTF-8"?>
<mdscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="UT_CAC_Manager" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/md.xsd">
  <cues>
    <cue name="Settings" instantiate="true">
      <conditions>
        <check_any>
          <event_conversation_next_section sectionprefix="comm_manager_settings"/>
          <event_conversation_returned_to_section sectionprefix="comm_manager_settings"/>
        </check_any>
      </conditions>
      <actions>
        <debug_text filter="general" chance="@event.object.$debug * 100" text="'%1 %2 event.name= %3 \nevent.param= %4 event.param2= %5 event.param3= %6'.[event.object.name,event.object.container.name,event.name,event.param,event.param2,event.param3]"/>
        <!--- ################################### -->
        <!--                       Settings Menu                          -->
        <!--- ################################### -->
        <do_if value="event.param == 'comm_manager_settings'">
          <include_actions ref="md.UT_CAC_Lib.Verify_Range"/>
          <do_if value="@$selectedcell.{1} gt event.object.$ut_cac.$range.count + 1">
            <set_value name="$selectedcell.{1}" exact="event.object.$ut_cac.$range.count + 2"/>
            <set_value name="$selectedcell.{2}" exact="5"/>
          </do_if>
          <!-- Range Point Calculation to show how many can be added -->
          <set_value name="$rangecost" exact="param.ut_cac.rangecost"/>
          <!-- apply radar Bonus for all Radar Components -->
          <do_if value="event.object.station.exists">
            <find_object_component name="$radarcount" object="event.object.station" class="class.radar" multiple="true"/>
            <set_value name="$radarcount" exact="$radarcount.count"/>
          </do_if>
          <do_else>
            <set_value name="$radarcount" exact="0"/>
          </do_else>
          <set_value name="$rangepoints" exact="($rangecost.$freepoints + event.object.skill.navigation * $rangecost.$points_per_star) * ( 1 + $radarcount * $rangecost.$radarbonus )"/>
          <do_if value="$rangepoints == 0">
            <debug_text filter="error" text="'%1 %2 $rangepoints has a zero Value  - defaulting to 1'.[event.object.name,event.object.container.name]"/>
            <set_value name="$rangepoints" exact="1"/>
          </do_if>
          <set_value name="$totalrangepoints" exact="$rangepoints"/>
          <!-- doing two passes here - first validating Ranges and nulling wrong entries, then removing null entries - removign them immediately would skip checking a few -->
          <do_all exact="event.object.$ut_cac.$range.count" counter="$i" reverse="false">
            <do_if value="event.object.$ut_cac.$range.{$i}.exists">
              <do_if value="event.object.$ut_cac.$range.{$i}.isclass.{$rangecost.keys.list}">
                <do_if value="$rangepoints ge $rangecost.{event.object.$ut_cac.$range.{$i}.class}">
                  <set_value name="$rangepoints" operation="subtract" exact="$rangecost.{event.object.$ut_cac.$range.{$i}.class}"/>
                </do_if>
                <do_else>
                 <append_to_list name="$removal_message" exact="'%1 removed - not enough Range Points remaining (%2 of %3)'.[event.object.$ut_cac.$range.{$i}.name,$rangepoints,$rangecost.{event.object.$ut_cac.$range.{$i}.class}]"/>
                 <set_value name="event.object.$ut_cac.$range.{$i}" exact="null"/>
                </do_else>
              </do_if>
              <do_else>
                <append_to_list name="$removal_message" exact="'%1 removed - not of recognized Range Class (%2)'.[event.object.$ut_cac.$range.{$i}.name,event.object.$ut_cac.$range.{$i}.class]"/>
                <set_value name="event.object.$ut_cac.$range.{$i}" exact="null"/>
              </do_else>
            </do_if>
            <do_else>
              <append_to_list name="$removal_message" exact="'%1 removed - does not exist'.[event.object.$ut_cac.$range.{$i}.name]"/>
              <set_value name="event.object.$ut_cac.$range.{$i}" exact="null"/>
            </do_else>
          </do_all>
          <do_all exact="event.object.$ut_cac.$range.count" counter="$i" reverse="true">
            <do_if value="event.object.$ut_cac.$range.{$i} == null">
              <remove_value name="event.object.$ut_cac.$range.{$i}"/>
              <remove_value name="event.object.$ut_cac.$range_j.{$i}"/>
              <remove_value name="event.object.$ut_cac.$range_h.{$i}"/>
              <remove_value name="event.object.$ut_cac.$range_w.{$i}"/>
            </do_if>
          </do_all>
          
          
          <!-- Button Reminder: { 'button' , 'button text' [,'next_section' [ ,hotkey  [, selectable [,param [,keepvisible [,notsubsection]]]] ]] } -->
          <set_value name="$genericuiparam" exact="
[ 0 , 0 , {5554103,104}.[event.object.name,event.object.container.name], 'Select Range to Modify', null , if $selectedcell? then $selectedcell else null , [ if event.object.$ut_cac.$range.count ge 10 then 50 else 30 , 30 , 30 , -1 , 150 , 150 , 200 ] ,  [] ,  
[ [ 'button' , {5554103,8} , null , 'INPUT_STATE_DETAILMONITOR_B' , true ] , [ 'button' , 'UNUSED' , 'comm_manager_settings_range_toggle_jump' , 'INPUT_STATE_DETAILMONITOR_BACK' , true , null , true] , [ 'button' ,  'Remove' , 'comm_manager_settings_range_remove' , 'INPUT_STATE_DETAILMONITOR_Y' , true , null , true ] , [ 'button' , '\033ROld Managment Menu', 'comm_manager_settings_range_mod' , 'INPUT_STATE_DETAILMONITOR_X' , true ] ] ]"/>
          <append_to_list name="$genericuiparam.{8}" exact="[ [ 'header' , [ 7 ] ] , [ 'text' , {5554103,15000} ] 
]"/>
          <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 4 , 2 , 1 ] ] , 
[ 'text' , {5554103,15001}.[$totalrangepoints,$rangepoints] ] , 
[ 'text' , {5554103,15001} ] , [ 'stars' , event.object.skill.navigation], 
[ 'statusbar' , 100 * $rangepoints / $totalrangepoints , 100 , 255 , 100 ,  100 ] 
]"/>
          <do_all exact="event.object.$ut_cac.$range.count" counter="$i" reverse="false">
            <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 1 , 1 , 1 , 1 , 1 , 1 , 1 ] , null , $i] ,  
[ 'text' , $i + '.' ] , 
[ 'button' , if event.object.$ut_cac.$range_j.{$i} then {5554103,15003} else {5554103,15004} , 'comm_manager_settings_range_toggle_jump' , null , true , $i , true ] , 
[ 'button' , if event.object.$ut_cac.$range_h.{$i} then {5554103,15005} else {5554103,15006} , 'comm_manager_settings_range_toggle_highway' , null  , true , $i , true ] , 
[ 'text' , event.object.$ut_cac.$range.{$i}.name + ( if @event.object.$ut_cac.$range_w.{$i} then ( ' via ' + event.object.$ut_cac.$range_w.{$i}.name ) else '' ) ] , 
[ 'button' , {5554103,15007} , 'comm_manager_settings_range_move_down' , null , true , $i , true ] , 
[ 'button' , {5554103,15008} , 'comm_manager_settings_range_change' , null , true , $i ] , 
[ 'button' , if @event.object.$ut_cac.$range_w.{$i} then {5554103,15009} else {5554103,15010} , 'comm_manager_settings_range_change_waypoint' , null , true , $i] ]"/>
          </do_all>
          <!-- remove last move down Entry -->
          <set_value name="$genericuiparam.{8}.{$genericuiparam.{8}.count}.{6}" exact="null"/>
          <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 3 , 1 , 3 ] ] , 
[ 'text' , '#' ] , 
[ 'text' , {5554103,15011} ] , 
[ 'button' , {5554103,15012} , 'comm_manager_settings_range_change' , null , true , event.object.$ut_cac.$range.count + 1 ] 
]"/>
          <append_to_list name="$genericuiparam.{8}" exact="[ [ 'header' , [ 7 ] ] , [ 'text' , {5554103,15013} ] 
]"/>
          <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 6 , 1 ] ] , 
[ 'text' , {5554103,15014} ] , 
[ 'button' , if event.object.container.istraderestricted then {5554103,15015} else {5554103,15016} , 'comm_manager_settings_trade_restriction_toggle' , null , true , null , true ] 
]"/>
          <!-- Add Ware-specific Exceptions here -->
          <!-- Contraband Setting -->
          <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 5 , 2 ] ] , 
[ 'text' , {5554103,15020} ] , 
[ 'button' , readtext.{5554103}.{15021+event.object.$ut_cac.$legality} , 'comm_manager_settings_trade_legality_switch' , null , true , null , true ] 
]"/>
          <remove_value name="$selectedcell"/>
          <open_conversation_menu menu="ut_genericui" param="$genericuiparam"/>
          <add_conversation_view view="closeupdetailmonitor"/>
        </do_if>
        <do_elseif value="event.param == 'comm_manager_settings_range_toggle_jump'">
          <do_if value="event.object.$ut_cac.$range_j.{event.param2}">
            <set_value name="event.object.$ut_cac.$range_j.{event.param2}" exact="null"/>
          </do_if>
          <do_else>
            <set_value name="event.object.$ut_cac.$range_j.{event.param2}" exact="event.object.$ut_cac.$range.{event.param2}"/>
          </do_else>
          <set_value name="$selectedcell" exact="[event.param2+1,2]"/>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_manager_settings_range_toggle_highway'">
          <do_if value="event.object.$ut_cac.$range_h.{event.param2}">
            <set_value name="event.object.$ut_cac.$range_h.{event.param2}" exact="null"/>
          </do_if>
          <do_else>
            <set_value name="event.object.$ut_cac.$range_h.{event.param2}" exact="event.object.$ut_cac.$range.{event.param2}"/>
          </do_else>
          <set_value name="$selectedcell" exact="[event.param2+1,3]"/>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_manager_settings_range_move_down'">
          <set_value name="$tmp_range" exact="event.object.$ut_cac.$range.{event.param2}"/>
          <set_value name="$tmp_range_h" exact="event.object.$ut_cac.$range_h.{event.param2}"/>
          <set_value name="$tmp_range_j" exact="event.object.$ut_cac.$range_j.{event.param2}"/>
          <do_if value="event.object.$ut_cac.$range_w.{event.param2}">
            <set_value name="$tmp_range_w" exact="event.object.$ut_cac.$range_w.{event.param2}"/>
          </do_if>
          <remove_value name="event.object.$ut_cac.$range.{event.param2}"/>
          <remove_value name="event.object.$ut_cac.$range_h.{event.param2}"/>
          <remove_value name="event.object.$ut_cac.$range_j.{event.param2}"/>
          <remove_value name="event.object.$ut_cac.$range_w.{event.param2}"/>
          <set_value name="event.object.$ut_cac.$range.{event.param2 + 1}" operation="insert" exact="$tmp_range"/>
          <set_value name="event.object.$ut_cac.$range_h.{event.param2 + 1}" operation="insert" exact="$tmp_range_h"/>
          <set_value name="event.object.$ut_cac.$range_j.{event.param2 + 1}" operation="insert" exact="$tmp_range_j"/>
          <do_if value="$tmp_range_w?">
            <set_value name="event.object.$ut_cac.$range_j.{event.param2 + 1}" operation="insert" exact="$tmp_range_j"/>
          </do_if>
          <remove_value name="$tmp_range"/>
          <remove_value name="$tmp_range_h"/>
          <remove_value name="$tmp_range_j"/>
          <remove_value name="$tmp_range_w"/>
          <do_if value="event.param2 + 1 == event.object.$ut_cac.$range.count">
            <set_value name="$selectedcell" exact="[event.param2+1,5]"/>
          </do_if>
          <do_else>
            <set_value name="$selectedcell" exact="[event.param2+2,5]"/>
          </do_else>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_manager_settings_range_change'">
          <!-- can also be used for passing Ranges by passing an index of range count + 1 -->
          <set_value name="$slot" exact="event.param2"/>
          <open_conversation_menu menu="UTMapMenu" param="[0, 0, 'cluster', event.object.container.cluster, null, event.object.container.sector, 'selectspaceorstation', ['comm_manager_settings_range_set']]"/>
          <add_conversation_view view="closeupdetailmonitor"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_manager_settings_range_set'">
          <do_if value="$slot gt event.object.$ut_cac.$range.count">
            <append_to_list name="event.object.$ut_cac.$range" exact="event.param2.{3}"/>
            <append_to_list name="event.object.$ut_cac.$range_j" exact="event.param2.{3}"/>
            <append_to_list name="event.object.$ut_cac.$range_h" exact="event.param2.{3}"/>
            <append_to_list name="event.object.$ut_cac.$range_w" exact="null"/>
          </do_if>
          <do_else>
            <set_value name="event.object.$ut_cac.$range.{$slot}" exact="event.param2.{3}"/>
            <set_value name="event.object.$ut_cac.$range_j.{$slot}" exact="event.param2.{3}"/>
            <set_value name="event.object.$ut_cac.$range_h.{$slot}" exact="event.param2.{3}"/>
          </do_else>
          <set_value name="$selectedcell" exact="[$slot+1,6]"/>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_manager_settings_range_change_waypoint'">
          <set_value name="$slot" exact="event.param2"/>
          <open_conversation_menu menu="UTMapMenu" param="[0, 0, 'cluster', event.object.container.cluster, null, event.object.container.sector, 'selectspace', ['comm_manager_settings_range_set_waypoint']]"/>
          <add_conversation_view view="closeupdetailmonitor"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_manager_settings_range_set_waypoint'">
          <set_value name="event.object.$ut_cac.$range_w.{$slot}" exact="event.param2.{3}"/>
          <set_value name="$selectedcell" exact="[$slot + 1,7]"/>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_manager_settings_range_remove'">
          <do_if value="event.param2">
            <do_if value="event.object.$ut_cac.$range_w.{event.param2}">
              <set_value name="event.object.$ut_cac.$range_w.{event.param2}" exact="null"/>
              <set_value name="$selectedcell" exact="[event.param2+1,null]"/>
            </do_if>
            <do_else>
              <remove_value name="event.object.$ut_cac.$range.{event.param2}"/>
              <remove_value name="event.object.$ut_cac.$range_j.{event.param2}"/>
              <remove_value name="event.object.$ut_cac.$range_h.{event.param2}"/>
              <remove_value name="event.object.$ut_cac.$range_w.{event.param2}"/>
              <do_if value="event.param2  == event.object.$ut_cac.$range.count">
                <set_value name="$selectedcell" exact="[event.param2,null]"/>
              </do_if>
              <do_else>
                <set_value name="$selectedcell" exact="[event.param2+1,null]"/>
              </do_else>
            </do_else>
          </do_if>
          <do_else>
            <set_value name="$selectedcell" exact="[event.object.$ut_cac.$range.count + 2,5]"/>
          </do_else>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_manager_settings_trade_restriction_toggle'">
          <!-- currently this is a simple Toggle between restricted and non-restricted, but planning to change this to a finer definition consisting of own only, own+allied, own+allied+friend, own+allied+friend+neutral and own+allied+friend+neutral+docking allowed -->
          <do_if value="event.object.container.istraderestricted">
            <set_trade_restrictions object="event.object.container" restricted="false"/>
          </do_if>
          <do_else>
            <set_trade_restrictions object="event.object.container" restricted="true"/>
          </do_else>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_manager_settings_trade_legality_switch'">
          <set_value name="event.object.$ut_cac.$legality" operation="add"/>
          <do_if value="event.object.$ut_cac.$legality ge 4">
            <set_value name="event.object.$ut_cac.$legality" exact="0"/>
          </do_if>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
      </actions>
    </cue>
    <cue name="Main" instantiate="true" namespace="this" version="30">
      <conditions>
        <event_cue_signalled cue="this"/>
      </conditions>
      <cues>
        <cue name="Handover_040">
          <!-- The Instance Cue will not be used from 0.40 on anymore - handing over all Instances to the common dialogue Script -->
          <actions>
            <do_if value="$actor.ship.tradenpc == $actor">
              <set_value name="$actor.$ut_cac.$settings_section" exact="'comm_manager_settings'"/>
            </do_if>
            <do_else>
              <remove_value name="$actor.$ut_cac.$orders_section"/>
            </do_else>
            <debug_text filter="general" text="'%1 UT CAC Dialogue Handover to 040'.[$actor.name]" />
            <cancel_cue cue="Main"/>
          </actions>
        </cue>
      </cues>
    </cue>
  </cues>
</mdscript>
