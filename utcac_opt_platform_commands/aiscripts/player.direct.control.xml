<?xml version="1.0" encoding="UTF-8" ?>
<aiscript name="player.direct.control" version="30" priority="10" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd">
  <!--
 rewritten from scratch by UniTrader
 Script for following the Player Looking Direction
  -->
  <params>
    <param name="params" default="false" comment="pass a single Table filled with the wanted param Values here to make calls via list possible (always has priority)"/>
  </params>
  <interrupts>
    <handler comment="Player Undocked - Terminate">
      <conditions>
        <event_object_changed_room object="player.entity"/>
      </conditions>
      <actions>
        <return/>
        <resume label="finish"/>
      </actions>
    </handler>
  </interrupts>
    <actions>
      <label name="init"/>
      <!-- get Original Player Pos; set Player to Position with good visibility (first do_if is for bridge mod compatibility)-->
      <set_value name="$originalpos" exact="position.[player.entity.position.x,player.entity.position.y+0.05m,player.entity.position.z]"/>
      <do_if value="player.platform.macro.id == 'capital_bridge2_wrapper_macro'">
        <set_player_entity_position>
          <position x="0" y="5" z="27"/>
        </set_player_entity_position>
      </do_if>
      <do_else>
        <set_player_entity_position>
          <position x="0" y="6" z="-7"/>
        </set_player_entity_position>
      </do_else>
      <!-- wait a second until he falls down -->
      <wait exact="1s"/>
      <!-- save Player Pos as normal Pos to restore constantly -->
      <set_value name="$normalpos" exact="position.[player.entity.position.x,player.entity.position.y+0.005m,player.entity.position.z]"/>
      <set_value name="$boost" exact="false"/>
      
      <!-- create orientation light in front -->
      <transform_position name="$position" refposition="$normalpos" refrotation="rotation.[0deg,0deg,0deg]">
        <position x="0m" y="0m" z="2km"/>
      </transform_position>
      <add_effect object="player.platform" effect="'jump_activation_jumpdrive_slow'">
        <position value="$position"/>
      </add_effect>
      
      
      <label name="start"/>
      <!--set_avoid_collisions object="player.ship" enabled="false"/--><!-- this one makes fly-through problems with Stations, so deactivated for now -->
      <do_while value="player.platform.exists">
        <!-- get Player Looking Direction -->
        <!-- first get Position in front of Player (relative to Sector)- now with 3deg deadzone -->
        <do_if value="player.entity.rotation.yaw lt 3deg and player.entity.rotation.yaw gt -3deg and player.entity.rotation.pitch lt 3deg and player.entity.rotation.pitch gt -3deg">
          <set_value name="$rotation" exact="rotation.[0deg,0deg,0deg]"/>
        </do_if>
        <do_elseif value="player.entity.rotation.yaw gt 177deg and player.entity.rotation.yaw lt -177deg and player.entity.rotation.pitch lt 3deg and player.entity.rotation.pitch gt -3deg">
          <set_value name="$rotation" exact="rotation.[180deg,0deg,0deg]"/>
        </do_elseif>
        <do_else>
          <set_value name="$rotation" exact="player.entity.rotation"/>
        </do_else>
        <transform_position name="$position" refposition="position.[0,0,0]" refrotation="$rotation">
          <position x="0m" y="0m" z="if $boost then 10km else player.ship.size"/>
        </transform_position>
        <transform_position name="$position" refposition="player.ship.position" refrotation="player.ship.rotation">
          <position value="$position"/>
        </transform_position>
        <do_if value="$rotation.yaw gt 90deg and $rotation.yaw lt -90deg" comment="reverse flight">
          <create_orientation name="$rotation" refobject="player.ship" orientation="look_at">
            <position value="$position"/>
          </create_orientation>
        </do_if>
        <do_else>
          <create_orientation name="$rotation" refobject="player.ship" orientation="look_away">
            <position value="$position"/>
          </create_orientation>
        </do_else>
        <move_to object="player.ship" destination="player.zone" boost="$boost" abortpath="true" avoid="false" reverse="$rotation.yaw gt 90deg or $rotation.yaw lt -90deg">
          <position value="$position" space="player.zone"/>
          <rotation value="$rotation"/>
          <interrupt_after_time time="0s"/>
        </move_to>
        <wait exact="100ms"/>
        <!-- check if player Jumped, and if toggle boost var and reset pos -->
        <do_if value="player.entity.position.y gt $normalpos.y + 0.05m">
          <set_value name="$boost" exact="not $boost"/>
        </do_if>
        <!-- if player is still falling -set new Pos (workaround for other Platforms) - removed for now -->
        <!--do_elseif value="player.entity.position.y lt $normalpos.y - 0.04m">
          <set_value name="$normalpos" exact="player.entity.position"/>
        </do_elseif-->
        <!-- check if the Player stepped backwards to exit -->
        <do_if value="player.entity.position.z lt $normalpos.z - 0.1m">
          <resume label="finish"/>
        </do_if>
        <!-- check if player moved from normalpos and reset pos -->
        <set_player_entity_position>
          <position value="$normalpos"/>
        </set_player_entity_position>
      </do_while>
      <label name="finish"/>
      <do_if value="player.platform.exists">
        <set_player_entity_position>
          <position value="$originalpos"/>
        </set_player_entity_position>
        <stop_moving object="this.ship" immediate="true"/>
        <!--set_avoid_collisions object="player.ship" enabled="true"/-->
        <remove_effect object="player.platform" effect="'jump_activation_jumpdrive_slow'"/>
        <signal_objects object="player.primaryship" param="'Restart Platform Commands'"/>
      </do_if>
    </actions>
  <on_abort>
    <do_if value="player.platform.exists">
      <set_player_entity_position>
        <position value="$originalpos"/>
      </set_player_entity_position>
      <stop_moving object="this.ship" immediate="true"/>
      <!--set_avoid_collisions object="player.ship" enabled="true"/-->
      <remove_effect object="player.platform" effect="'jump_activation_jumpdrive_slow'"/>
        <signal_objects object="player.primaryship" param="'Restart Platform Commands'"/>
    </do_if>
  </on_abort>
</aiscript>
