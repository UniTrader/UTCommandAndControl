<?xml version="1.0" encoding="UTF-8" ?>
<aiscript name="player.direct.control" version="30" priority="10" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd">
  <!--
 rewritten from scratch by UniTrader
 Script for following the Player Looking Direction
  -->
  <params>
    <param name="params" default="false" comment="pass a single Table filled with the wanted param Values here to make calls via list possible (always has priority)"/>
  </params>
  <interrupts>
    <handler comment="Player Undocked - Terminate">
      <conditions>
        <event_object_changed_room object="player.entity"/>
      </conditions>
      <actions>
        <return/>
        <resume label="finish"/>
      </actions>
    </handler>
  </interrupts>
    <actions>
      <label name="init"/>
      <!-- get Original Player Pos; set Player to Position with good visibility (first do_if is for bridge mod compatibility)-->
      <set_value name="$originalpos" exact="player.entity.position"/>
      <do_if value="player.platform.ismacro.capital_bridge2_wrapper_macro">
        <set_player_entity_position>
          <position x="0" y="5" z="27"/>
        </set_player_entity_position>
      </do_if>
      <do_else>
        <set_player_entity_position>
          <position x="0" y="6" z="-7"/>
        </set_player_entity_position>
      </do_else>
      <!-- wait a second until he falls down -->
      <wait exact="1s"/>
      <!-- save Player Pos as normal Pos to restore constantly -->
      <set_value name="$normalpos" exact="player.entity.position"/>
      <set_value name="$boost" exact="false"/>
      
      <label name="start"/>
      <do_while value="player.platform.exists">
        <!-- get Player Looking Direction -->
        <!-- first get Position in front of Player (relative to Sector) -->
        <transform_position name="$Position" refposition="position.[0,0,0]" refrotation="player.entity.rotation">
          <position x="0m" y="0m" z="if $boost then 10km else player.ship.size"/>
        </transform_position>
        <transform_position name="$Position" refposition="player.ship.position" refrotation="player.ship.rotation">
          <position value="$Position"/>
        </transform_position>
        <move_to object="player.ship" destination="player.zone" boost="$boost" abortpath="true" avoid="false">
          <position value="$Position" space="player.zone"/>
          <interrupt_after_time time="0s"/>
        </move_to>
        <wait exact="100ms"/>
        <!-- check if player Jumped, and if toggle boost var and reset pos -->
        <do_if value="player.entity.position.y gt $normalpos.y + 0.01m">
          <set_value name="$boost" exact="not $boost"/>
        </do_if>
        <!-- if player is still falling -set new Pos (workaround for other Platforms)-->
        <do_elseif value="player.entity.position.y lt $normalpos.y - 0.04m">
          <set_value name="$normalpos" exact="player.entity.position"/>
        </do_elseif>
        <!-- check if the Player stepped backwards to exit -->
        <do_if value="player.entity.position.z lt $normalpos.z - 0.1m">
          <signal_objects object="player.primaryship" param="'Restart Platform Commands'"/>
          <resume label="finish"/>
        </do_if>
        <!-- check if player moved from normalpos and reset pos -->
        <set_player_entity_position>
          <position value="$normalpos"/>
        </set_player_entity_position>
      </do_while>
      <label name="finish"/>
      <do_if value="player.platform.exists">
        <set_player_entity_position>
          <position value="$originalpos"/>
        </set_player_entity_position>
        <stop_moving object="this.ship" immediate="true"/>
      </do_if>
    </actions>
  <on_abort>
    <do_if value="player.platform.exists">
      <set_player_entity_position>
        <position value="$originalpos"/>
      </set_player_entity_position>
      <stop_moving object="this.ship" immediate="true"/>
    </do_if>
  </on_abort>
</aiscript>
