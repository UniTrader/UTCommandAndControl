<?xml version="1.0" encoding="UTF-8"?>
<mdscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="UT_Platform_Commands" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/md.xsd">
  <cues>
    <cue name="Ship_Docked">
      <conditions>
        <event_object_changed_room object="player.entity"/>
        <check_value value="player.entity.container.isclass.ship and player.controlled != player.primaryship and player.entity.container.owner == faction.player"/>
      </conditions>
      <actions>
        <reset_cue cue="Player_Undocked"/>
        <!-- Gather Zones in current Sector ans Sectors in current Cluster for regular view check -->
        <find_zone name="$spaces" space="player.sector" multiple="true" known="true" tempzone="false" priorityzone="true"/>
        <remove_value name="$spaces.{$spaces.indexof.{player.zone}}"/>
        <find_sector name="$spaces2" space="player.cluster" multiple="true" known="true"/>
        <remove_value name="$spaces2.{$spaces2.indexof.{player.sector}}"/>
        <append_to_list name="$spaces" list="$spaces2"/>
        <remove_value name="$spaces2"/>
        <create_group groupname="$objects"/>
        <set_value name="$tracked_objects" exact="table[]"/>
      </actions>
      <cues>
        <cue name="Update_spaces">
          <conditions>
            <event_object_changed_sector object="player.ship"/>
          </conditions>
          <actions>
            <find_zone name="$spaces" space="player.sector" multiple="true" known="true" tempzone="false" priorityzone="true"/>
            <remove_value name="$spaces.{$spaces.indexof.{player.zone}}"/>
            <find_sector name="$spaces2" space="player.cluster" multiple="true" known="true"/>
            <remove_value name="$spaces2.{$spaces2.indexof.{player.sector}}"/>
            <append_to_list name="$spaces" list="$spaces2"/>
            <remove_value name="$spaces2"/>
            <reset_cue cue="this"/>
          </actions>
        </cue>
        <cue name="Check_Player_Hover">
          <delay exact="150ms"/>
          <actions>
            <!-- find new Objects every 5 loops -->
            <set_value name="$loop" operation="subtract"/>
            <do_if value="$loop le 0">
              <set_value name="$loop" exact="6"/>
              <find_object groupname="$objects" space="player.zone" checkoperational="true" multiple="true">
                <match_is_in_view_of object="player.entity" vertical="15deg" horizontal="15deg"/>
                <match_distance object="player.ship" max="player.ship.maxradarrange"/>
                <match class="class.station" negate="true"/>
                <match_size min="200m"/>
              </find_object>
              <remove_from_group group="$objects" object="player.ship"/>
              <find_station name="$stations" space="player.zone" checkoperational="true" multiple="true">
                <match_is_in_view_of object="player.entity" vertical="60deg" horizontal="60deg"/>
                <!--match_distance object="player.ship" max="player.ship.maxradarrange + 5km"/-->
              </find_station>
              <do_all exact="$stations.count" counter="$i">
                <find_object_component groupname="$objects" object="$stations.{$i}" checkoperational="true" integrated="false" multiple="true">
                  <match_is_in_view_of object="player.entity" vertical="15deg" horizontal="15deg"/>
                  <match_distance object="player.ship" max="player.ship.maxradarrange"/>
                  <match_parent class="class.station"/>
                  <match_any>
                    <match class="class.production"/>
                    <match class="class.buildmodule"/>
                    <match class="class.storage"/>
                    <match class="class.dronelaunchpad"/>
                    <match class="class.radar"/>
                    <match_child macro="macro.turret_large_bb_macro"/>
                    <!-- Targon Tracer -->
                    <!--match class="class.destructible">
                      <match_size min="500m"/>
                    </match-->
                  </match_any>
                  <!--match_any negate="true">
                    <match class="class.production"/>
                  </match_any-->
                </find_object_component>
              </do_all>
              <do_all exact="$spaces.count" counter="$i">
                <check_object object="$spaces.{$i}" result="$result">
                  <match_is_in_view_of object="player.entity" vertical="20deg" horizontal="20deg"/>
                </check_object>
                <do_if value="$result">
                  <add_to_group groupname="$objects" object="$spaces.{$i}"/>
                </do_if>
              </do_all>
              <do_all exact="$objects.count" counter="$i">
                <set_value name="$tracked_objects.{$objects.{$i}}" operation="add" exact="if $objects.count + $tracked_objects.keys.count == 1 then 5 else 3"/>
              </do_all>
              <clear_group group="$objects"/>
              <set_value name="$keys" exact="$tracked_objects.keys.list"/>
              <set_value name="$highest_focus_object" exact="null"/>
              <set_value name="$highest_focus_number" exact="null"/>
              <do_all exact="$keys.count" counter="$i" reverse="true">
                <set_value name="$tracked_objects.{$keys.{$i}}" operation="subtract" exact="2"/>
                <do_if value="$tracked_objects.{$keys.{$i}} le 0">
                  <remove_value name="$tracked_objects.{$keys.{$i}}"/>
                </do_if>
                <do_elseif value="$tracked_objects.{$keys.{$i}} gt $highest_focus_number">
                  <set_value name="$highest_focus_object" exact="$keys.{$i}"/>
                  <set_value name="$highest_focus_number" exact="$tracked_objects.{$keys.{$i}}"/>
                </do_elseif>
              </do_all>
            </do_if>
            <!-- else check already known Objects if their Value should be increased or decreased -->
            <do_else>
              <set_value name="$keys" exact="$tracked_objects.keys.list"/>
              <set_value name="$highest_focus_object" exact="null"/>
              <set_value name="$highest_focus_number" exact="null"/>
              <do_all exact="$keys.count" counter="$i" reverse="true">
                <!-- check if in Sight - if yes increase Value by 3, if no decrease by 2 -->
                <do_if value="$keys.{$i}.isclass.space">
                  <check_object object="$keys.{$i}" result="$result">
                    <match_is_in_view_of object="player.entity" vertical="20deg" horizontal="20deg"/>
                  </check_object>
                </do_if>
                <do_else>
                  <check_object object="$keys.{$i}" result="$result">
                    <match_is_in_view_of object="player.entity" vertical="15deg" horizontal="15deg"/>
                    <match_distance object="player.ship" max="player.ship.maxradarrange"/>
                  </check_object>
                </do_else>
                <do_if value="$result">
                  <set_value name="$tracked_objects.{$keys.{$i}}" operation="add" exact="if $keys.count == 1 then 3 else 1"/>
                </do_if>
                <do_else>
                  <set_value name="$tracked_objects.{$keys.{$i}}" operation="subtract" exact="2"/>
                </do_else>
                <do_if value="$tracked_objects.{$keys.{$i}} le 0">
                  <remove_value name="$tracked_objects.{$keys.{$i}}"/>
                </do_if>
                <do_elseif value="$tracked_objects.{$keys.{$i}} gt $highest_focus_number">
                  <set_value name="$highest_focus_object" exact="$keys.{$i}"/>
                  <set_value name="$highest_focus_number" exact="$tracked_objects.{$keys.{$i}}"/>
                </do_elseif>
              </do_all>
            </do_else>
            <do_if value="$highest_focus_number ge 40">
              <set_value name="$selectedobject" exact="$highest_focus_object"/>
              <set_value name="$tracked_objects" exact="table[]"/>
              <!--start_conversation conversation="ut_cac_pc" actor="player.computer"/-->
              <reset_cue cue="this"/>
              <!-- start conversation -->
            </do_if>
            <do_elseif value="$highest_focus_object.exists">
              <set_value name="$helptext" exact="''"/>
              <do_if value="$highest_focus_number ge 17">
                <set_value name="$helptext" exact="$helptext + '\033M'"/>
                <do_all exact="[$highest_focus_number - 16 , 18 ].min">
                  <set_value name="$helptext" exact="$helptext + '»'"/>
                </do_all>
              </do_if>
              <do_if value="$highest_focus_number ge 12 and $highest_focus_number lt 34">
                <set_value name="$helptext" exact="$helptext + '\033R'"/>
                <do_all exact="[$highest_focus_number - 11 , 5 , 34 - $highest_focus_number].min">
                  <set_value name="$helptext" exact="$helptext + '»'"/>
                </do_all>
              </do_if>
              <do_if value="$highest_focus_number ge 7 and $highest_focus_number lt 29">
                <set_value name="$helptext" exact="$helptext + '\033Y'"/>
                <do_all exact="[$highest_focus_number - 6 , 5 , 29 - $highest_focus_number].min">
                  <set_value name="$helptext" exact="$helptext + '»'"/>
                </do_all>
              </do_if>
              <do_if value="$highest_focus_number ge 2 and $highest_focus_number lt 24">
                <set_value name="$helptext" exact="$helptext + '\033G'"/>
                <do_all exact="[$highest_focus_number - 1 , 5 , 24 - $highest_focus_number].min">
                  <set_value name="$helptext" exact="$helptext + '»'"/>
                </do_all>
              </do_if>
              <do_if value="$highest_focus_number ge 1 and $highest_focus_number lt 19">
                <set_value name="$helptext" exact="$helptext + '\033X'"/>
                <do_all exact="[19 - $highest_focus_number].min">
                  <set_value name="$helptext" exact="$helptext + '»'"/>
                </do_all>
              </do_if>
              <set_value name="$helptext" exact="$helptext + '\033X %1\n%2%3'"/>
              <do_if value="$highest_focus_object.isclass.space">
                <set_value name="$helptext" exact="$helptext.[$tracked_objects.keys.count,'\033U',$highest_focus_object.name]"/>
              </do_if>
              <do_elseif value="$highest_focus_object.isplayerowned">
                <set_value name="$helptext" exact="$helptext.[$tracked_objects.keys.count,'\033G',$highest_focus_object.name]"/>
              </do_elseif>
              <do_elseif value="$highest_focus_object.mayattack.{faction.player}">
                <set_value name="$helptext" exact="$helptext.[$tracked_objects.keys.count,'\033R',$highest_focus_object.name]"/>
              </do_elseif>
              <do_elseif value="$highest_focus_object.isoperational">
                <set_value name="$helptext" exact="$helptext.[$tracked_objects.keys.count,'\033C',$highest_focus_object.name]"/>
              </do_elseif>
              <do_else>
                <set_value name="$helptext" exact="$helptext.[$tracked_objects.keys.count,'',$highest_focus_object.name]"/>
              </do_else>
              <do_if value="$commandtarget" exact="'%1\n\nCommand Target:\n%2'.[$helptext,$commandtarget.name]"/>
              <remove_help all="true"/>
              <show_help custom="$helptext" duration="500ms" position="8" log="false" silent="$highest_focus_number lt 26"/>
              <reset_cue cue="this"/>
            </do_elseif>
            <do_else>
              <reset_cue cue="this"/>
            </do_else>
          </actions>
        </cue>
        <cue name="Target_Selected">
          <conditions>
            <check_any>
              <event_conversation_started conversation="ut_cac_pc"/>
              <event_conversation_returned_to_section section="ut_cac_pc"/>
            </check_any>
          </conditions>
          <actions>
            <!-- first sort out which kind of Target it is then present some Options -->
            <!-- Spaces -->
            <do_if value="$selectedobject.isclass.space">
              <do_if value="$commandtarget?">
                <remove_help all="true"/>
                <show_help custom="'Command Target: %1'.[$commandtarget.name]" duration="500ms" position="8" log="false" silent="$highest_focus_number lt 26" />
              </do_if>
              <add_player_choice position="4" text="'Move to: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="ut_cac_pc_moveyto" choiceparam="$selectedobject"/>
              <!-- Specific Movement Type Orders - only available with UT CAC Movement -->
              <do_if value="@readtext.{5554301,11100} == '$destination'" comment="Check if my Movement Scripts are installed and Active">
                <do_if value="$selectedobject.isclass.sector">
                  <add_player_choice position="1" text="'Jump to: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="ut_cac_pc_jumpto" choiceparam="$selectedobject"/>
                  <add_player_choice position="2" text="'Random Jump to: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="ut_cac_pc_jump_random" choiceparam="$selectedobject"/>
                  <add_player_choice position="3" text="'Boost to: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="ut_cac_pc_boostto" choiceparam="$selectedobject" selectable="false"/>
                </do_if>
                <do_elseif value="$selectedobject.isclass.zone">
                  <find_object name="$beacon" space="$selectedobject" knownto="faction.player" checkoperational="true">
                    <match_any>
                      <match class="class.jumpbeacon"/>
                      <match_child class="class.jumpbeacon" checkoperational="true"/>
                    </match_any>
                  </find_object>
                  <add_player_choice position="1" text="'Jump to: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="ut_cac_pc_jumpto" choiceparam="$beacon" selectable="$beacon.exists"/>
                  <add_player_choice position="3" text="'Boost to: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="ut_cac_pc_boostto" choiceparam="$selectedobject"/>
                </do_if>
              </do_if>
            </do_if>
            <!-- Gates -->
            <do_elseif value="$selectedobject.isclass.{[class.highwayentrygate,class.highwayexitgate,class.jumpgate]}">
              <!-- add Option to follow the Junctions backwards and Forwards -->
              <do_if value="$selectedobject.isclass.highwayentrygate">
                <do_if value="$selectedobject.highway.islocalhighway">
                  <set_value name="$waypoints" exact="$selectedobject.highway.junctions"/>
                    <remove_value name="$waypoints.{1}"/>
                  <set_value name="$othersidezone" exact="$selectedobject.highway.destination"/>
                </do_if>
                <set_value name="$othersidezone" exact="$selectedobject.highway.destination"/>
              </do_if>
              <do_elseif value="$selectedobject.isclass.highwayexitgate">
                <do_if value="$selectedobject.highway.islocalhighway">
                  <set_value name="$waypoints" exact="$selectedobject.highway.junctions"/>
                  <remove_value name="$waypoints.last"/>
                  <!-- reverse Order of junctions to follow tube backwards -->
                  <do_all exact="$waypoints.count">
                    <set_value name="$waypoints.{1}" exact="$waypoints.last" operation="insert"/>
                    <remove_value name="$waypoints.last"/>
                  </do_all>
                </do_if>
                <set_value name="$othersidezone" exact="$selectedobject.highway.origin"/>
              </do_elseif>
              <do_elseif value="$selectedobject.isclass.gate">
                <set_value name="$othersidezone" exact="$selectedobject.destination"/>
              </do_elseif>
              <add_player_choice position="4" text="'Fly to: %1'.[$othersidezone.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$othersidezone}]" section="PC_Move_FlyTo_selected" choiceparam="$othersidezone"/>
              <do_if value="$waypoints?">
                <add_player_choice position="5" text="'Follow Tube: %1 Zones'.[$waypoints.count]" tooltip="'Distance: %1'.[player.ship.distanceto.{$othersidezone}]" section="PC_Move_FlyTo_selected" choiceparam="$waypoints"/>
              </do_if>
              <!-- Specific Movement Type Orders - only available with UT CAC Movement -->
              <do_if value="@readtext.{5554301,11100} == '$destination'" comment="Check if my Movement Scripts are installed and Active">
                <add_player_choice position="1" text="'Jump to: %1'.[$othersidezone.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$othersidezone}]" section="PC_Move_FlyTo_selected" choiceparam="$othersidezone"/>
                <add_player_choice position="2" text="'Random Jump to: %1'.[$othersidezone.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$othersidezone}]" section="PC_Move_FlyTo_selected" choiceparam="$othersidezone"/>
                <add_player_choice position="3" text="'Boost to: %1'.[$othersidezone.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$othersidezone}]" section="PC_Move_FlyTo_selected" choiceparam="$othersidezone"/>
              </do_if>
            </do_elseif>
            <!-- Ships -->
            <do_elseif value="$selectedobject.isclass.ship">
              <add_player_choice position="4" text="'Follow: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="PC_Move_FlyTo_selected" choiceparam="$selectedobject"/>
              <do_if value="$selectedobject.isplayerowned">
                <add_player_choice position="1" text="'Select as Commandtarget: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="ut_cac_commandtarget_set" choiceparam="$selectedobject"/>
                <do_if value="$commandtarget?">
                  <add_player_choice position="3" text="'follow %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="PC_Move_FlyTo_selected" choiceparam="$selectedobject"/>
                </do_if>
                <do_else>
                  <add_player_choice position="3" text="'follow me'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="PC_Move_FlyTo_selected" choiceparam="$selectedobject"/>
                </do_else>
                <add_player_choice position="5" text="'Withdraw: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="PC_Move_FlyTo_selected" choiceparam="$selectedobject"/>
              </do_if>
              <do_else>
                <add_player_choice position="1" text="'Attack: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="PC_Move_FlyTo_selected" choiceparam="$selectedobject"/>
                <add_player_choice position="2" text="'Alpha Strike: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="PC_Move_FlyTo_selected" choiceparam="$selectedobject"/>
                <add_player_choice position="3" text="'Ignore: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="PC_Move_FlyTo_selected" choiceparam="$selectedobject"/>
                <add_player_choice position="5" text="'Flee from: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="PC_Move_FlyTo_selected" choiceparam="$selectedobject"/>
              </do_else>
            </do_elseif>
            <do_elseif value="$selectedobject.station?">
              <add_player_choice position="1" text="'Attack: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="PC_Move_FlyTo_selected" choiceparam="$selectedobject"/>
              <add_player_choice position="2" text="'Alpha Strike: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="PC_Move_FlyTo_selected" choiceparam="$selectedobject"/>
              <add_player_choice position="3" text="'Ignore: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="PC_Move_FlyTo_selected" choiceparam="$selectedobject"/>
              <add_player_choice position="4" text="'Fly to: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="PC_Move_FlyTo_selected" choiceparam="$selectedobject"/>
              <add_player_choice position="5" text="'Flee from: %1'.[$selectedobject.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$selectedobject}]" section="PC_Move_FlyTo_selected" choiceparam="$selectedobject"/>
            </do_elseif>
            <do_if value="$commandtarget?">
              <add_player_choice position="6" text="'Deselect Command Target: %1'.[$commandtarget.name]" tooltip="'Distance: %1'.[player.ship.distanceto.{$commandtarget}]" section="ut_cac_pc_commandtarget_unselect"/>
            </do_if>
            <add_player_choice_return position="6" text="'(Back)'"/>
            <!-- can only imagine move to currently..-->
          </actions>
          <cues>
            <cue name="Cancel_Target_Selected">
              <delay exact="10s"/>
              <actions>
                <cancel_conversation conversation="ut_cac_pc"/>
                <reset_cue cue="Target_Selected"/>
                <reset_cue cue="Check_Player_Hover"/>
              </actions>
            </cue>
          </cues>
        </cue>
        <cue name="Action_chosen">
          <conditions>
            <check_any>
              <event_conversation_next_section sectionprefix="ut_cac_pc_"/>
              <event_conversation_finished outcome="ut_cac_pc"/>
            </check_any>
          </conditions>
          <actions>
            <do_if value="event.name == 'event_conversation_finished'">
            </do_if>
            <do_elseif value="event.name == 'event_conversation_next_section'">
              <do_if value="not $commandtarget?">
                <set_value name="$commandtarget" exact="player.ship"/>
              </do_if>
              <do_elseif value="event.param == 'ut_cac_pc_'">
                <remove_value name="$commandtarget"/>
              </do_elseif>
              <do_elseif value="event.param == 'ut_cac_pc_'">
                <remove_value name="$commandtarget"/>
              </do_elseif>
              <do_elseif value="event.param == 'ut_cac_pc_'">
                <remove_value name="$commandtarget"/>
              </do_elseif>
              <do_elseif value="event.param == 'ut_cac_pc_'">
                <remove_value name="$commandtarget"/>
              </do_elseif>
              <do_elseif value="event.param == 'ut_cac_pc_commandtarget_select'">
                <set_value name="$commandtarget" exact="$selectedobject"/>
              </do_elseif>
              <do_elseif value="event.param == 'ut_cac_pc_commandtarget_unselect'">
                <remove_value name="$commandtarget"/>
              </do_elseif>
              <do_else>
                  <debug_text filter="error" text="'Unknown Section/event: %1\nevent.param= %2 event.param2= %3 event.param3= %4'.[event.name,event.param,event.param2,event.param3]"/>
              </do_else>
            </do_elseif>
            <reset_cue cue="this"/>
            <reset_cue cue="Target_Selected"/>
            <reset_cue cue="Check_Player_Hover"/>
          </actions>
        </cue>
      </cues>
    </cue>
    <cue name="Player_Undocked" comment="Player Undocked: stop Platform Scripts and reset cue for player wait until docked again">
      <conditions>
        <event_object_changed_room object="player.entity"/>
        <check_value exact="player.entity.container" value="player.primaryship" comment="Only if player is on his ship"/>
      </conditions>
      <actions>
        <reset_cue cue="Ship_Docked"/>
      </actions>
    </cue>
  </cues>
</mdscript>
