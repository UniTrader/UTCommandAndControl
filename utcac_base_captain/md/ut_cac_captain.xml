<?xml version="1.0" encoding="UTF-8" ?>
<mdscript name="UT_CAC_Captain" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/md.xsd">

  <cues>
    <cue name="Orders" comment="namespace=md.UT_CAC_Dialogue.Comm_Common_Orders" instantiate="true">
      <conditions>
        <check_any>
          <event_conversation_next_section sectionprefix="comm_captain_orders"/>
          <event_conversation_returned_to_section sectionprefix="comm_captain_orders"/>
        </check_any>
      </conditions>
      <actions>
        <debug_text filter="general" chance="@event.object.$debug * 100" text="'%1 %2 event.name= %3 \nevent.param= %4 event.param2= %5 event.param3= %6'.[event.object.name,event.object.container.name,event.name,event.param,event.param2,event.param3]"/>
        <do_if value="md.UT_CAC_Dialogue.Comm_Common_Orders.$new_order?" comment="we have an Order to be given - return to Order Menu and let the calling MD File handle the rest.">
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
          <!-- delete temp values for Orders when returning -->
          <remove_value name="$patroltime"/>
        </do_if>
        <do_elseif value="event.param == 'comm_captain_orders'">
          <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
            <add_npc_line speaker="event.object" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
          </do_if>
<!-- Button Reminder: { 'button' , 'button text' [,'next_section' [ ,hotkey  [, selectable [,param [,keepvisible [,notsubsection]]]] ]] } -->
          <set_value name="$genericuiparam" exact=" [ 0 , 0 , 'Orders for %1'.[event.object.name], null, null , null , [ -1 , 200 , 200 , 200 , 200 , 200 ] ,  [] ,  [ 
[ 'button' , {5554103,8} , null , 'INPUT_STATE_DETAILMONITOR_B' , true ] , 
[ 'button' , 'unused' , 'comm_personal_' , 'INPUT_STATE_DETAILMONITOR_BACK' , false , null , true] , 
[ 'button' , 'unused' , 'comm_personal_' , 'INPUT_STATE_DETAILMONITOR_Y' , false , null , true ] , 
[ 'button' , 'unused' , 'comm_personal_' , 'INPUT_STATE_DETAILMONITOR_X' , false , null , true ] 
] ]"/>
          <append_to_list name="$genericuiparam.{8}" exact="[ [ 'header' , [ 6 ] ] , [ 'text' , {5554103,11000} ] ]"/>
          <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 3 , 1 , 1 , 1 ] ] ,
[ 'text' , {5554103,11001} ] ,
[ 'button' , {5554103,11002} , 'comm_captain_orders_retreat' , false , global.$Player_HQ? , @global.$Player_HQ , true ] ,
[ 'button' , {5554103,11003} , 'comm_captain_orders_retreat' , false , event.object.ship.commander? , @event.object.ship.commander , true ] ,
[ 'button' , {5554103,11004} , 'comm_captain_orders_retreat' , false , true , null , true  ]
]"/>
          <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [4 , 1 , 1 ] ] ,
[ 'text' , {5554103,11005} ] ,
[ 'button' , {5554103,11006} , 'comm_captain_orders_attack_subsystem' , false , false , null , true ] ,
[ 'button' , {5554103,11007} , 'comm_captain_orders_attack_object' , false , true , null , true ]
]"/>
          <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 2 , 1 , 1 , 1 , 1 ] ] ,
[ 'text' , {5554103,11008} ] ,
[ 'button' , {5554103,11009}.[1h.formatted.default] , 'comm_captain_orders_patrol' , false , true , 1h , true ] ,
[ 'button' , {5554103,11009}.[5h.formatted.default] , 'comm_captain_orders_patrol' , false , true , 5h , true ] ,
[ 'button' , {5554103,11009}.[24h.formatted.default] , 'comm_captain_orders_patrol' , false , true , 24h , true ] ,
[ 'button' , {5554103,11009}.[100h.formatted.default] , 'comm_captain_orders_patrol' , false , true , 100h , true ]
]"/>
          <append_to_list name="$genericuiparam.{8}" exact="[ [ 'header' , [ 6 ] ] , [ 'text' , '\033RNavigation Orders' ] ]"/>
          <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 3 , 1 , 1 , 1 ] ] ,
[ 'text' , {5554103,11019} ] ,
[ 'button' , '\033RObject' , 'comm_captain_orders_flyto_object' , false , true , null , true ] ,
[ 'button' , '\033RSpace' , 'comm_captain_orders_flyto_space' , false , true , null , true ] ,
[ 'button' , {5554103,9} , 'comm_captain_orders_flyto' , false , true , null , true ]
]"/>
          <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 5 , 1 ] ] ,
[ 'text' , {5554103,11011} ] ,
[ 'button' , {5554103,9} , 'comm_captain_orders_flyto' , false , true , 'comm_captain_orders_follow' , true ]
]"/>
          <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 2 , 1 , 1 , 1 , 1 ] ] ,
[ 'text' , {5554103,11012} ] ,
[ 'button' , {5554103,11009}.[1h.formatted.default] , 'comm_captain_orders_escort' , false , true , 1h , true ] ,
[ 'button' , {5554103,11009}.[5h.formatted.default] , 'comm_captain_orders_escort' , false , true , 5h , true ] ,
[ 'button' , {5554103,11009}.[24h.formatted.default] , 'comm_captain_orders_escort' , false , true , 24h , true ] ,
[ 'button' , {5554103,11009}.[100h.formatted.default] , 'comm_captain_orders_escort' , false , true , 100h , true ]
]"/>
          <open_conversation_menu menu="ut_genericui" param="$genericuiparam"/>
          <add_conversation_view view="closeupdetailmonitor"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_captain_orders_retreat'">
          <!-- ToDo: Write the related Order - i am currently just reserving the Slot here so i will not use it for something else -->
          <do_if value="event.param2.exists">
            <set_value name="md.UT_CAC_Dialogue.Comm_Common_Orders.$new_order" exact="[
table[$script='ut.cac.microorder',$displayname='\033RHN\033X Retreat',$order='wait exact',$time=10s,$interruptable=true] ,
table[$script='ut.cac.move.generic',$displayname='\033RReturn to %1'.[event.param2.knownname],$destination=event.param2,$endintargetspace=true,$interruptable=true] ,
table[$script='ut.cac.microorder',$displayname='\033RWait (2h)',$order='wait exact',$time=2h,$interruptable=true,$exitonneworder=true]
]"/>
          </do_if>
          <do_else>
            <set_value name="md.UT_CAC_Dialogue.Comm_Common_Orders.$new_order" exact="table[$script='ut.cac.microorder',$displayname='\033RHN\033X Retreat',$order='wait exact',$time=10s,$interruptable=true]"/>
        </do_else>
        <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        <debug_text filter="error" text="'%1 Retreat Function not implemented yet!!!'.[event.object]"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_captain_orders_patrol'">
          <do_if value="event.name == 'event_conversation_next_section'">
            <set_value name="$patroltime" exact="event.param2"/>
          </do_if>
          <open_conversation_menu menu="UTMapMenu" param="[0, 0, 'sector', event.object.container.sector, null, event.object.container.zone, 'selectspace', ['comm_captain_orders_patrol_selected']]"/>
          <add_conversation_view view="closeupdetailmonitor" />
        </do_elseif>
        <do_elseif value="event.param == 'comm_captain_orders_patrol_selected'">
          <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
            <add_npc_line speaker="event.object" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
          </do_if>
          <set_value name="md.UT_CAC_Dialogue.Comm_Common_Orders.$new_order" exact="table[$script='ut.cac.com.captain.patrol',$displayname='\033RPatrolling %1'.[event.param2.{3}.knownname],$space=event.param2.{3},$patroltime=$patroltime,$interruptable=true]"/>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_captain_orders_flyto_object'">
          <open_conversation_menu menu="UTMapMenu" param="[0, 0, 'sector', event.object.container.sector, null, event.object.container.zone, 'selectobject', ['comm_captain_orders_flyto_selected']]"/>
          <add_conversation_view view="closeupdetailmonitor" />
        </do_elseif>
        <do_elseif value="event.param == 'comm_captain_orders_flyto_space'">
          <open_conversation_menu menu="UTMapMenu" param="[0, 0, 'sector', event.object.container.sector, null, event.object.container.zone, 'selectspace', ['comm_captain_orders_flyto_selected']]"/>
          <add_conversation_view view="closeupdetailmonitor" />
        </do_elseif>
        <do_elseif value="event.param == 'comm_captain_orders_flyto'">
          <open_conversation_menu menu="UTMapMenu" param="[0, 0, 'sector', event.object.container.sector, null, event.object.container.zone, 'selectspaceorobject', ['comm_captain_orders_flyto_selected']]"/>
          <add_conversation_view view="closeupdetailmonitor" />
        </do_elseif>
        <do_elseif value="event.param == 'comm_captain_orders_flyto_selected'">
          <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
            <add_npc_line speaker="event.object" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
          </do_if>
          <set_value name="md.UT_CAC_Dialogue.Comm_Common_Orders.$new_order" exact="table[$script='ut.cac.move.generic',$displayname='\033RFly to %1'.[event.param2.{3}.knownname],$destination=event.param2.{3},$endintargetspace=true,$interruptable=true]"/>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_captain_orders_follow'">
          <!-- ToDo: Implement 'Selectship'-functionality in Map Menu (maybe even with some Filters..) -->
          <open_conversation_menu menu="UTMapMenu" param="[0, 0, 'sector', event.object.container.sector, null, event.object.container.zone, 'selectobject', ['comm_captain_orders_follow_selected']]"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_captain_orders_follow_selected'">
          <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
            <add_npc_line speaker="event.object" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
          </do_if>
          <set_value name="md.UT_CAC_Dialogue.Comm_Common_Orders.$new_order" exact="table[$script='ut.cac.move.follow.verysimple',$displayname='\033RFollow %1'.[if event.param2.{3}.controlentity.$shortname then event.param2.{3}.controlentity.$shortname else event.param2.{3}.knownname],$object=event.param2.{3},$interruptable=true]"/>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_captain_orders_escort'">
          <!-- ToDo: Implement 'Selectship'-functionality in Map Menu (maybe even with some Filters..) -->
          <open_conversation_menu menu="UTMapMenu" param="[0, 0, 'sector', event.object.container.sector, null, event.object.container.zone, 'selectobject', ['comm_captain_orders_follow_selected']]"/>
          <set_value name="$time" exact="event.param2"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_captain_orders_escort_selected'">
          <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
            <add_npc_line speaker="event.object" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
          </do_if>
          <set_value name="md.UT_CAC_Dialogue.Comm_Common_Orders.$new_order" exact="table[$script='ut.cac.move.escort',$displayname='\033REscort %1'.[if event.param2.{3}.controlentity.$shortname then event.param2.{3}.controlentity.$shortname else event.param2.{3}.knownname],$escortee=event.param2.{3},$interruptable=true]"/>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_captain_orders_signals'">
          <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
            <add_npc_line speaker="event.object" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
          </do_if>
          <add_player_choice text="{5554104,1321}" position="1" section="comm_captain_orders_send_signal_selected" choiceparam="[0LF,0LF,event.object.ship]" />
          <add_player_choice text="{5554104,1322}" position="2" section="comm_captain_orders_select_playerobject" choiceparam="'comm_captain_orders_send_signal_selected'" comment="Object Selection is in ut_cac_lib and passes the selected object to the choiceparam section"/>
          <add_player_choice text="{5554104,1323}" position="3" section="comm_captain_orders_send_signal_selected" choiceparam="[0LF,0LF,event.object.ship.commander]" />
          <add_player_choice text="{5554104,1324}" position="4" section="comm_captain_orders_wait_signal_selected" choiceparam="[0LF,0LF,event.object.ship]" />
          <add_player_choice text="{5554104,1325}" position="5" section="comm_captain_orders_select_playerobject" choiceparam="'comm_captain_orders_wait_signal_selected'" comment="Object Selection is in ut_cac_lib and passes the selected object to the choiceparam section"/>
          <add_player_choice text="{5554104,1326}" position="6" section="comm_captain_orders_wait_signal_selected" choiceparam="[0LF,0LF,event.object.ship.commander]" />
        </do_elseif>
        <do_elseif value="event.param == 'comm_captain_orders_send_signal_selected'">
          <set_value name="md.UT_CAC_Dialogue.Comm_Common_Orders.$new_order" exact="table[$script='ut.cac.microorder',$order='signalobject',$interruptable=true,$displayname='\033RSend Signal to %1'.[event.param2.{3}.knownname],$signalobject=event.param2.{3},$signalparam='0x62656570']"/>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        <do_elseif value="event.param == 'comm_captain_orders_wait_signal_selected'">
          <set_value name="md.UT_CAC_Dialogue.Comm_Common_Orders.$new_order" exact="table[$script='ut.cac.microorder',$order='wait signal',$interruptable=true,$displayname='\033RWait for Signal on %1'.[event.param2.{3}.knownname],$signalobject=event.param2.{3},$signalparam='0x62656570']"/>
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_elseif>
        
      </actions>
    </cue>
    
    
    <cue name="Main" instantiate="true" namespace="this" version="20">
      <conditions>
        <event_cue_signalled cue="this"/>
      </conditions>
      <cues>
        <cue name="Handover_040">
          <!-- The Instance Cue will not be used from 0.40 on anymore - handing over all Instances to the common dialogue Script -->
          <actions>
            <do_if value="$actor.ship.pilot == $actor">
              <set_value name="$actor.$ut_cac.$orders_section" exact="'comm_captain_orders'"/>
            </do_if>
            <do_else>
              <remove_value name="$actor.$ut_cac.$orders_section"/>
            </do_else>
            <debug_text filter="general" text="'%1 UT CAC Dialogue Handover to 040'.[$actor.name]" />
            <cancel_cue cue="Main"/>
          </actions>
        </cue>
      </cues>
    </cue>
  </cues>
</mdscript>
