<?xml version="1.0" encoding="UTF-8"?>
<aiscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="ut.cac.com.captain.patrol" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/aiscripts.xsd" version="1">
  <!--
  This Script is intended to let a Ship idle through changing Zonens and reacting to appearing Enemies
  -->
  <params>
    <param name="params" default="false" comment="pass a single Table filled with the wanted param Values here to make calls via list possible (always has priority)"/>
    <param name="space" default="this.zone" comment="the Space to patrol in - will select the nearest Zone within or a nearby on if already in context"/>
    <param name="zonetime" default="30min" comment="the Time Patrolling a certain Zone - will go to next Zone after that (Ignored for Zone Spaces)"/>
    <param name="patroltime" default="3h" comment="the time after which the Patrol ends and new Commands are requested"/><!-- wil be converted to Game Time internally -->
    <param name="patroltimeout" default="false" comment="the Gametime after which the Patrol ends and new Commands are requested - overrides patroltime"/>
    <param name="exitonneworder" default="false" comment="Exit immediately when receiving a new Order. If set to a Number of 2 or greater this is the Number of Orders the this.{$orderlist} has to contain before aborting (since 1 is always this Script)"/>
  </params>
  <init>
    <!-- first turn params param into the real params -->
    <do_if value="$params.$space?">
      <set_value name="$space" exact="$params.$space"/>
    </do_if>
    <do_if value="$params.$zonetime?">
      <set_value name="$zonetime" exact="$params.$zonetime"/>
    </do_if>
    <do_if value="$params.$patroltime?">
      <set_value name="$patroltime" exact="$params.$patroltime"/>
    </do_if>
    <do_if value="$params.$patroltimeout?">
      <set_value name="$patroltimeout" exact="$params.$patroltimeout"/>
    </do_if>
    <do_if value="$params.$exitonneworder?">
      <set_value name="$exitonneworder" exact="$params.$exitonneworder"/>
    </do_if>
  </init>
  <interrupts>
    <handler ref="ut_cac_exitonneworder"/>
  </interrupts>
  <attention min="unknown">
    <actions>
      <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Script started with Params:\n$space: %4 , $zonetime: %5 , $patroltime: %6 , $patroltimeout: %7 , $exitonneworder: %8 '.[player.age,this.name,this.container.name,$space.knownname, $zonetime, $patroltime, $patroltimeout,$exitonneworder]"/>
      
      
      <!-- Check/Sanitize Input -->
      <do_if value="$space.isclass.zone or $space.isclass.sector or $space.isclass.cluster or $space.isclass.galaxy" negate="true">
        <debug_text filter="error" text="'%1 %2 %3 Delivered $space %4 %5 is not a space!'.[player.age,this.name,this.container.name,$space.knownname,$space]"/>
        <return/>
      </do_if>
      
      <!-- Exit if we got new Orders -->
      <do_if value="if $exitonneworder gt 1 then this.$orderlist.{$exitonneworder}? else $exitonneworder and this.$orderlist.{2}? ">
        <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Received New Orders - Exiting (start Case)'.[player.age,this.name,this.container.name]"/>
        <resume label="finish"/>
      </do_if>
      
      <!-- Register in Suprior's "Available for other sudden Orders"-List -->
      <do_if value="this.ship.commanderentity.$ut_cac?">
        <add_to_group groupname="this.ship.commanderentity.$ut_cac.$availablefightships" object="this.ship"/>
      </do_if>
      <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Added us to Commanders Availableships List: %4 %5'.[player.age,this.name,this.container.name,this.ship.commanderentity.name,this.ship.commanderentity.$ut_cac.$availablefightships]"/>
      
      <!-- determine until when we should Patrol (real time may be a few minutes longer to complete current Movement) -->
      <do_if value="not $patroltimeout">
        <set_value name="$patroltimeout" exact="player.age + $patroltime"/>
        <set_value name="$params.$patroltimeout" exact="$patroltimeout" comment="that a possible replacement Leader completes the Job properly if assigned"/>
      </do_if>
      <!-- Patrolling only a single Zone - set Zone  timeout and Patrol Timepout to the same Game Time  -->
      <do_if value="$space.isclass.zone">
        <set_value name="$zonetimeout" exact="$patroltimeout"/>
        <set_value name="$zonetime" exact="$zonetimeout + 1min - player.age" comment="just to keep values internally consistent"/>
        <set_value name="$zones" exact="[$space]"/>
      </do_if>
      <do_else>
        <find_zone name="$zones" multiple="true" space="$space" >
          <match class="class.highway" negate="true"/>
          <match_any>
            <match tempzone="true">
              <match_content class="class.station" owner="this.faction"/>
            </match>
            <match tempzone="false"/>
          </match_any>
        </find_zone>
      </do_else>
      
      <label name="start"/>
      <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Patrol starts, Zones: %4'.[player.age,this.name,this.container.name,$zones]"/>
      
      <do_while value="player.age lt $patroltimeout">
        <!-- Select Patrol Zone - currently taken randomly from given Space, but may later include priority Spaces -->
        <set_value name="$zone" exact="$zones.random"/>
        <do_if value="this.zone != $zone">
          <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Flying to: %4'.[player.age,this.name,this.container.name,$zone.knownname]"/>
          <run_script name="'ut.cac.move.generic'">
            <param name="destination" value="$zone" comment="can be a space or an object in a zone. Providing Sector and Cluster will attempt to find the nearest zone"/>
            <param name="endintargetspace" value="true" comment="complete this script if we have the correct Space context, no matter where (may be Cluster, Sector or Zone, will resolve to Zone if an Object is the destination)"/>
            <param name="exitonneworder" value="$exitonneworder" comment="Exit immediately when receiving a new Order. If set to a Number of 2 or greater this is the Number of Orders the this.{$orderlist} has to contain before aborting (since 1 is always this Script)"/>
          </run_script>
        </do_if>
        
        <set_value name="$zonetimeout" exact="player.age + $zonetime"/>
        <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Patrolling: %4 until %5'.[player.age,this.name,this.container.name,$zone.knownname,$zonetimeout]"/>
        
        <do_while value="player.age lt $zonetimeout">
          
          <find_station name="$station" space="$zone"/>
          <do_if value="$station.exists">
            <create_random_position_outside_boundingbox name="$safepos" component="$station" mindistance="0" maxdistance="$station.size / 3 "/>
            <get_safe_pos result="$safepos" allowyaxis="true" radius="this.ship.size" zone="$zone" value="$safepos"/>
            <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Found Station %4 - flying to waypoint nearby (distance: %5 , size: %6)'.[player.age,this.name,this.container.name,$station.knownname,$station.distanceto.{$safepos},$station.size]"/>
          </do_if>
          <do_else>
            <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 No Station found - Patrolling Zone'.[player.age,this.name,this.container.name]"/>
            <create_random_position_in_boundingbox name="$safepos" component="$zone"/>
            <get_safe_pos result="$safepos" allowyaxis="true" radius="this.ship.size" zone="$zone" value="$safepos"/>
          </do_else>
          
          <!-- perform movement -->
          <run_script name="'ut.cac.move.to.pos'">
            <param name="destination" value="$zone" comment="Object to move relative to - will default to relative to Zone if not set"/>
            <param name="position" value="$safepos" comment="position is treated as an offset to destination. Default: safe position on [0,0,0] of destination"/>
          </run_script>
          
        </do_while>
        
      </do_while>
      
      <label name="finish"/>
      <!-- seperate Escort Groups since we just removed ourselves from it -->
      <remove_from_group group="this.$escortgroup" object="this.ship"/>
      <remove_value name="this.$escortgroup"/>
      <add_to_group groupname="this.$escortgroup" object="this.ship"/>
      <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Escortgroup changed (on_abort case):\nescortgroup: %4'.[player.age,this.name,this.container.name,this.$escortgroup]"/>
      <signal_objects object="this" param="'patrol ends'" param2="$params" param3="this.$escortgroup"/>
      <!-- Unregister from Suprior's "Available for other sudden Orders"-List -->
      <do_if value="this.ship.commanderentity.$ut_cac.$availablefightships?">
        <remove_from_group group="this.ship.commanderentity.$ut_cac.$availablefightships" object="this.ship"/>
      </do_if>
      <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Removed us from Commanders Availableships List: %4 %5'.[player.age,this.name,this.container.name,this.ship.commanderentity.name,this.ship.commanderentity.$ut_cac.$availablefightships]"/>
      
      <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Patrol ends'.[player.age,this.name,this.container.name]"/>
      
    </actions>
  </attention>
  <on_abort>
    <!-- seperate Escort Groups since we just removed ourselves from it -->
    <remove_from_group group="this.$escortgroup" object="this.ship"/>
    <remove_value name="this.$escortgroup"/>
    <add_to_group groupname="this.$escortgroup" object="this.ship"/>
    <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Escortgroup changed (on_abort case):\nescortgroup: %4'.[player.age,this.name,this.container.name,this.$escortgroup]"/>
    <signal_objects object="this" param="'patrol aborted'" param2="$params" param3="this.$escortgroup"/>
    <!-- Unregister from Suprior's "Available for other sudden Orders"-List -->
    <do_if value="this.ship.commanderentity.$ut_cac.$availablefightships?">
      <remove_from_group group="this.ship.commanderentity.$ut_cac.$availablefightships" object="this.ship"/>
    </do_if>
    <debug_text filter="general" chance="@this.$debug * 100" text="'%1 %2 %3 Removed us from Commanders Availableships List: %4 %5'.[player.age,this.name,this.container.name,this.ship.commanderentity.name,this.ship.commanderentity.$ut_cac.$availablefightships]"/>
  </on_abort>
  </aiscript>
