<?xml version="1.0" encoding="UTF-8" ?>
<mdscript name="UT_CAC_Architect" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://utnas/~unitrader/XRebirthxsds/md.xsd">

  <cues>
    <cue name="Orders" instantiate="true">
      <conditions>
        <check_any>
          <event_conversation_next_section sectionprefix="comm_architect_orders"/>
          <event_conversation_returned_to_section sectionprefix="comm_architect_orders"/>
        </check_any>
      </conditions>
      <actions>
        <debug_text filter="general" chance="@event.object.$debug * 100" text="'%1 %2 event.name= %3 \nevent.param= %4 event.param2= %5 event.param3= %6'.[event.object.name,event.object.container.name,event.name,event.param,event.param2,event.param3]"/>
        <do_if value="md.UT_CAC_Dialogue.Comm_Common_Orders.$new_order?" comment="we have an Order to be given - return to Order Menu and let the calling MD File handle the rest.">
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_if>
      <!-- Select new Order -->
      <do_elseif value="event.param == 'comm_architect_orders_main'">
        <do_if value="event.object.ship.buildmodule.exists and event.object.ship.pilot.$ut_cac?" comment="only available on builder ship and with ut cac Captain">
          <do_if value="event.object.$ut_cac.$construction? and event.object.$ut_cac.$construction.exists">
            <!-- directly present Upgrade Menu -->
<!-- Button Reminder: { 'button' , 'button text' [,'next_section' [ ,hotkey  [, selectable [,param [,keepvisible [,notsubsection]]]] ]] } -->
            <set_value name="$genericuiparam" exact=" [ 0 , 0 , 'Orders for %1'.[event.object.name], null, null , null , [ -1 , 200 , 200 , 200 , 200 , 200 ] ,  [] ,  [ 
[ 'button' , {5554103,8} , null , 'INPUT_STATE_DETAILMONITOR_B' , true ] , 
[ 'button' , 'unused' , 'comm_personal_' , 'INPUT_STATE_DETAILMONITOR_BACK' , false , null , true] , 
[ 'button' , 'unused' , 'comm_personal_' , 'INPUT_STATE_DETAILMONITOR_Y' , false , null , true ] , 
[ 'button' , 'unused' , 'comm_personal_' , 'INPUT_STATE_DETAILMONITOR_X' , false , null , true ] 
] ]"/>
            <append_to_list name="$genericuiparam.{8}" exact="[ [ 'header' , [ 6 ] ] , [ 'text' , {5554103,13001}.[event.object.$ut_cac.$construction.name] ] ]"/>
            <do_if value="not md.UT_CAC_Dialogue.Comm_Common_Orders.$insert_pos" comment="Sheduling Extensions is only Possible at the End of the Orderlist">
              <do_all exact="event.object.$ut_cac.$construction.completebuildplan.sequences.count" counter="$i" reverse="true">
                <set_value name="$sequence" exact="event.object.$ut_cac.$construction.completebuildplan.sequences.{$i}"/>
                <set_value name="$next_stage" exact="event.object.$ut_cac.$construction.currentbuildplan.{$sequence}.stage + 1"/>
                <do_all exact="event.object.$orderlist.count" counter="$j">
                  <do_if value="event.object.$orderlist.{$j}.$sequence? and event.object.$orderlist.{$j}.$sequence == $sequence">
                    <set_value name="$next_stage" operation="add"/>
                  </do_if>
                </do_all>
                <do_if value="$next_stage gt event.object.$ut_cac.$construction.completebuildplan.{$sequence}.stage" comment="complete build already planned">
                  <continue/>
                </do_if>
                <set_value name="$purposemacro" exact="event.object.$ut_cac.$construction.macro.buildpurposemacro.{buildplan.[$sequence,$next_stage]}"/>
                <set_value name="$colorcode" exact="
                if $purposemacro.isclass.production then '\033Y'
                else if $purposemacro.isclass.storage then '\033C'
                else if $purposemacro.isclass.cargobay then '\033C'
                else if $purposemacro.isclass.dronelaunchpad then '\033Y'
                else if $purposemacro.isclass.radar then '\033M'
                else if $purposemacro.isclass.destructible then '\033R'
                else '\033B'"/>
                <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 3 , 1 , 1 , 1 ] ] ,
[ 'text' , {5554103,13002}.[$colorcode,$purposemacro.name,$sequence,$next_stage] ] ,
[ 'button' , {5554103,13003} , 'comm_architect_orders_extend_selected' , false , true , [ $sequence , $next_stage , 0.0 ] , true ],
[ 'button' , {5554103,13004} , 'comm_architect_orders_extend_selected' , false , true , [ $sequence , $next_stage , 0.5 ] , true ],
[ 'button' , {5554103,13005} , 'comm_architect_orders_extend_selected' , false , true , [ $sequence , $next_stage , 1.0 ] , true ]
]"/>
              </do_all>
              <remove_value name="$purposemacro"/>
              <remove_value name="$colorcode"/>
              <remove_value name="$sequence"/>
              <remove_value name="$next_stage"/>
            </do_if>
            <do_else>
              <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 6 ] ] ,
[ 'text' , {5554103,13006} ]
]"/>
            </do_else>
            <append_to_list name="$genericuiparam.{8}" exact="[ [ 'header' , [ 6 ] ] , [ 'text' , {5554103,13007} ] ]"/>
            <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 4,1,1 ] ] ,
[ 'text' , {5554103,13008} ] ,
[ 'button' , {5554103,13004} , 'comm_architect_orders_upgrade_selected' , false , true , 0.5 , true ],
[ 'button' , {5554103,13005} , 'comm_architect_orders_upgrade_selected' , false , true , 1.0 , true ]
]"/>
            <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 6 ] ] ,
[ 'text' , ''+event.object.$ut_cac.$construction.currentbuildplan ]
]"/>
            <!-- find anything which can be repaired ( ToDo: maybe some Filtering?? )-->
            <!-- this Value will also be used in the Section called by this choice!!! -->
            <find_object_component name="$RepairableParts" object="event.object.$ut_cac.$construction" checkoperational="false" multiple="true">
              <match_any>
                <match restorable="true" comment="wrecked"/>
                <match repairable="true" invulnerable="false">
                  <match_hull min="99" negate="true" />
                </match>
              </match_any>
            </find_object_component>
            <do_if value="$RepairableParts.count">
              <append_to_list name="$genericuiparam.{8}" exact="[ [ 'header' , [ 3, 2 ] ] , [ 'text' , {5554103,13010} ] , [ 'text' , {5554103,13011}.[$RepairableParts.count] ] ]"/>
              <do_all exact="$RepairableParts.count" counter="$i">
                <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 5 , 1 ] ] ,
[ 'text' , {5554103,13012}.[$i,$RepairableParts.{$i}.knownname,$RepairableParts.{$i}.hullpercentage ] ] ,
null
]"/>
              </do_all>
            </do_if>
            <append_to_list name="$genericuiparam.{8}" exact="[ [ 'header' , [ 6 ] ] , [ 'text' , {5554103,13013} ] ]"/>
            <append_to_list name="$genericuiparam.{8}" exact="[ [ 'regular' , [ 5 , 1 ] ] ,
[ 'text' , {5554103,13014} ] ,
[ 'button' , {5554103,9} , 'comm_architect_orders_detach' , null , true , null , true  ]
]"/>
            <open_conversation_menu menu="ut_genericui" param="$genericuiparam"/>
            <add_conversation_view view="closeupdetailmonitor"/>
          </do_if>
          <do_else>
            <!-- Choose Space where to Build a Station or Station to Attach to - will auto-decide based on input -->
            <open_conversation_menu menu="UTMapMenu" param="[0, 0, 'cluster', event.object.container.cluster, null, event.object.container.sector, 'selectspaceorstation', ['comm_architect_orders_deploy_spaceorstationselected']]"/>
          </do_else>
        </do_if>
        <do_else>
          <!-- return directly on non-builder Ships -->
          <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
        </do_else>
      </do_elseif>
      <!-- Stuff related to Initial Deployment -->
      <do_elseif value="event.param == 'comm_architect_orders_deploy_spaceorstationselected'">
        <do_if value="event.param2.{3}.isclass.station">
          <do_if value="not event.param2.{3}.buildanchor.exists" comment="Check if there is already a CV attached">
            <set_value name="md.UT_CAC_Dialogue.Comm_Common_Orders.$new_order" exact="table[$script='ut.cac.com.architect.build',$displayname='\033RDeploy to %1'.[event.param2.{3}.knownname],$station=event.param2.{3},$interruptable=false,$moveable=false]"/>
            <!-- Set a few Values related to the currently built Station here -->
            <set_value name="event.object.$ut_cac.$construction" exact="event.param2.{3}"/>
            <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
          </do_if>
          <do_else>
            <!-- Station already has CV - Ignore Choice and return to Map Selection -->
            <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
          </do_else>
        </do_if>
        <do_else>
          <do_if value="event.param2.{3}.isclass.sector or event.param2.{3}.isclass.cluster">
            <do_all exact="10">
              <find_zone name="$zone" known="true" priorityzone="true" tempzone="false" space="event.param2.{3}" />
              <do_if value="$zone.freebuildlocations.count ge 1">
                <do_all exact="$zone.freebuildlocations.count" counter="$i">
                  <do_if value="not $zone.freebuildlocations.{$i}.child.exists">
                    <set_value name="$buildlocation" exact="$zone.freebuildlocations.{$i}"/>
                    <break/>
                  </do_if>
                </do_all>
                <do_if value="$buildlocation?">
                  <break/>
                </do_if>
              </do_if>
            </do_all>
          </do_if>
          <do_elseif value="event.param2.{3}.isclass.zone">
            <set_value name="$zone" exact="event.param2.{3}"/>
            <do_if value="$zone.freebuildlocations.count ge 1">
              <do_all exact="$zone.freebuildlocations.count" counter="$i">
                <do_if value="not $zone.freebuildlocations.{$i}.child.exists">
                  <set_value name="$buildlocation" exact="$zone.freebuildlocations.{$i}"/>
                  <break/>
                </do_if>
              </do_all>
            </do_if>
          </do_elseif>
          <do_if value="$buildlocation?">
            <debug_text filter="general"  chance="@event.object.$debug * 100" text="'start building via Dialogue'"/>
            <signal_cue_instantly cue="Performed_Build_Action" param="[$buildlocation,event.object]"/>
            <!--remove_value name="$buildlocation"/-->
          </do_if>
          <do_else>
            <!-- couldnt find a suitable Build Location - Tell Player  and go back -->
            <debug_text filter="general"  chance="@event.object.$debug * 100" text="'no fitting buildlocation'"/>
            <add_npc_line speaker="event.object" line="[1014,1015,1020,1019].random" hidechoices="false" comment="reject order" />
          </do_else>
        </do_else>
      </do_elseif>
      <!-- Stuff related to Station Extension -->
      <do_elseif value="event.param == 'comm_architect_orders_extend_selected'">
        <set_value name="md.UT_CAC_Dialogue.Comm_Common_Orders.$new_order" exact="table[$script='ut.cac.com.architect.build',$abortscript='ut.cac.orders.architect.cancelbuild',$displayname='\033RExtend: Build %1 ( %2%3 )'.[event.object.$ut_cac.$construction.macro.buildpurposemacro.{buildplan.[event.param2.{1},event.param2.{2}]}.name,event.param2.{1},event.param2.{2}],$sequence=event.param2.{1},$moveable=false,
$upgradeplan=['turret_small_mg',event.param2.{3},'turret_small_sg',event.param2.{3},'turret_medium_pe',event.param2.{3},'turret_medium_lb',event.param2.{3},'turret_medium_sp',event.param2.{3},'turret_missile_df',event.param2.{3},'turret_missile_sm',event.param2.{3},'shieldgenerator',event.param2.{3},'shieldgenerator_cap',event.param2.{3}]]"/>
        <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
      </do_elseif>
      <!-- Stuff related to Station Upgrades -->
      <do_elseif value="event.param == 'comm_architect_orders_upgrade_selected'">
        <set_value name="md.UT_CAC_Dialogue.Comm_Common_Orders.$new_order" exact="table[$script='ut.cac.com.architect.build',$displayname='\033RUpgrade %1'.[event.object.$ut_cac.$construction.name],$interruptable=true,
$upgradeplan=['turret_small_mg',event.param2,'turret_small_sg',event.param2,'turret_medium_pe',event.param2,'turret_medium_lb',event.param2,'turret_medium_sp',event.param2,'turret_missile_df',event.param2,'turret_missile_sm',event.param2,'shieldgenerator',event.param2,'shieldgenerator_cap',event.param2]
]"/>
      </do_elseif>
      <do_elseif value="event.param == 'comm_architect_orders_detach'">
        <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
          <add_npc_line speaker="event.object" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
        </do_if>
        <remove_value name="event.object.$ut_cac.$orders_section"/>
        <set_value name="md.UT_CAC_Dialogue.Comm_Common_Orders.$new_order" exact="table[$script='ut.cac.com.architectcaptain.undeploy.constructionvessel',$displayname='\033RDetach CV (Blocks further Orders)',$interruptable=false]"/>
        <open_conversation_menu menu="UTConversationControl" param="[0, 0, 'return']"/>
      </do_elseif>
      
      <!-- ################################################ -->
      <do_if value="true" comment="Disabled old stuff"/>
      <do_elseif value="false">
        <!-- VVVVVVV    Old Stuff   VVVVVVV  -->
        <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
          <add_npc_line speaker="event.object" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
        </do_if>
        <do_if value="event.object.ship.buildmodule.exists" comment="only available on builder ship">
          <do_if value="event.object.$construction? and event.object.$construction.exists">
            <add_player_choice text="'\033RExtend Station (UI)'" position="1" section="comm_architect_orders_extend_ui" selectable="event.object.$ut_cac.$orderedbuildplanlist" comment="same Key as the Orders Menu and first Order for quick Access (Sequence 1 - 1 - 1 )" />
            <add_player_choice text="'\033RExtend Station (Dialogue)'" position="4" section="comm_architect_orders_extend_dia" selectable="event.object.$ut_cac.$orderedbuildplanlist"/>
            <add_player_choice text="'\033RUpgrade Station'" position="2" section="comm_architect_orders_upgrade" selectable="false and event.object.$ut_cac.$orderedbuildplanlist" tooltip="'Work in Progress'" />
            <!-- find anything which can be repaired ( ToDo: maybe some Filtering?? )-->
            <!-- this Value will also be used in the Section called by this choice!!! -->
            <find_object_component name="$RepairableParts" object="event.object.$construction" checkoperational="false" multiple="true">
              <match_any>
                <match restorable="true" comment="wrecked"/>
                <match repairable="true" invulnerable="false">
                  <match_hull min="99" negate="true" />
                </match>
              </match_any>
            </find_object_component>
            <add_player_choice text="'\033RRepair Station'" position="3" section="comm_architect_orders_repair" tooltip="if $RepairableParts.count then '%1 Parts need repairs'.[$RepairableParts.count] else 'nothing to repair'" selectable="false and event.object.$ut_cac.$orderedbuildplanlist and $RepairableParts.count"/>
            <add_player_choice text="'\033RDetach from Station'" position="5" section="comm_architect_orders_detach" selectable="event.object.$construction.exists"/>
          </do_if>
          <do_else>
            <add_player_choice text="'\033RBuild Station'" position="1" section="comm_architect_orders_build" comment="same Key as the Orders Menu and first Order for quick Access (Sequence 1 - 1 - 1 )" />
            <add_player_choice text="'\033RAttach to Station'" position="2" section="comm_architect_orders_attach"/>
          </do_else>
        </do_if>
        <do_else>
          <add_player_choice text="'\033RNo Buildmodule'" tooltip="'This Ship cannot Build'" position="1" section="comm_architect_orders_build_spaceselected" choiceparam="event.object.zone" selectable="false" />
        </do_else>
        <add_player_choice_return text="{5554104,7}" position="6" />
        <add_player_choice_return text="{5554104,7}" position="close" />
      </do_elseif>
      <do_elseif value="event.param == 'comm_architect_orders_build'">
        <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
          <add_npc_line speaker="event.object" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
        </do_if>
        <!--- Add Build Choices here -->
        <!-- 1: Build in current Zone; 4: Build in Player Zone, 3: Select Zone -->
        <add_player_choice text="'\033RBuild Station in your current Zone'" position="1" section="comm_architect_orders_build_spaceselected" choiceparam="[0,0,event.object.zone]" />
        <add_player_choice text="'\033RBuild Station in my current Zone'" position="4" section="comm_architect_orders_build_spaceselected" choiceparam="[0,0,player.zone]" />
        <add_player_choice text="'\033RBuild Station in...'" position="3" section="comm_architect_orders_select_space" choiceparam="'comm_architect_orders_build_spaceselected'" comment="refering to re-useable Menu Call"/>
        <add_player_choice_return text="{5554104,7}" position="6" />
        <add_player_choice_return text="{5554104,7}" position="close" />
      </do_elseif>
      <do_elseif value="event.param == 'comm_architect_orders_attach'">
        
      </do_elseif>
      <do_elseif value="event.param == 'comm_architect_orders_build_spaceselected'">
        <do_if value="event.param2.{3}.isclass.sector or event.param2.{3}.isclass.cluster">
          <do_all exact="10">
            <find_zone name="$zone" known="true" priorityzone="true" tempzone="false" space="event.param2.{3}" />
            <do_if value="$zone.freebuildlocations.count ge 1">
              <do_all exact="$zone.freebuildlocations.count" counter="$i">
                <do_if value="not $zone.freebuildlocations.{$i}.child.exists">
                  <set_value name="$buildlocation" exact="$zone.freebuildlocations.{$i}"/>
                  <break/>
                </do_if>
              </do_all>
              <do_if value="$buildlocation?">
                <break/>
              </do_if>
            </do_if>
          </do_all>
        </do_if>
        <do_else>
          <set_value name="$zone" exact="event.param2.{3}"/>
          <do_if value="$zone.freebuildlocations.count ge 1">
            <do_all exact="$zone.freebuildlocations.count" counter="$i">
              <do_if value="not $zone.freebuildlocations.{$i}.child.exists">
                <set_value name="$buildlocation" exact="$zone.freebuildlocations.{$i}"/>
                <break/>
              </do_if>
            </do_all>
          </do_if>
        </do_else>
        <do_if value="$buildlocation?">
          <debug_text filter="general"  chance="@event.object.$debug * 100" text="'start building via Dialogue'"/>
          <signal_cue_instantly cue="Comm_Architect_Start_Build" param="$buildlocation"/>
          <!--remove_value name="$buildlocation"/-->
        </do_if>
        <do_else>
          <!-- couldnt find a suitable Build Location - Tell Player  and go back -->
          <debug_text filter="general"  chance="@event.object.$debug * 100" text="'no fitting buildlocation'"/>
          <add_npc_line speaker="event.object" line="[1014,1015,1020,1019].random" hidechoices="false" comment="reject order" />
        </do_else>
      </do_elseif>
      
      
      <do_elseif value="event.param == 'comm_architect_orders_extend_ui'">
        <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
          <do_if value="event.name == 'event_conversation_next_section'">
            <add_npc_line line="4170" comment="Is there anything else I can offer you?" view="closeupdetailmonitor" />
          </do_if>
          <do_else>
            <add_npc_line line="1124" comment="This is a list of all available modules for the station." view="closeupdetailmonitor" />
          </do_else>
        </do_if>
        <open_conversation_menu menu="UTBuildTreeMenu" param="[0, 0, event.object, event.object.ship, null , event.object.$construction]" param2="event.param3" />
      </do_elseif>
      <do_elseif value="event.param == 'comm_architect_orders_extend_dia'">
        <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
          <do_if value="event.name == 'event_conversation_next_section'">
            <add_npc_line line="4170" comment="Is there anything else I can offer you?" view="closeupdetailmonitor" />
          </do_if>
          <do_else>
            <add_npc_line line="1124" comment="This is a list of all available modules for the station." view="closeupdetailmonitor" />
          </do_else>
        </do_if>
        <set_value name="$slot" exact="1"/>
        <do_all exact="event.object.$ut_cac.$orderedbuildplanlist.count" counter="$i">
          <set_value name="$sequence" exact="event.object.$ut_cac.$orderedbuildplanlist.{$i}.{1}"/>
          <do_if value="event.object.$ut_cac.$orderedbuildplanlist.{$i}.{2} lt event.object.$construction.completebuildplan.{$sequence}.stage">
            <set_value name="$purposemacro" exact="event.object.$constructionmacro.buildpurposemacro.{buildplan.[$sequence,event.object.$ut_cac.$orderedbuildplanlist.{$i}.{2}+1]}"/>
            <set_value name="$colorcode" exact="
            if $purposemacro.isclass.production then '\033Y'
            else if $purposemacro.isclass.storage then '\033C'
            else if $purposemacro.isclass.cargobay then '\033C'
            else if $purposemacro.isclass.dronelaunchpad then '\033Y'
            else if $purposemacro.isclass.radar then '\033M'
            else if $purposemacro.isclass.destructible then '\033R'
            else '\033B'"/>
            <add_player_choice text="'\033R%1Extend: Build %2\033X'.[$colorcode,$purposemacro.name]" position="$slot" section="comm_architect_orders_extend_dia_selected" choiceparam="$sequence" />
            <do_if value="$slot ge 6">
              <break/>
            </do_if>
            <set_value name="$slot" operation="add"/>
          </do_if>
        </do_all>
        <add_player_choice_return text="{5554104,7}" position="6" />
        <add_player_choice_return text="{5554104,7}" position="close" />
      </do_elseif>
<!-- UI: UT Buildcost select call -->
      <do_elseif value="event.param == 'comm_architect_orders_extend_ui_selected'">
        <do_all exact="event.object.$ut_cac.$orderedbuildplanlist.count" counter="$i">
          <do_if value="event.object.$ut_cac.$orderedbuildplanlist.{$i}.{1} == event.param2.{1}">
            <set_value name="event.object.$ut_cac.$orderedbuildplanlist.{$i}.{2}" operation="add"/>
            <set_value name="$new_order" exact="table[$script='ut.cac.com.architect.build',$displayname='\033RExtend: Build %1'.[event.object.$constructionmacro.buildpurposemacro.{buildplan.[event.param2.{1},event.object.$ut_cac.$orderedbuildplanlist.{$i}.{2}]}.name],$sequence=event.param2.{1},$upgradeplan=[],$interruptable=false]"/>
          </do_if>
        </do_all>
      </do_elseif>
      <do_elseif value="event.param == 'comm_architect_orders_extend_dia_selected'">
        <do_all exact="event.object.$ut_cac.$orderedbuildplanlist.count" counter="$i">
          <do_if value="event.object.$ut_cac.$orderedbuildplanlist.{$i}.{1} == event.param2">
            <set_value name="event.object.$ut_cac.$orderedbuildplanlist.{$i}.{2}" operation="add"/>
            <set_value name="$new_order" exact="table[$script='ut.cac.com.architect.build',$displayname='\033RExtend: Build %1'.[event.object.$constructionmacro.buildpurposemacro.{buildplan.[event.param2,event.object.$ut_cac.$orderedbuildplanlist.{$i}.{2}]}.name],$sequence=event.param2,$upgradeplan=[],$interruptable=false]"/>
          </do_if>
        </do_all>
      </do_elseif>
      <do_elseif value="event.param == 'comm_architect_orders_upgrade'">
        <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
          <add_npc_line speaker="event.object" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
        </do_if>
        <!-- Add Upgrade Choices here -->
        <!-- $upgradeplan contains the current State of the Station or the preffered default Setting of the Player in the same format as the return Value: -->
        <!-- ( [ [ **Upgrade1 Indentifier String/Tag ** , ** Upgrade 1 amount ** ] , [ ** Upgrade 2 Indentifier String/Tag ** , ** Upgrade 2 amount ** ] , ..... ] ) -->
        <open_conversation_menu menu="UTUpgradeMenu" param="[0, 0, event.object, event.object.ship, event.object.$construction, $upgradeplan]" comment="DANGER! WILL PROBABLY CRASH UI SINCE NOT EXISTENT YET! "/>
      </do_elseif>
      <do_elseif value="event.param == 'comm_architect_orders_upgrade_selected'">
        <set_value name="$new_order" exact="table[$script='ut.cac.com.architect.build',$displayname='\033RUpgrade %1'.[event.object.$construction.name],$upgradeplan=event.param2,$interruptable=true]"/>
      </do_elseif>
      <do_elseif value="event.param == 'comm_architect_orders_repair'">
        <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
          <add_npc_line speaker="event.object" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
        </do_if>
        <!-- Create Choice Lists here  -->
        <set_value name="$TextList" exact="[]"/>
        <set_value name="$SelectList" exact="[]"/>
        <do_all exact="$RepairableParts.count" counter="$i">
          <do_if value="not $RepairableParts.{$i}.parent.iswreck">
            <append_to_list name="$TextList" exact="$RepairableParts.{$i}.name"/>
            <append_to_list name="$SelectList" exact="$RepairableParts.{$i}"/>
          </do_if>
        </do_all>
        <!-- This part is planned to be replaced by a Menu which can display all choices instead of using the Dialogue                                                                          vvvvvvvvvvvvvvvvvv the nulls here are button 2 and 3 with their respective next section -->
        <!-- open_conversation_menu menu="UTListMenu" param="[0, 0, 'Select Part', 'Select the Station Part which should be repaired.', 'Back', null , null , null , null , 'Select' , 'comm_architect_orders_repair_selected' , $TextList , $SelectList ]" /-->
        <set_value name="$slot" exact="1"/>
        <do_all exact="$TextList.count" counter="$i">
        <add_player_choice text="$TextList.{$i}" position="$slot" section="comm_architect_orders_repair_selected" choiceparam="$SelectList.{$i}"/>
          <set_value name="$slot" operation="add"/>
          <do_if value="$slot" exact="7">
            <break/>
          </do_if>
        </do_all>
        <remove_value name="$slot"/>
        <add_player_choice_return text="{5554104,7}" position="6" />
        <add_player_choice_return text="{5554104,7}" position="close" />
      </do_elseif>
      <do_elseif value="event.param == 'comm_architect_orders_repair_selected'">
        <set_value name="$new_order" exact="table[$script='ut.cac.com.architect.repair',$displayname='\033RRepair %1'.[event.param2.name],$component=event.param2,$interruptable=false]"/>
      </do_elseif>
      <do_elseif value="event.param == 'comm_architect_orders_detach'">
        <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
          <add_npc_line speaker="event.object" line="[1012,1013,1018,1019].random" hidechoices="false" comment="generic confirmation" />
        </do_if>
        <set_value name="$new_order" exact="table[$script='ut.cac.com.architectcaptain.undeploy.constructionvessel',$displayname='\033RDetach CV',$interruptable=true]"/>
      </do_elseif>
    </actions>
    </cue>
    
    <cue name="Performed_Build_Action" instantiate="true">
        <conditions>
        <check_any>
          <check_all>
            <event_player_performed_build_action/>
            <check_value value="event.object.architect.$ut_cac?"/>
          </check_all>
          <event_cue_signalled/><!-- param = $buildlocation - how to aquire Actor/Event Object? -->
          <check_all>
            <check_any>
              <event_conversation_started conversation="OnBuildAction"/>
              <event_conversation_returned_to_section section="OnBuildAction"/>
              <event_conversation_next_section sectionprefix="cArch_"/>
              <event_conversation_returned_to_section sectionprefix="cArch_"/>
            </check_any>
            <check_value value="event.object.$ut_cac?"/>
          </check_all>
        </check_any>
      </conditions>
      <actions>
        <debug_text filter="general" chance="@event.object.$debug * 100" text="'%1 %2 event.name= %3 \nevent.param= %4 event.param2= %5 event.param3= %6'.[event.object.name,event.object.container.name,event.name,event.param,event.param2,event.param3]"/>
        <do_if value="event.name == 'event_player_performed_build_action'">
          <set_value name="$buildlocation" exact="event.param" />
          <start_conversation actor="event.object" conversation="OnBuildAction" type="unqueued" />
          <set_value name="$zone" exact="$buildlocation.component"/>
          <set_value name="$CaptainMoveOrder" exact="table[$script='ut.cac.com.captain.move.to.buildlocation',$displayname='\033RMove to Building Position',$buildlocation=$buildlocation,$zone=$zone,$moveable=false]"/>
          <signal_objects object="event.object.ship.pilot" param="'new order'" param2="$CaptainMoveOrder"/>
        </do_if>
        <do_elseif value="event.name == 'event_cue_signalled'">
          <set_value name="$buildlocation" exact="event.param.{1}" />
          <set_value name="$zone" exact="$buildlocation.component"/>
          <set_value name="$CaptainMoveOrder" exact="table[$script='ut.cac.com.captain.move.to.buildlocation',$displayname='\033RMove to Building Position',$buildlocation=$buildlocation,$zone=$zone,$moveable=false]"/>
          <signal_objects object="event.param.{2}.ship.pilot" param="'new order'" param2="$CaptainMoveOrder"/>
          <open_conversation_menu menu="BuilderMacrosMenu" param="[0, 0, event.param.{2}, event.param.{2}.ship, 1]" param2="event.param3"/>
          <set_conversation_return_section section="cArch_BuildAbort"/>
        </do_elseif>
        
        <!-- Conversation: Select station to Build -->
        <!-- Maybe add a Skill and Architect Faction Filter -->
        <do_elseif value="event.param ==  'OnBuildAction'">
          <do_if value="event.object.$ut_cac.$pesterlevel gt param.ut_cac.pesterlevel.$mayspeak">
            <do_if value="event.name == 'event_conversation_started'">
              <add_npc_line line="1111" comment="Here is a list of stations we can build." view="closeupdetailmonitor" />
            </do_if>
            <do_else>
              <add_npc_line line="4170" comment="Is there anything else I can offer you?" view="closeupdetailmonitor" />
            </do_else>
          </do_if>
          <open_conversation_menu menu="BuilderMacrosMenu" param="[0, 0, event.object, event.object.ship, 1]" param2="event.param3"/>
          <set_conversation_return_section section="cArch_BuildAbort"/>
        </do_elseif>
        
        <do_elseif value="event.param == 'cArch_selectUpgradesMenu'">
          <add_conversation_view view="closeupdetailmonitor" />
          <do_if value="not $showed_cArch_selectUpgradesMenu?">
            <set_value name="$showed_cArch_selectUpgradesMenu" />
            <add_npc_line line="1122" comment="Please adjust the upgrade levels and then confirm the order." />
          </do_if>
          <!-- param2: [ 0 , 0 , actor , ship , null/object , station macro , sequence , stage , 1(build limit in demo) ]-->
          <!-- param3: [ [ Upgrade 1 Tag , ratio ] , [ Upgrade 2 Tag , ratio ] ...] (optional) -->
          <open_conversation_menu menu="SelectUpgradesMenu" param="event.param2" param2="event.param3" />
        </do_elseif>
        
        <do_elseif value="event.param == 'cArch_buildcost'">
          <add_conversation_view view="closeupdetailmonitor" />
          <!-- param2: [ 0 , 0 , actor , ship , null/object , station macro , sequence , stage , [ [ Upgrade 1 Tag , ratio ] , [ Upgrade 2 Tag , ratio ] ...] , 1(build limit in demo) , null(targethullfraction) , 0(upgradesonly) { , droneplan , ammoplan } ]-->
          <!-- param3: ???? -->
          <open_conversation_menu menu="BuildCostMenu" param="event.param2" param2="event.param3" />
        </do_elseif>
        
        <do_elseif value="event.param == 'cArch_buildermacrosResult'">
          <!-- Result from build cost menu -->
          <!-- param2 == { selected macro name, buildplanlist, upgradeplanlist } -->
          <set_trade_restrictions object="event.object.container" restricted="true" />
          <set_value name="$stationmacro" exact="macro.{event.param2.{1}}"/>
          <signal_objects object="event.object" param="'new order'" param2="table[$script='ut.cac.com.architect.build',$displayname='\033RBuild Station (moveto)',$buildlocation=$buildlocation,$zone=$zone,$macro=$stationmacro,$upgradeplanlist=event.param2.{3},$interruptable=false,$moveable=false]"/>
          <!-- create buildplan var from temp station of planned type.. $TempCluster and everything within will be cleared once the first stage is complete-->
          <do_if value="not md.$ut_cac_tempcluster?">
            <create_presentation_cluster name="md.$ut_cac_tempcluster"/>
            <set_presentation_cluster_persistence cluster="md.$ut_cac_tempcluster" persistent="true"/>
          </do_if>
          <find_zone name="$TempZone" space="md.$ut_cac_tempcluster" />
          <create_station name="event.object.$ut_cac.$construction" macro="$stationmacro" owner="faction.player" zone="$TempZone" comment="temporary completed Station to get values from (not possible from construction) - will be swapped on completion"/>
          <!--create_ai_unit object="event.object.$ut_cac.$construction"/-->
          <remove_trade_subscription object="event.object.$ut_cac.$construction"/>
          <set_known object="event.object.$ut_cac.$construction" known="false"/>
          <set_cover_owner object="event.object.$ut_cac.$construction" faction="faction.neutral"/>
          <set_value name="event.object.$ut_cac.$orderedbuildplanlist" exact="[]"/>
          <do_all exact="event.object.$ut_cac.$construction.completebuildplan.sequences.count" counter="$i">
            <append_to_list name="event.object.$ut_cac.$orderedbuildplanlist" exact="[ event.object.$ut_cac.$construction.completebuildplan.sequences.{$i} , 0 ]"/>
          </do_all>
          <remove_value name="$CaptainMoveOrder"/>
        </do_elseif>
        
        <!-- Station Upgrade via UI - probably not needed anymore.. -->
        <do_elseif value="event.param == 'cArch_buildtreeResult'">
          <!-- Selection made in build tree menu -->
          <!-- param2 == [ buildplanlist, upgradeplanlist ] -->
          <add_npc_line line="1109" comment="we will start construction" view="facenormal" />
          <signal_objects object="event.object" param="'new order'" param2="table[$script='ut.cac.com.architect.build',$displayname='\033RExtend Station',$station=event.object.ship.buildmodule.buildanchor,$buildplanlist=event.param2.{1},$upgradeplanlist=event.param2.{2},$interruptable=false]"/>
          <do_if value="event.object.$orderlist.count ge 1 and event.object.$orderlist.{event.object.$orderlist.count}.$script=='ut.cac.com.architect.build'">
            <set_value name="event.object.$orderlist.{event.object.$orderlist.count}.$interruptable" exact="false"/>
          </do_if>
        </do_elseif>
        <do_elseif value="event.param == 'cArch_BuildAbort'">
          <!-- Selection made in build tree menu -->
          <!-- param2 == [ buildplanlist, upgradeplanlist ] -->
          <add_npc_line line="1109" comment="we will start construction" view="facenormal" />
          <signal_objects object="event.object" param="'cancel order'" param2="$CaptainMoveOrder"/>
          <remove_value name="$CaptainMoveOrder"/>
        </do_elseif>
      </actions>
    </cue>
    
    <cue name="Main" instantiate="true" namespace="this" version="20">
      <conditions>
        <event_cue_signalled cue="this"/>
      </conditions>
      <cues>
        <cue name="Handover_040">
          <!-- The Instance Cue will not be used from 0.40 on anymore - handing over all Instances to the common dialogue Script -->
          <actions>
            <do_if value="$actor.ship.architect == $actor">
              <set_value name="$actor.$ut_cac.$orders_section" exact="'comm_architect_orders_main'"/>
            </do_if>
            <do_else>
              <remove_value name="$actor.$ut_cac.$orders_section"/>
            </do_else>
            <debug_text filter="general" text="'%1 UT CAC Dialogue Handover to 040'.[$actor.name]" />
            <cancel_cue cue="Main"/>
          </actions>
        </cue>
      </cues>
    </cue>
  </cues>
</mdscript>
